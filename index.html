<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Versets Coran Avancé</title>
<style>
  body { font-family: Arial, sans-serif; margin: 5px; max-width: 100%; padding: 0 5px; font-size: 14px; }
  h1 { font-size: 1.2em; text-align: center; margin-bottom: 6px; }
  label, select, input { font-size: 0.9em; margin: 0 4px 6px 0; }
  input[type=number] { width: 50px; }
  .range-wrap { display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: wrap; margin-bottom: 12px; }
  .rtl-range { direction: rtl; }
  .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 12px; }
  button { padding: 8px 14px; font-size: 1em; border-radius: 6px; border: none; background-color: #4caf50; color: white; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.15); cursor: pointer; transition: background-color 0.3s, box-shadow 0.3s; }
  button:hover { background-color: #43a047; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
  button:active { background-color: #388e3c; }
  label, select, input[type=number] { font-size: 1em; padding: 6px 8px; border-radius: 5px; border: 1px solid #aaa; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s; }
  input[type=number]:focus, select:focus { border-color: #3a8d3a; box-shadow: 0 0 6px #4caf5080; outline: none; }
  /* Corrige chevauchement filtre Sourate en arabe */
  .range-wrap.rtl-range {
    gap: 12px !important;
    justify-content: flex-start !important;
    flex-wrap: wrap !important;
  }
  .range-wrap.rtl-range label,
  .range-wrap.rtl-range select,
  .range-wrap.rtl-range input[type=number] {
    min-width: 100px !important;
    box-sizing: border-box;
  }
  /* Réduction de l'espace entre la grille et les compteurs */
  .table-wrap {
    margin-bottom: 6px !important;
  }
  /* Compteurs alignés juste sous la grille */
  #counters {
    margin-top: 6px !important;
    margin-bottom: 6px;
    display: flex; /* conserve flex pour alignement */
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
    font-size: 1em;
    font-weight: 600;
  }
  .counter-box {
    padding: 8px 14px; border-radius: 5px; color: white; flex: 1 1 130px; text-align: center;
  }
  .correct-box { background-color: #0b3d0b; }
  .incorrect-box { background-color: #8b1c1c; }
  .remaining-box { background-color: #505050; }
  /* Bloc versets positionné strictement entre compteurs et boutons réponse */
  #ayat-box {
    position: fixed;
    left: 10px;
    right: 10px;
    top:  calc(5.8em + 126px); /* hauteur approximative des compteurs + marges */
    /* 
      5.8em ≈ hauteur + marges des compteurs + timer, 
      126px à ajuster en fonction hauteur cumulée de compteurs + timer, 
      vous pouvez ajuster en testant.
    */
    bottom: 60px; /* hauteur des boutons de réponse + padding */
    overflow-y: auto;
    margin-top: 6px;
    border-radius: 8px;
    padding: 10px 12px 12px 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    background: #f5f5f5;
    font-size: 1.2em;
    line-height: 1.4em;
    direction: rtl;
    text-align: right;
    z-index: 1000;
    display: none;
    transition: all 0.3s ease;
  }
  /* Réduction hauteur boutons Bonne/Mauvaise réponse pour plus d’espace */
  #response-buttons {
    position: fixed; bottom: 10px; left: 10px; right: 10px;
    display: flex; justify-content: center; gap: 16px;
    background: #f5f5f5;
    border-radius: 8px;
    padding: 6px 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    z-index: 1100;
  }
  #response-buttons button {
    flex: 1;
    font-size: 1em;
    padding: 6px 0;
    line-height: 1.3em;
    font-weight: bold;
    border-radius: 6px;
    border: 3px solid transparent;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  #btnCorrect {
    background-color: #e6f6e6;
    border-color: #0b3d0b;
    color: #0b3d0b;
  }
  #btnCorrect:hover {
    background-color: #d0ead0;
  }
  #btnIncorrect {
    background-color: #f6e6e6;
    border-color: #8b1c1c;
    color: #8b1c1c;
  }
  #btnIncorrect:hover {
    background-color: #e9cfcf;
  }
  /* Styles restants */
  .table-wrap { display: flex; flex-wrap: wrap; gap: 6px; max-height: 160px; overflow-y: auto; border: 1px solid #ccc; padding: 4px; background: #fafafa; user-select: none; }
  .num { border-radius: 5px; padding: 6px 10px; background: #d2f0d2; border: 1px solid #84b784; cursor: pointer; transition: background-color 0.3s; min-width: 36px; text-align: center; font-size: 0.95em; }
  .num.traited.correct { background-color: #0b3d0b; color: #d8f5d8; cursor: default; border-color: #064206; text-decoration: line-through; }
  .num.traited.incorrect { background-color: #8b1c1c; color: #f5d8d8; cursor: default; border-color: #5e1212; text-decoration: line-through; }
  #verse-header { font-weight: 600; font-size: 1.1em; margin-bottom: 6px; }
  #verse-text { max-height: 15em; overflow-y: auto; font-size: 1.2em; line-height: 1.4em; margin-bottom: 8px; }
  @media (max-width: 400px) {
    body { font-size: 13px; }
    #ayat-box { max-height: 24em; font-size: 1.3em; padding: 12px 14px 80px 14px; overflow-y: visible; top: 140px; bottom: 70px; }
    #verse-text { max-height: 17em; font-size: 1.3em; }
    #response-buttons button { padding: 6px 0; font-size: 1.1em; }
    .table-wrap { max-height: 140px; margin-bottom: 140px; }
    .num { padding: 6px 10px; min-width: 34px; font-size: 1em; }
    #counters { font-size: 1.1em; }
  }
</style>
</head>
<body>
<h1 id="app-title">اختبار آيات القرآن المتقدم</h1>
<label for="language" id="label-language">اللغة :</label>
<select id="language">
  <option value="ar">العربية</option>
  <option value="fr">Français</option>
  <option value="en">English</option>
  <option value="es">Español</option>
</select>
<label for="sourah" id="label-sourah">السورة :</label>
<select id="sourah"></select>
<div id="range-wrap" class="range-wrap">
  <label for="start" id="label-start">بداية :</label>
  <input type="number" id="start" min="1" />
  <label for="end" id="label-end">نهاية :</label>
  <input type="number" id="end" min="1" />
</div>
<div class="controls">
  <button id="btnRedistribuer">إعادة التوزيع</button>
  <button id="btnTrier">ترتيب</button>
  <button id="btnToggleTraites">إظهار / إخفاء المعالَجَة</button>
</div>
<div class="table-wrap" id="ayah-numbers"></div>
<div id="counters">
  <div class="counter-box correct-box"><span id="label-correctCount">الإجابات الصحيحة :</span> <span id="correct-count">0</span></div>
  <div class="counter-box incorrect-box"><span id="label-errorCount">الأخطاء :</span> <span id="error-count">0</span></div>
  <div class="counter-box remaining-box"><span id="label-remainingCount">المتبقية :</span> <span id="remaining-count">0</span> / <span id="total-count">0</span></div>
</div>
<div class="counter-box remaining-box" id="end-time-box" style="display:none; margin-top: 8px; font-weight: bold; text-align:center; color:#fff; background: #222; border-radius:5px; padding:6px 12px;">
  Fin : <span id="end-time-display">--:--:--</span>
</div>
<div id="ayat-box" style="display:none;">
  <div id="verse-header"></div>
  <div id="verse-text"></div>
  <div id="response-buttons">
    <button id="btnCorrect"><span class="icon-check"></span> Bonne réponse</button>
    <button id="btnIncorrect"><span class="icon-cross"></span> Mauvaise réponse</button>
  </div>
</div>
<script>
(() => {
const texts = {
  fr: {
    title: "Quiz Versets du Coran Avancé",
    languageLabel: "Langue :",
    sourateLabel: "Sourate :",
    startLabel: "Début :",
    endLabel: "Fin :",
    redistribuerBtn: "Redistribuer",
    trierBtn: "Trier",
    toggleTraitesBtn: "Afficher / Cacher Traités",
    correctBtn: "Bonne réponse",
    incorrectBtn: "Mauvaise réponse",
    correctCountLabel: "Réponses justes :",
    errorCountLabel: "Erreurs :",
    remainingCountLabel: "Restantes :",
    surahText: "Sourate N° : ",
    ayahText: "Verset N° : "
  },
  ar: {
    title: "اختبار آيات القرآن المتقدم",
    languageLabel: "اللغة :",
    sourateLabel: "السورة :",
    startLabel: "بداية :",
    endLabel: "نهاية :",
    redistribuerBtn: "إعادة التوزيع",
    trierBtn: "ترتيب",
    toggleTraitesBtn: "إظهار / إخفاء المعالَجَة",
    correctBtn: "إجابة صحيحة",
    incorrectBtn: "إجابة خاطئة",
    correctCountLabel: "الإجابات الصحيحة :",
    errorCountLabel: "الأخطاء :",
    remainingCountLabel: "المتبقية :",
    surahText: "السورة عدد: ",
    ayahText: "الآية عدد: "
  },
  en: {
    title: "Advanced Quran Verses Quiz",
    languageLabel: "Language:",
    sourateLabel: "Surah:",
    startLabel: "Start:",
    endLabel: "End:",
    redistribuerBtn: "Shuffle",
    trierBtn: "Sort",
    toggleTraitesBtn: "Show / Hide Treated",
    correctBtn: "Correct Answer",
    incorrectBtn: "Wrong Answer",
    correctCountLabel: "Correct Answers:",
    errorCountLabel: "Errors:",
    remainingCountLabel: "Remaining:",
    surahText: "Surah No.: ",
    ayahText: "Ayah No.: "
  },
  es: {
    title: "Cuestionario Avanzado de Versos del Corán",
    languageLabel: "Idioma:",
    sourateLabel: "Sura:",
    startLabel: "Inicio:",
    endLabel: "Fin:",
    redistribuerBtn: "Reordenar",
    trierBtn: "Ordenar",
    toggleTraitesBtn: "Mostrar / Ocultar Tratados",
    correctBtn: "Respuesta correcta",
    incorrectBtn: "Respuesta incorrecta",
    correctCountLabel: "Respuestas correctas:",
    errorCountLabel: "Errores:",
    remainingCountLabel: "Restantes:",
    surahText: "Sura N°: ",
    ayahText: "Verso N°: "
  }
};
const SURAHS = [
  {number:1, name_ar:"الفاتحة", name_fr:"Al-Fatiha", count:7},
  {number:2, name_ar:"البقرة", name_fr:"Al-Baqara", count:286},
  {number:3, name_ar:"آل عمران", name_fr:"Al-i-Imran", count:200},
  {number:4, name_ar:"النساء", name_fr:"An-Nisa", count:176},
  {number:5, name_ar:"المائدة", name_fr:"Al-Ma'ida", count:120},
  {number:6, name_ar:"الأنعام", name_fr:"Al-An'am", count:165},
  {number:7, name_ar:"الأعراف", name_fr:"Al-A'raf", count:206},
  {number:8, name_ar:"الأنفال", name_fr:"Al-Anfal", count:75},
  {number:9, name_ar:"التوبة", name_fr:"At-Tawba", count:129},
  {number:10, name_ar:"يونس", name_fr:"Yunus", count:109},
  {number:11, name_ar:"هود", name_fr:"Hud", count:123},
  {number:12, name_ar:"يوسف", name_fr:"Yusuf", count:111},
  {number:13, name_ar:"الرعد", name_fr:"Ar-Ra'd", count:43},
  {number:14, name_ar:"إبراهيم", name_fr:"Ibrahim", count:52},
  {number:15, name_ar:"الحجر", name_fr:"Al-Hijr", count:99},
  {number:16, name_ar:"النحل", name_fr:"An-Nahl", count:128},
  {number:17, name_ar:"الإسراء", name_fr:"Al-Isra", count:111},
  {number:18, name_ar:"الكهف", name_fr:"Al-Kahf", count:110},
  {number:19, name_ar:"مريم", name_fr:"Maryam", count:98},
  {number:20, name_ar:"طه", name_fr:"Ta-Ha", count:135},
  {number:21, name_ar:"الأنبياء", name_fr:"Al-Anbiya", count:112},
  {number:22, name_ar:"الحج", name_fr:"Al-Hajj", count:78},
  {number:23, name_ar:"المؤمنون", name_fr:"Al-Mu'minun", count:118},
  {number:24, name_ar:"النور", name_fr:"An-Nur", count:64},
  {number:25, name_ar:"الفرقان", name_fr:"Al-Furqan", count:77},
  {number:26, name_ar:"الشعراء", name_fr:"Ash-Shu'ara", count:227},
  {number:27, name_ar:"النمل", name_fr:"An-Naml", count:93},
  {number:28, name_ar:"القصص", name_fr:"Al-Qasas", count:88},
  {number:29, name_ar:"العنكبوت", name_fr:"Al-Ankabut", count:69},
  {number:30, name_ar:"الروم", name_fr:"Ar-Rum", count:60},
  {number:31, name_ar:"لقمان", name_fr:"Luqman", count:34},
  {number:32, name_ar:"السجدة", name_fr:"As-Sajda", count:30},
  {number:33, name_ar:"الأحزاب", name_fr:"Al-Ahzab", count:73},
  {number:34, name_ar:"سبأ", name_fr:"Saba", count:54},
  {number:35, name_ar:"فاطر", name_fr:"Fatir", count:45},
  {number:36, name_ar:"يس", name_fr:"Ya-Sin", count:83},
  {number:37, name_ar:"الصافات", name_fr:"As-Saffat", count:182},
  {number:38, name_ar:"ص", name_fr:"Sad", count:88},
  {number:39, name_ar:"الزمر", name_fr:"Az-Zumar", count:75},
  {number:40, name_ar:"غافر", name_fr:"Ghafir", count:85},
  {number:41, name_ar:"فصلت", name_fr:"Fussilat", count:54},
  {number:42, name_ar:"الشورى", name_fr:"Ash-Shura", count:53},
  {number:43, name_ar:"الزخرف", name_fr:"Az-Zukhruf", count:89},
  {number:44, name_ar:"الدخان", name_fr:"Ad-Dukhan", count:59},
  {number:45, name_ar:"الجاثية", name_fr:"Al-Jathiya", count:37},
  {number:46, name_ar:"الأحقاف", name_fr:"Al-Ahqaf", count:35},
  {number:47, name_ar:"محمد", name_fr:"Muhammad", count:38},
  {number:48, name_ar:"الفتح", name_fr:"Al-Fath", count:29},
  {number:49, name_ar:"الحجرات", name_fr:"Al-Hujurat", count:18},
  {number:50, name_ar:"ق", name_fr:"Qaf", count:45},
  {number:51, name_ar:"الذاريات", name_fr:"Adh-Dhariyat", count:60},
  {number:52, name_ar:"الطور", name_fr:"At-Tur", count:49},
  {number:53, name_ar:"النجم", name_fr:"An-Najm", count:62},
  {number:54, name_ar:"القمر", name_fr:"Al-Qamar", count:55},
  {number:55, name_ar:"الرحمن", name_fr:"Ar-Rahman", count:78},
  {number:56, name_ar:"الواقعة", name_fr:"Al-Waqia", count:96},
  {number:57, name_ar:"الحديد", name_fr:"Al-Hadid", count:29},
  {number:58, name_ar:"المجادلة", name_fr:"Al-Mujadila", count:22},
  {number:59, name_ar:"الحشر", name_fr:"Al-Hashr", count:24},
  {number:60, name_ar:"الممتحنة", name_fr:"Al-Mumtahina", count:13},
  {number:61, name_ar:"الصف", name_fr:"As-Saff", count:14},
  {number:62, name_ar:"الجمعة", name_fr:"Al-Jumu'a", count:11},
  {number:63, name_ar:"المنافقون", name_fr:"Al-Munafiqoon", count:11},
  {number:64, name_ar:"التغابن", name_fr:"At-Taghabun", count:18},
  {number:65, name_ar:"الطلاق", name_fr:"At-Talaq", count:12},
  {number:66, name_ar:"التحريم", name_fr:"At-Tahrim", count:12},
  {number:67, name_ar:"الملك", name_fr:"Al-Mulk", count:30},
  {number:68, name_ar:"القلم", name_fr:"Al-Qalam", count:52},
  {number:69, name_ar:"الحاقة", name_fr:"Al-Haqqah", count:52},
  {number:70, name_ar:"المعارج", name_fr:"Al-Ma'arij", count:44},
  {number:71, name_ar:"نوح", name_fr:"Nuh", count:28},
  {number:72, name_ar:"الجن", name_fr:"Al-Jinn", count:28},
  {number:73, name_ar:"المزّمّل", name_fr:"Al-Muzzammil", count:20},
  {number:74, name_ar:"المدّثر", name_fr:"Al-Muddaththir", count:56},
  {number:75, name_ar:"القيامة", name_fr:"Al-Qiyama", count:40},
  {number:76, name_ar:"الإنسان", name_fr:"Al-Insan", count:31},
  {number:77, name_ar:"المرسلات", name_fr:"Al-Mursalat", count:50},
  {number:78, name_ar:"النبأ", name_fr:"An-Naba", count:40},
  {number:79, name_ar:"النازعات", name_fr:"An-Nazi'at", count:46},
  {number:80, name_ar:"عبس", name_fr:"Abasa", count:42},
  {number:81, name_ar:"التكوير", name_fr:"At-Takwir", count:29},
  {number:82, name_ar:"الإنفطار", name_fr:"Al-Infitar", count:19},
  {number:83, name_ar:"المطفّفين", name_fr:"Al-Mutaffifin", count:36},
  {number:84, name_ar:"الإنشقاق", name_fr:"Al-Inshiqaq", count:25},
  {number:85, name_ar:"البروج", name_fr:"Al-Buruj", count:22},
  {number:86, name_ar:"الطارق", name_fr:"At-Tariq", count:17},
  {number:87, name_ar:"الأعلى", name_fr:"Al-A'la", count:19},
  {number:88, name_ar:"الغاشية", name_fr:"Al-Ghashiya", count:26},
  {number:89, name_ar:"الفجر", name_fr:"Al-Fajr", count:30},
  {number:90, name_ar:"البلد", name_fr:"Al-Balad", count:20},
  {number:91, name_ar:"الشمس", name_fr:"Ash-Shams", count:15},
  {number:92, name_ar:"الليل", name_fr:"Al-Lail", count:21},
  {number:93, name_ar:"الضحى", name_fr:"Ad-Dhuha", count:11},
  {number:94, name_ar:"الإنشراح", name_fr:"Al-Inshirah", count:8},
  {number:95, name_ar:"التين", name_fr:"At-Tin", count:8},
  {number:96, name_ar:"العلق", name_fr:"Al-Alaq", count:19},
  {number:97, name_ar:"القدر", name_fr:"Al-Qadr", count:5},
  {number:98, name_ar:"البينة", name_fr:"Al-Bayyina", count:8},
  {number:99, name_ar:"الزلزلة", name_fr:"Az-Zalzala", count:8},
  {number:100, name_ar:"العاديات", name_fr:"Al-Adiyat", count:11},
  {number:101, name_ar:"القارعة", name_fr:"Al-Qaria", count:11},
  {number:102, name_ar:"التكاثر", name_fr:"At-Takathur", count:8},
  {number:103, name_ar:"العصر", name_fr:"Al-Asr", count:3},
  {number:104, name_ar:"الهمزة", name_fr:"Al-Humaza", count:9},
  {number:105, name_ar:"الفيل", name_fr:"Al-Fil", count:5},
  {number:106, name_ar:"قريش", name_fr:"Quraysh", count:4},
  {number:107, name_ar:"الماعون", name_fr:"Al-Maun", count:7},
  {number:108, name_ar:"الكوثر", name_fr:"Al-Kawthar", count:3},
  {number:109, name_ar:"الكافرون", name_fr:"Al-Kafirun", count:6},
  {number:110, name_ar:"النصر", name_fr:"An-Nasr", count:3},
  {number:111, name_ar:"المسد", name_fr:"Al-Masad", count:5},
  {number:112, name_ar:"الإخلاص", name_fr:"Al-Ikhlas", count:4},
  {number:113, name_ar:"الفلق", name_fr:"Al-Falaq", count:5},
  {number:114, name_ar:"الناس", name_fr:"An-Nas", count:6}
];
const STORAGE_KEY = "quranQuizProgress";
const languageEl = document.getElementById("language");
const sourahEl = document.getElementById("sourah");
const startEl = document.getElementById("start");
const endEl = document.getElementById("end");
const ayahContainer = document.getElementById("ayah-numbers");
const ayatBox = document.getElementById("ayat-box");
const verseTextEl = document.getElementById("verse-text");
const verseHeaderEl = document.getElementById("verse-header");
const correctEl = document.getElementById("correct-count");
const errorEl = document.getElementById("error-count");
const remainingEl = document.getElementById("remaining-count");
const totalEl = document.getElementById("total-count");
const btnRedistribuer = document.getElementById("btnRedistribuer");
const btnTrier = document.getElementById("btnTrier");
const btnToggleTraites = document.getElementById("btnToggleTraites");
const btnCorrect = document.getElementById("btnCorrect");
const btnIncorrect = document.getElementById("btnIncorrect");
const labelTitle = document.getElementById("app-title");
const labelLanguage = document.getElementById("label-language");
const labelSourate = document.getElementById("label-sourah");
const labelStart = document.getElementById("label-start");
const labelEnd = document.getElementById("label-end");
const labelCorrectCount = document.getElementById("label-correctCount");
const labelErrorCount = document.getElementById("label-errorCount");
const labelRemainingCount = document.getElementById("label-remainingCount");
const rangeWrap = document.getElementById("range-wrap");
const endTimeBox = document.getElementById("end-time-box");
const endDisplay = document.getElementById("end-time-display");
let ayahNumbers = [];
let traitedMap = new Map();
let showTreated = true;
let currentAyah = null;
let currentSourah = null;
let correctCount = 0;
let errorCount = 0;
let verseCache = new Map();
let startTime = null;
let endTime = null;
let elapsedTime = 0;
let timerInterval = null;
let lastUpdateTime = null;
const timerBox = document.createElement('div');
timerBox.classList.add('counter-box','remaining-box');
timerBox.style.fontWeight = 'normal';
timerBox.style.color = 'white';
timerBox.innerHTML = 'Début : <span id="start-time-display">--:--:--</span> &nbsp; Durée : <span id="elapsed-time-display">00:00:00</span>';
document.getElementById('counters').appendChild(timerBox);
const startDisplay = document.getElementById('start-time-display');
const elapsedDisplay = document.getElementById('elapsed-time-display');
function formatTime(ms) {
  const totalSeconds = Math.floor(ms / 1000);
  const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
  const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
  const s = String(totalSeconds % 60).padStart(2, '0');
  return `${h}:${m}:${s}`;
}
function updateTimerDisplay() {
  if (startTime && !endTime) {
    const now = Date.now();
    elapsedTime += now - lastUpdateTime;
    lastUpdateTime = now;
    elapsedDisplay.textContent = formatTime(elapsedTime);
  } else if (startTime && endTime) {
    elapsedDisplay.textContent = formatTime(elapsedTime);
  }
}
function startTimer() {
  if (startTime) return;
  startTime = Date.now();
  lastUpdateTime = startTime;
  endTime = null;
  endTimeBox.style.display = 'none';
  startDisplay.textContent = new Date(startTime).toLocaleString();
  elapsedTime = 0;
  timerInterval = setInterval(() => {
    if (document.visibilityState === 'visible') updateTimerDisplay();
  }, 500);
}
function stopTimer() {
  if (!startTime || endTime) return;
  clearInterval(timerInterval);
  timerInterval = null;
  endTime = Date.now();
  endTimeBox.style.display = 'block';
  endDisplay.textContent = new Date(endTime).toLocaleString();
  updateTimerDisplay();
}
document.addEventListener('visibilitychange', () => {
  if (!startTime) return;
  if (document.visibilityState === 'visible') {
    lastUpdateTime = Date.now();
    if (!timerInterval && !endTime) {
      timerInterval = setInterval(() => {
        if (document.visibilityState === 'visible') updateTimerDisplay();
      }, 500);
    }
  } else {
    clearInterval(timerInterval);
    timerInterval = null;
  }
});
function saveProgress() {
  const data = {
    sourah: sourahEl.value,
    start: startEl.value,
    end: endEl.value,
    ayahNumbers,
    traited: Array.from(traitedMap.entries()),
    correctCount,
    errorCount,
    startTime,
    elapsedTime,
    endTime
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function loadProgress() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return false;
  try {
    const data = JSON.parse(raw);
    sourahEl.value = data.sourah;
    startEl.value = data.start;
    endEl.value = data.end;
    ayahNumbers = Array.isArray(data.ayahNumbers) ? data.ayahNumbers : [];
    traitedMap = new Map(data.traited || []);
    correctCount = data.correctCount || 0;
    errorCount = data.errorCount || 0;
    startTime = data.startTime || null;
    elapsedTime = data.elapsedTime || 0;
    endTime = data.endTime || null;
    updateRange();
    renderAyahs();
    updateCounters();
    if (startTime) {
      startDisplay.textContent = new Date(startTime).toLocaleString();
      if (document.visibilityState === 'visible' && !endTime) {
        lastUpdateTime = Date.now();
        timerInterval = setInterval(() => {
          if (document.visibilityState === 'visible') updateTimerDisplay();
        }, 500);
      }
    }
    if (endTime) {
      endTimeBox.style.display = 'block';
      endDisplay.textContent = new Date(endTime).toLocaleString();
    }
    updateVerseHeader();
    return true;
  } catch {
    return false;
  }
}
function clearProgress() {
  localStorage.removeItem(STORAGE_KEY);
  startTime = null;
  endTime = null;
  elapsedTime = 0;
  clearInterval(timerInterval);
  timerInterval = null;
  startDisplay.textContent = "--:--:--";
  elapsedDisplay.textContent = "00:00:00";
  endTimeBox.style.display = 'none';
  endDisplay.textContent = "--:--:--";
}
function updateInterfaceTexts(lang) {
  const t = texts[lang];
  document.title = t.title;
  labelTitle.textContent = t.title;
  labelLanguage.textContent = t.languageLabel;
  labelSourate.textContent = t.sourateLabel;
  labelStart.textContent = t.startLabel;
  labelEnd.textContent = t.endLabel;
  btnRedistribuer.textContent = t.redistribuerBtn;
  btnTrier.textContent = t.trierBtn;
  btnToggleTraites.textContent = t.toggleTraitesBtn;
  btnCorrect.textContent = t.correctBtn;
  btnIncorrect.textContent = t.incorrectBtn;
  labelCorrectCount.textContent = t.correctCountLabel;
  labelErrorCount.textContent = t.errorCountLabel;
  labelRemainingCount.textContent = t.remainingCountLabel;
  lang === "ar" ? rangeWrap.classList.add("rtl-range") : rangeWrap.classList.remove("rtl-range");
  updateVerseHeader();
}
function updateVerseHeader() {
  if (currentSourah !== null && currentAyah !== null) {
    const t = texts[languageEl.value];
    verseHeaderEl.innerHTML = `${t.surahText}<span class="number-blue">${currentSourah}</span>, ${t.ayahText}<span class="number-blue">${currentAyah}</span>`;
  } else {
    verseHeaderEl.innerHTML = "";
  }
}
function populateSourates() {
  sourahEl.innerHTML = "";
  SURAHS.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.number;
    opt.text = `${s.number} - ${s.name_ar} (${s.name_fr})`;
    sourahEl.appendChild(opt);
  });
}
function updateRange() {
  const sel = SURAHS.find(s => s.number == sourahEl.value);
  if (!sel) return;
  startEl.min = 1;
  startEl.max = sel.count;
  startEl.value = 1;
  endEl.min = 1;
  endEl.max = sel.count;
  endEl.value = sel.count;
}
function validateInputs() {
  const sel = SURAHS.find(s => s.number == sourahEl.value);
  if (!sel) return false;
  let maxVerset = sel.count;
  let startVal = parseInt(startEl.value);
  let endVal = parseInt(endEl.value);
  if (isNaN(startVal) || startVal < 1) startVal = 1;
  if (isNaN(endVal) || endVal < 1) endVal = 1;
  if (startVal > maxVerset) startVal = maxVerset;
  if (endVal > maxVerset) endVal = maxVerset;
  if (startVal > endVal) startVal = endVal;
  startEl.value = startVal;
  endEl.value = endVal;
  return true;
}
function shuffleAyahs() {
  if (!validateInputs()) return;
  ayahNumbers = [];
  for (let i = +startEl.value; i <= +endEl.value; i++) ayahNumbers.push(i);
  for (let i = ayahNumbers.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [ayahNumbers[i], ayahNumbers[j]] = [ayahNumbers[j], ayahNumbers[i]];
  }
  traitedMap.clear();
  correctCount = 0;
  errorCount = 0;
  verseCache.clear();
  updateCounters();
  currentAyah = null;
  currentSourah = null;
  ayatBox.style.display = "none";
  renderAyahs();
  updateVerseHeader();
  clearProgress();
  saveProgress();
}
function sortAyahs() {
  ayahNumbers.sort((a, b) => a - b);
  renderAyahs();
}
function toggleTreated() {
  showTreated = !showTreated;
  renderAyahs();
}
function updateCounters() {
  correctEl.textContent = correctCount;
  errorEl.textContent = errorCount;
  totalEl.textContent = ayahNumbers.length;
  const remaining = ayahNumbers.length - traitedMap.size;
  remainingEl.textContent = remaining < 0 ? 0 : remaining;
}
function colorVerseText(text) {
  if (!text) return "";
  text = text.trim();
  const SIGNES = ["۞", "۩"];
  let cleanedText = text;
  SIGNES.forEach(s => {
    cleanedText = cleanedText.split(s).join("");
  });
  cleanedText = cleanedText.trim();
  const words = cleanedText.split(/\s+/).filter(w => w.length > 0);
  if (words.length === 0) return text;
  const firstWord = `<span class="verset-red">${words[0]}</span>`;
  const lastWord = words.length > 1 ? `<span class="verset-green">${words[words.length - 1]}</span>` : "";
  const originalParts = text.split(/\s+/).filter(p => p.length > 0);
  let wordIndex = 0;
  return originalParts.map(part => {
    if (part === "۞") return `<span class="verset-yellow">${part}</span>`;
    if (part === "۩") return `<span class="verset-blue">${part}</span>`;
    if (wordIndex === 0) {
      wordIndex++;
      return firstWord;
    } else if (wordIndex === words.length - 1) {
      wordIndex++;
      return lastWord;
    } else if (wordIndex > 0 && wordIndex < words.length - 1) {
      const w = words[wordIndex];
      wordIndex++;
      return w;
    }
    return part;
  }).join(" ");
}
function showAyah(num) {
  currentAyah = num;
  currentSourah = sourahEl.value;
  ayatBox.style.display = "block";
  const lang = languageEl.value;
  const cacheKey = `${currentSourah}:${num}:${lang}`;
  if (verseCache.has(cacheKey)) {
    verseTextEl.innerHTML = verseCache.get(cacheKey);
    updateVerseHeader();
    return;
  }
  verseTextEl.innerHTML = "Chargement du verset...";
  fetch(`https://api.alquran.cloud/v1/ayah/${currentSourah}:${num}/ar.alafasy`)
    .then(res => res.json())
    .then(data => {
      if (data.code === 200 && data.data && data.data.text) {
        let verseText = data.data.text;
        const bismillah = "بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ";
        if (num === 1 && verseText.startsWith(bismillah)) {
          verseText = verseText.slice(bismillah.length).trim();
        }
        const colored = colorVerseText(verseText);
        verseTextEl.innerHTML = `<div>${colored}</div>`;
        verseCache.set(cacheKey, verseTextEl.innerHTML);
        updateVerseHeader();
      } else {
        verseTextEl.innerHTML = "Erreur lors du chargement du verset.";
      }
    })
    .catch(() => {
      verseTextEl.innerHTML = "Erreur lors du chargement du verset.";
    });
  if (!startTime) {
    startTimer();
    saveProgress();
  }
}
function registerResponse(isCorrect) {
  if (currentAyah === null) return;
  if (!traitedMap.has(currentAyah)) {
    traitedMap.set(currentAyah, isCorrect);
    if (isCorrect) correctCount++;
    else errorCount++;
    updateCounters();
    renderAyahs();
    ayatBox.style.display = "none";
    currentAyah = null;
    currentSourah = null;
    updateVerseHeader();
    if (traitedMap.size === ayahNumbers.length) {
      stopTimer();
      saveProgress();
    } else {
      saveProgress();
    }
  }
}
function renderAyahs() {
  ayahContainer.innerHTML = "";
  ayahNumbers.forEach(num => {
    const status = traitedMap.get(num);
    if (status !== undefined && !showTreated) return;
    const div = document.createElement("div");
    div.classList.add("num");
    if (status === true) div.classList.add("traited", "correct");
    else if (status === false) div.classList.add("traited", "incorrect");
    div.innerText = num;
    if (status === undefined) div.onclick = () => showAyah(num);
    ayahContainer.appendChild(div);
  });
  updateCounters();
}
populateSourates();
const defaultLang = "ar";
languageEl.value = defaultLang;
updateInterfaceTexts(defaultLang);
if (!loadProgress()) shuffleAyahs();
languageEl.addEventListener("change", e => updateInterfaceTexts(e.target.value));
sourahEl.addEventListener("change", () => {
  updateRange();
  shuffleAyahs();
});
startEl.addEventListener("input", validateInputs);
endEl.addEventListener("input", validateInputs);
startEl.addEventListener("change", () => shuffleAyahs());
endEl.addEventListener("change", () => shuffleAyahs());
btnRedistribuer.onclick = shuffleAyahs;
btnTrier.onclick = sortAyahs;
btnToggleTraites.onclick = toggleTreated;
btnCorrect.onclick = () => registerResponse(true);
btnIncorrect.onclick = () => registerResponse(false);
})();
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .then(registration => {
        console.log('Service Worker enregistré avec succès:', registration.scope);
      })
      .catch(error => {
        console.log('Erreur d’enregistrement du Service Worker:', error);
      });
  });
}
</script>
<script>
let wakeLock = null;
async function requestWakeLock() {
  if ('wakeLock' in navigator) {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', () => { console.log('Wake Lock released'); });
      console.log('Wake Lock is active');
    } catch (err) {
      console.error(`Erreur de Wake Lock : ${err.name}, ${err.message}`);
    }
  } else {
    console.log('Wake Lock API non supportée sur ce navigateur.');
  }
}
window.addEventListener('load', () => { requestWakeLock(); });
document.addEventListener('visibilitychange', () => {
  if (wakeLock !== null && document.visibilityState === 'visible') {
    requestWakeLock();
  }
});
</script>
</body>
</html>
