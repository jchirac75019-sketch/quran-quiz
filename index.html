<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Quiz Versets Coran Avancé</title>
<style>
* { box-sizing: border-box; }
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
  background: #f9fafb;
  color: #333;
}
body {
  display: flex;
  flex-direction: column;
  max-width: 100vw;
  min-width: 280px;
  padding: 1em 4vw 1.5em;
  font-size: 16px;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
h1 {
  font-weight: 700;
  font-size: 1.4em;
  text-align: center;
  margin: 0;
  margin-bottom: 0.3em;
  color: #222;
  flex-shrink: 0;
  line-height: 1.2em;
  user-select: none;
}
.filters-container {
  display: flex !important;
  flex-wrap: nowrap !important;
  justify-content: flex-start;
  gap: 1rem;
  margin-bottom: 0.3em;
  width: 95%;
  max-width: 650px;
  margin-left: auto;
  margin-right: auto;
  align-items: center !important;
  background: #fff;
  padding: 12px 1.5vw;
  border-radius: 12px;
  box-shadow: 0 3px 15px rgb(0 0 0 / 0.08);
  user-select: none;
  overflow-x: auto;
  white-space: nowrap;
}
.rtl {
  direction: rtl !important;
  text-align: right !important;
}
.selector-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 75px;
  max-width: 18vw;
  flex-shrink: 1;
  padding: 0 4px;
  white-space: normal;
}
.selector-label {
  font-weight: 700;
  font-size: 0.7em;
  color: #5a552a;
  margin-bottom: 4px;
  white-space: nowrap;
  user-select: none;
  text-align: center;
  background-color: #a89e6e;
  padding: 3px 8px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.12);
  line-height: 1.1em;
  letter-spacing: 0.03em;
  text-transform: uppercase;
}
.language-select select, .sourah-select select, .range-wrap input[type='number'] {
  background-color: #f5f0dc;
  color: #5a552a;
  border: 2px solid #a89e6e;
  font-size: 0.95em;
  padding: 6px 8px;
  border-radius: 10px;
  min-width: 60px;
  max-width: 100%;
  cursor: pointer;
  box-shadow: inset 0 1px 5px rgb(0 0 0 / 0.07);
  flex-shrink: 1;
  transition: border-color 0.3s ease;
  font-weight: 600;
  text-align: center;
}
.language-select select:hover,
.sourah-select select:hover,
.range-wrap input[type='number']:hover,
.language-select select:focus,
.sourah-select select:focus,
.range-wrap input[type='number']:focus {
  border-color: #7a7039;
  outline: none;
}
.range-wrap {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  max-width: 160px;
  background: #fff;
  border-radius: 14px;
  padding: 6px 12px;
  box-shadow: 0 4px 18px rgb(0 0 0 / 0.12);
  flex-shrink: 1;
  flex-direction: row;
}
.range-input-group {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 65px;
  max-width: 85px;
  gap: 4px;
}
#start-label,
#end-label {
  background-color: #a89e6e;
  padding: 4px 8px;
  border-radius: 10px;
  color: #f5f0dc;
  font-weight: 700;
  cursor: default;
  font-size: 0.7em;
  box-shadow: 0 2px 12px rgb(0 0 0 / 0.18);
  user-select: none;
  white-space: nowrap;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  width: 100%;
  text-align: center;
  line-height: 1.2em;
}
.controls {
  display: flex !important;
  flex-wrap: nowrap !important;
  gap: 12px;
  justify-content: flex-start;
  margin-top: 0;
  margin-bottom: 1em;
  width: auto;
  max-width: 290px;
  margin-left: 0.5em;
  margin-right: auto;
  flex-shrink: 0;
  white-space: nowrap;
}
.controls button {
  flex: 1 1 30%;
  min-width: 70px !important;
  max-width: 33.3333%;
  padding: 7px 8px !important;
  font-size: 1em;
  border-radius: 14px;
  color: white;
  font-weight: 700;
  cursor: pointer;
  border: none;
  box-shadow: 0 4px 12px rgb(0 0 0 / 0.28);
  letter-spacing: 0.03em;
  transition: background-color 0.3s ease;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.controls button:hover {
  filter: brightness(110%);
}
#btnRedistribuer {
  background-color: #4caf50;
}
#btnTrier {
  background-color: #2196f3;
}
#btnToggle {
  background-color: #ff9800;
}
.table-wrap {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  max-height: 200px;
  max-width: 95vw;
  overflow-y: auto;
  border-radius: 14px;
  border: 1.5px solid #ccc;
  padding: 10px 10px;
  background: #fff;
  user-select: none;
  margin: 0 auto 10px;
  box-shadow: 0 4px 18px rgb(0 0 0 / 0.07);
  justify-content: center;
  flex-shrink: 1;
}
.num {
  border-radius: 14px;
  background: #d2f0d2;
  border: 1.8px solid #84b784;
  cursor: pointer;
  width: 42px;
  height: 42px;
  text-align: center;
  font-size: 1.1em;
  user-select: none;
  box-shadow: 0 2px 6px rgb(0 0 0 / 0.13);
  font-weight: 700;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: background-color 0.2s ease, transform 0.15s ease;
}
.num:hover {
  background-color: #b6deb7;
  transform: scale(1.07);
}
.num.selected {
  background-color: #8bc34a;
  color: #fff;
  border-color: #558b2f;
  transform: scale(1.15);
  box-shadow: 0 4px 12px rgb(0 0 0 / 0.25);
}
.num.traited.correct {
  background-color: #0b3d0b;
  color: #d8f5d8;
  cursor: default;
  border-color: #064206;
  text-decoration: line-through;
}
.num.traited.incorrect {
  background-color: #8b1c1c;
  color: #f5d8d8;
  cursor: default;
  border-color: #5e1212;
  text-decoration: line-through;
}
#ayat-box {
  max-width: 95vw;
  margin: 0 auto;
  background: #f5f5f5;
  border-radius: 16px;
  padding: 20px 22px;
  box-shadow: 0 10px 30px rgb(0 0 0 / 0.14);
  font-size: 1.2em;
  line-height: 1.55em;
  direction: rtl;
  text-align: right;
  overflow-y: auto;
  overflow-x: hidden;
  box-sizing: border-box;
  position: static;
  z-index: 9999;
  max-height: 38em;
  user-select: text;
  display: none;
  flex-shrink: 1;
}
#verse-header {
  font-weight: 700;
  font-size: 1.07em;
  background: #fff9c4;
  padding: 10px 16px;
  border-radius: 12px;
  margin-bottom: 16px;
  box-shadow: inset 0 1px 4px #d2ca5fbb;
}
#verse-text {
  font-size: 1.26em;
  line-height: 1.5em;
  margin-bottom: 18px;
  overflow-y: auto;
  word-break: break-word;
}
.special-red {
  color: red !important;
  font-weight: 700;
}
.special-green {
  color: green !important;
  font-weight: 700;
}
.special-yellow {
  color: orange !important;
  font-weight: 700;
}
.special-blue {
  color: blue !important;
  font-weight: 700;
}
#response-buttons {
  display: flex;
  justify-content: center;
  gap: 24px;
  margin-top: 18px;
  user-select: none;
  flex-wrap: nowrap;
  max-width: 480px;
  margin-left: auto;
  margin-right: auto;
}
#response-buttons button {
  cursor: pointer;
  flex: 1 1 48%;
  font-weight: 700;
  font-size: 0.9em;
  padding: 6px 14px;
  border: none;
  border-radius: 16px;
  color: white;
  background-color: #4caf50;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  transition: background-color 0.2s ease;
  max-height: 36px;
  line-height: 1.1em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#response-buttons button:hover {
  filter: brightness(110%);
}
#btnIncorrect {
  background-color: #d32f2f !important;
}
#btnCorrect::before {
  content: "✔";
  color: #a5e6a5;
  font-weight: 700;
}
#btnIncorrect::before {
  content: "✖";
  color: #f5a8a8;
  font-weight: 700;
}
.counter-box {
  padding: 8px 18px;
  border-radius: 16px;
  font-weight: 700;
  text-align: center;
  color: white;
  margin: 2px;
  user-select: none;
  font-size: 0.86em;
  min-width: 90px;
  flex-shrink: 0;
}
.counter-correct {
  background-color: #0b3d0b;
}
.counter-incorrect {
  background-color: #8b1c1c;
}
.counter-remaining {
  background-color: #505050;
}
#timer-container {
  margin-top: 12px;
  margin-bottom: 12px;
  text-align: center;
  font-weight: 700;
  font-size: 1.05em;
  color: #606060;
  user-select: none;
  letter-spacing: 0.035em;
  flex-shrink: 0;
}
#timer-container div {
  margin: 8px 0;
}
#timer-end {
  margin-top: 16px;
  background: #222;
  color: white;
  padding: 14px 20px;
  border-radius: 14px;
  display: none;
  text-align: center;
  font-size: 1.16em;
  box-shadow: 0 5px 20px #000000dc;
  user-select: none;
  min-width: 280px;
  margin: 0 auto 0 auto;
  flex-shrink: 0;
}
/* Responsive adjustments */
@media (max-width: 767px) {
  body {
    font-size: 14px;
    padding: 1em 3vw 1.2em;
  }
  .filters-container {
    max-width: 100% !important;
  }
  .selector-wrapper {
    max-width: 32vw;
    min-width: 70px;
  }
  .range-wrap {
    max-width: 140px;
  }
  .controls {
    max-width: 100% !important;
    margin-left: 0.25em;
  }
  .controls button {
    min-width: 60px !important;
    font-size: 0.9em;
    padding: 6px 6px !important;
  }
  .table-wrap {
    max-height: 140px;
    max-width: 100vw;
    padding: 8px 8px;
    overflow-x: auto;
  }
  #ayat-box {
    max-height: 28em;
    padding: 14px 16px;
    font-size: 1.12em;
  }
  #response-buttons {
    max-width: 100%;
  }
  #response-buttons button {
    padding: 6px 10px;
    font-size: 0.85em;
    max-height: 36px;
  }
  .counter-box {
    min-width: 75px;
    padding: 7px 12px;
    font-size: 0.8em;
  }
  #timer-container {
    font-size: 0.95em;
    margin-top: 6px;
    margin-bottom: 8px;
  }
}
@media (min-width: 1024px) {
  body {
    font-size: 17px;
    padding: 1.5em 6vw 1.5em;
  }
  .filters-container {
    max-width: 720px;
  }
  .table-wrap {
    max-height: 220px;
    max-width: 720px;
  }
  #ayat-box {
    max-height: 38em;
    font-size: 1.3em;
  }
  .counter-box {
    font-size: 1em;
    min-width: 110px;
  }
  #timer-container {
    font-size: 1.1em;
    margin-top: 12px;
    margin-bottom: 12px;
  }
}
</style>
</head>
<body>
<h1 id="app-title"></h1>
<div class="filters-container" id="selectors" role="region" aria-label="">
  <div class="selector-wrapper" id="language-wrapper">
    <div class="selector-label" id="language-label" aria-live="polite" aria-atomic="true"></div>
    <div class="language-select">
      <select id="language" aria-labelledby="language-label" name="language">
        <option value="ar" data-ar-label="العربية">العربية</option>
        <option value="fr" data-ar-label="الفرنسية">Français</option>
        <option value="en" data-ar-label="الإنجليزية">English</option>
        <option value="es" data-ar-label="الإسبانية">Español</option>
      </select>
    </div>
  </div>
  <div class="selector-wrapper" id="sourah-wrapper">
    <div class="selector-label" id="sourah-label" aria-live="polite" aria-atomic="true"></div>
    <div class="sourah-select">
      <select id="sourah" aria-labelledby="sourah-label" name="sourah"></select>
    </div>
  </div>
  <div class="selector-wrapper range-wrap" style="flex-direction: row; gap: 12px; max-width: auto; min-width: auto; align-items: center; justify-content: center;">
    <div class="range-input-group">
      <label class="selector-label" id="start-label" for="start" aria-live="polite" aria-atomic="true"></label>
      <input type="number" id="start" min="1" aria-labelledby="start-label" autocomplete="off"/>
    </div>
    <div class="range-input-group">
      <label class="selector-label" id="end-label" for="end" aria-live="polite" aria-atomic="true"></label>
      <input type="number" id="end" min="1" aria-labelledby="end-label" autocomplete="off"/>
    </div>
  </div>
  <div class="controls" id="controls" style="margin: 0; flex-grow: 0;">
    <button id="btnRedistribuer" type="button"></button>
    <button id="btnTrier" type="button"></button>
    <button id="btnToggle" type="button"></button>
  </div>
</div>
<div class="table-wrap" id="ayahs-container" role="region" aria-label=""></div>
<div id="ayat-box" style="display:none;" role="region" aria-live="polite" aria-atomic="true">
  <div id="verse-header"></div>
  <div id="verse-text"></div>
  <div id="response-buttons" role="group" aria-label="">
    <button id="btnCorrect" type="button"></button>
    <button id="btnIncorrect" type="button"></button>
  </div>
</div>
<div id="counters" style="display:flex; justify-content:center; gap:12px; margin-bottom:8px;" aria-live="polite" aria-atomic="true">
  <div class="counter-box counter-correct" style="flex:1; margin:0;">
    <span id="label-correct"></span> <span id="correct-count">0</span>
  </div>
  <div class="counter-box counter-incorrect" style="flex:1; margin:0;">
    <span id="label-incorrect"></span> <span id="incorrect-count">0</span>
  </div>
  <div class="counter-box counter-remaining" style="flex:none; margin:0; min-width:144px; text-align:center;">
    <span id="label-remaining"></span> <span id="remaining-count">0</span> / <span id="total-count">0</span>
  </div>
</div>
<div id="timer-container" aria-live="polite" aria-atomic="true" style="max-width: 520px; margin: 0 auto 12px auto;">
  <div><strong></strong> <span id="start-time-display">--:--:--</span></div>
  <div><strong></strong> <span id="elapsed-time-display">00:00:00</span></div>
  <div><strong></strong> <span id="timer-end-time">--:--:--</span></div>
</div>
<div id="timer-end" style="display:none; flex:none; min-width:280px; margin:0 auto 0 auto;">
  <span></span><span id="end-time-display"></span>
</div>
<script>
(() => {
  const texts = {
    ar: {
      title: "اختبار آيات القرآن المتقدم",
      languageLabel: "اللغة",
      sourahLabel: "السورة",
      startLabel: "بداية",
      endLabel: "نهاية",
      redistribuer: "إعادة التوزيع",
      trier: "ترتيب",
      toggle: "إظهار / إخفاء",
      correct: "إجابة صحيحة",
      incorrect: "إجابة خاطئة",
      labelCorrect: "الإجابات",
      labelIncorrect: "الأخطاء",
      labelRemaining: "المتبقي",
      surahPrefix: "سورة",
      ayahPrefix: "آية",
      timerStart: "البداية:",
      timerElapsed: "الوقت المنقضي:",
      timerEnd: "النهاية:"
    },
    fr: {
      title: "Quiz Versets Coran Avancé",
      languageLabel: "Langue",
      sourahLabel: "Sourate",
      startLabel: "Début",
      endLabel: "Fin",
      redistribuer: "Redistribuer",
      trier: "Trier",
      toggle: "Afficher / Cacher",
      correct: "Bonne réponse",
      incorrect: "Mauvaise réponse",
      labelCorrect: "Réponses",
      labelIncorrect: "Erreurs",
      labelRemaining: "Restantes",
      surahPrefix: "Sourate",
      ayahPrefix: "Verset",
      timerStart: "Début:",
      timerElapsed: "Temps écoulé:",
      timerEnd: "Fin:"
    },
    en: {
      title: "Advanced Quran Quiz",
      languageLabel: "Language",
      sourahLabel: "Surah",
      startLabel: "Start",
      endLabel: "End",
      redistribuer: "Shuffle",
      trier: "Sort",
      toggle: "Show / Hide",
      correct: "Correct",
      incorrect: "Incorrect",
      labelCorrect: "Correct",
      labelIncorrect: "Errors",
      labelRemaining: "Remaining",
      surahPrefix: "Surah",
      ayahPrefix: "Ayah",
      timerStart: "Start:",
      timerElapsed: "Elapsed:",
      timerEnd: "End:"
    },
    es: {
      title: "Quiz Avanzado del Corán",
      languageLabel: "Idioma",
      sourahLabel: "Sura",
      startLabel: "Inicio",
      endLabel: "Fin",
      redistribuer: "Barajar",
      trier: "Ordenar",
      toggle: "Mostrar / Ocultar",
      correct: "Correcto",
      incorrect: "Incorrecto",
      labelCorrect: "Correctos",
      labelIncorrect: "Errores",
      labelRemaining: "Restantes",
      surahPrefix: "Sura",
      ayahPrefix: "Verso",
      timerStart: "Inicio:",
      timerElapsed: "Transcurrido:",
      timerEnd: "Fin:"
    }
  };
  const SURAHS = [
    { number:1,names:{ar:"الفاتحة",fr:"Al-Fatiha",en:"Al-Fatiha",es:"Al-Fatiha"},count:7 },
    { number:2,names:{ar:"البقرة",fr:"Al-Baqara",en:"Al-Baqara",es:"Al-Baqara"},count:286 }
  ];
  const BISMILLAH = "بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ";
  const languageEl = document.getElementById("language");
  const sourahEl = document.getElementById("sourah");
  const startEl = document.getElementById("start");
  const endEl = document.getElementById("end");
  const ayahsContainer = document.getElementById("ayahs-container");
  const ayatBox = document.getElementById("ayat-box");
  const verseHeader = document.getElementById("verse-header");
  const verseText = document.getElementById("verse-text");
  const btnCorrect = document.getElementById("btnCorrect");
  const btnIncorrect = document.getElementById("btnIncorrect");
  const btnRedistribuer = document.getElementById("btnRedistribuer");
  const btnTrier = document.getElementById("btnTrier");
  const btnToggle = document.getElementById("btnToggle");
  const countCorrect = document.getElementById("correct-count");
  const countIncorrect = document.getElementById("incorrect-count");
  const countRemaining = document.getElementById("remaining-count");
  const countTotal = document.getElementById("total-count");
  const labelCorrect = countCorrect.previousElementSibling;
  const labelIncorrect = countIncorrect.previousElementSibling;
  const labelRemaining = countRemaining.previousElementSibling;
  const labelLanguage = document.getElementById("language-label");
  const labelSourah = document.getElementById("sourah-label");
  const labelStart = document.getElementById("start-label");
  const labelEnd = document.getElementById("end-label");
  const timerStartDisplay = document.getElementById("start-time-display");
  const timerElapsedDisplay = document.getElementById("elapsed-time-display");
  const timerEndDisplay = document.getElementById("timer-end-time");
  const timerEndBox = document.getElementById("timer-end");
  const endTimeDisplay = document.getElementById("end-time-display");
  let ayahs = [];
  let traitedMap = new Map();
  let currentAyah = null;
  let currentSourah = null;
  let correctCountValue = 0;
  let incorrectCountValue = 0;
  let showTreated = true;
  let startTime = null;
  let endTime = null;
  let elapsedTime = 0;
  let timerInterval = null;
  let lastUpdateTime = null;
  let verseCache = new Map();
  let selectedNumDiv = null;
  let pageVisible = true;
  function setTexts(lang) {
    const t = texts[lang];
    document.title = t.title;
    document.getElementById("app-title").textContent = t.title;
    labelLanguage.textContent = t.languageLabel;
    labelSourah.textContent = t.sourahLabel;
    labelStart.textContent = t.startLabel;
    labelEnd.textContent = t.endLabel;
    btnRedistribuer.textContent = t.redistribuer;
    btnTrier.textContent = t.trier;
    btnToggle.textContent = t.toggle;
    btnCorrect.textContent = t.correct;
    btnIncorrect.textContent = t.incorrect;
    labelCorrect.textContent = t.labelCorrect;
    labelIncorrect.textContent = t.labelIncorrect;
    labelRemaining.textContent = t.labelRemaining;
    updateDirection(lang);
    const timerContainer = document.getElementById('timer-container');
    if (timerContainer) {
      let children = timerContainer.children;
      if(children.length >= 3) {
        children[0].querySelector('strong').textContent = t.timerStart;
        children[1].querySelector('strong').textContent = t.timerElapsed;
        children[2].querySelector('strong').textContent = t.timerEnd;
      }
    }
    const timerEndLabel = document.querySelector('#timer-end > span:first-child');
    if(timerEndLabel) {
      timerEndLabel.textContent = t.timerEnd + ' ';
    }
  }
  function updateDirection(lang) {
    const rtl = lang === "ar";
    document.documentElement.dir = rtl ? "rtl" : "ltr";
    if(rtl){
      document.body.classList.add('rtl');
      labelStart.parentElement.classList.add('rtl-flip');
      labelEnd.parentElement.classList.add('rtl-flip');
      document.getElementById('selectors').classList.add('rtl-flip');
      document.getElementById('ayahs-container').classList.add('rtl-flip');
      document.getElementById('ayat-box').classList.add('rtl-flip');
      document.getElementById('counters').classList.add('rtl-flip');
      document.getElementById('timer-container').classList.add('rtl-flip');
      document.getElementById('controls').classList.add('rtl-flip');
    } else {
      document.body.classList.remove('rtl');
      labelStart.parentElement.classList.remove('rtl-flip');
      labelEnd.parentElement.classList.remove('rtl-flip');
      document.getElementById('selectors').classList.remove('rtl-flip');
      document.getElementById('ayahs-container').classList.remove('rtl-flip');
      document.getElementById('ayat-box').classList.remove('rtl-flip');
      document.getElementById('counters').classList.remove('rtl-flip');
      document.getElementById('timer-container').classList.remove('rtl-flip');
      document.getElementById('controls').classList.remove('rtl-flip');
    }
  }
  function updateLanguageFilterLabels(lang) {
    if(lang === 'ar') {
      const options = languageEl.querySelectorAll('option');
      options.forEach(opt => {
        const arLabel = opt.getAttribute('data-ar-label');
        if(arLabel) {
          opt.textContent = arLabel;
        }
      });
    } else {
      languageEl.options[0].textContent = 'العربية';
      languageEl.options[1].textContent = 'Français';
      languageEl.options[2].textContent = 'English';
      languageEl.options[3].textContent = 'Español';
    }
  }
  function populateSourahOptions() {
    sourahEl.innerHTML = '';
    const lang = languageEl.value;
    for (const s of SURAHS) {
      const opt = document.createElement('option');
      opt.value = s.number;
      if (lang === 'ar') {
        opt.textContent = `${s.number} - ${s.names.ar}`;
      } else {
        const name = s.names[lang] || s.names.fr || s.names.ar;
        opt.textContent = `${s.number} - ${name}`;
      }
      sourahEl.appendChild(opt);
    }
  }
  function updateLimits(reinit = true) {
    const s = SURAHS.find(x => x.number == sourahEl.value);
    if (!s) return;
    startEl.min = 1; startEl.max = s.count;
    endEl.min = 1; endEl.max = s.count;
    if (reinit) {
      startEl.value = 1;
      endEl.value = s.count;
    } else {
      if (startEl.value < 1) startEl.value = 1;
      if (startEl.value > s.count) startEl.value = s.count;
      if (endEl.value < 1) endEl.value = 1;
      if (endEl.value > s.count) endEl.value = s.count;
    }
  }
  function validateRange() {
    let s = SURAHS.find(x => x.number == sourahEl.value);
    if (!s) return false;
    let start = Number(startEl.value);
    let end = Number(endEl.value);
    if (isNaN(start) || start < 1) start = 1;
    if (isNaN(end) || end < 1) end = 1;
    if (start > s.count) start = s.count;
    if (end > s.count) end = s.count;
    if (start > end) start = end;
    startEl.value = start;
    endEl.value = end;
    return true;
  }
  function shuffleAyahs() {
    if (!validateRange()) return;
    ayahs = [];
    let start = Number(startEl.value);
    let end = Number(endEl.value);
    for (let i = start; i <= end; i++) {
      ayahs.push(i);
    }
    for (let i = ayahs.length - 1; i > 0; i--) {
      let j = Math.floor(Math.random() * (i + 1));
      [ayahs[i], ayahs[j]] = [ayahs[j], ayahs[i]];
    }
    traitedMap.clear();
    correctCountValue = 0;
    incorrectCountValue = 0;
    verseCache.clear();
    currentAyah = null;
    currentSourah = null;
    updateCounts();
    renderAyahs();
    resetTimer(true);
    clearVerseDetails();
    clearSelectedNum();
  }
  function renderAyahs() {
    ayahsContainer.innerHTML = '';
    for (const num of ayahs) {
      if (traitedMap.has(num) && !showTreated) continue;
      let div = document.createElement('div');
      div.textContent = num;
      div.classList.add('num');
      if (traitedMap.get(num) === true) div.classList.add('traited', 'correct');
      else if (traitedMap.get(num) === false) div.classList.add('traited', 'incorrect');
      else {
        div.onclick = () => {
          showAyah(num);
          resumeTimer();
          setSelectedNum(div);
        };
        div.ontouchstart = () => {
          setSelectedNum(div);
        };
      }
      ayahsContainer.appendChild(div);
    }
    updateCounts();
    checkIfCompleteStopTimer();
  }
  function setSelectedNum(div) {
    if (selectedNumDiv) selectedNumDiv.classList.remove('selected');
    selectedNumDiv = div;
    if (selectedNumDiv) selectedNumDiv.classList.add('selected');
  }
  function clearSelectedNum() {
    if (selectedNumDiv) {
      selectedNumDiv.classList.remove('selected');
      selectedNumDiv = null;
    }
  }
  function updateCounts() {
    correctCountValue = [...traitedMap.values()].filter(v => v === true).length;
    incorrectCountValue = [...traitedMap.values()].filter(v => v === false).length;
    countCorrect.textContent = correctCountValue;
    countIncorrect.textContent = incorrectCountValue;
    countRemaining.textContent = ayahs.length - traitedMap.size;
    countTotal.textContent = ayahs.length;
  }
  function checkIfCompleteStopTimer() {
    if (traitedMap.size === ayahs.length && ayahs.length > 0) stopTimer();
  }
  async function fetchVerseWithFallback(surah, ayah, lang) {
    const key = `${surah}:${ayah}:${lang}`;
    if (verseCache.has(key)) return verseCache.get(key);
    const fetchPrimary = () => fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${ayah}/ar.alafasy`)
      .then(res => { if (!res.ok) throw new Error('Primary source response not ok'); return res.json(); })
      .then(data => { if(data.code === 200 && data.data && data.data.text) return data.data.text.trim(); throw new Error('Primary source data missing or invalid'); });
    try { return await fetchPrimary(); }
    catch (e) { throw new Error('Verse fetch failed'); }
  }
  async function showAyah(num) {
    if (!num) return;
    currentAyah = num;
    currentSourah = sourahEl.value;
    ayatBox.style.display = 'block';
    const surahNo = Number(currentSourah);
    const key = `${currentSourah}:${currentAyah}:ar`;
    if (verseCache.has(key)) {
      verseText.innerHTML = verseCache.get(key);
      updateHeader();
      return;
    }
    verseText.textContent = 'Chargement...';
    try {
      let txt = await fetchVerseWithFallback(currentSourah, currentAyah, 'ar');
      if (num === 1 && surahNo !== 1) {
        const bismillahRegex = /^بِسْمِ\s*ٱللَّهِ\s*ٱلرَّحْمَٰنِ\s*ٱلرَّحِيمِ\s*/u;
        if (bismillahRegex.test(txt)) txt = txt.replace(bismillahRegex, '').trim();
      }
      let colored = colorVerseText(txt);
      verseText.innerHTML = `<div>${colored}</div>`;
      verseCache.set(key, verseText.innerHTML);
      updateHeader();
    } catch {
      verseText.textContent = 'Erreur lors du chargement du verset.';
    }
    if (!startTime) startTimer();
  }
  function updateHeader() {
    if (currentSourah && currentAyah) {
      const lang = languageEl.value;
      const t = texts[lang] || texts.fr;
      verseHeader.innerHTML = `${t.surahPrefix} ${currentSourah}, ${t.ayahPrefix} ${currentAyah}`;
    } else {
      verseHeader.textContent = '';
    }
  }
  function colorVerseText(text) {
    if (!text) return '';
    const specialSigns = ["ۚ", "ۗ", "ۖ", "ۘ", "ۛ"];
    const normalSigns = ["۞", "۩"];
    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&apos;' })[m]);
    }
    let escaped = escapeHtml(text);
    let symbolYellowSpan = '';
    const symbolReg = new RegExp(escapeHtml("۞"), 'g');
    if (symbolReg.test(escaped)) {
      symbolYellowSpan = '<span class="special-yellow">۞</span> ';
      escaped = escaped.replace(symbolReg, '');
    }
    for (const s of specialSigns) {
      const esc = escapeHtml(s);
      escaped = escaped.replace(new RegExp(esc, 'gu'), `<span class="special-red">${esc}</span>`);
    }
    for (const s of normalSigns) {
      if (s === "۞") continue;
      const esc = escapeHtml(s);
      escaped = escaped.replace(new RegExp(esc, 'gu'), `<span class="special-blue">${esc}</span>`);
    }
    let match = escaped.match(/(<span class="special-blue">۩<\/span>)$/);
    let endSymbol = "";
    if (match) {
      escaped = escaped.replace(/(<span class="special-blue">۩<\/span>)$/, "").trim();
      endSymbol = match[1];
    }
    const tmpDiv = document.createElement('div');
    tmpDiv.innerHTML = escaped;
    for (const sp of tmpDiv.querySelectorAll('span.special-red, span.special-yellow, span.special-blue')) {
      sp.replaceWith(document.createTextNode(sp.textContent));
    }
    const cleanText = tmpDiv.textContent.trim();
    if (!cleanText) return symbolYellowSpan + escaped + (endSymbol ? " " + endSymbol : '');
    const plainWords = cleanText.split(/\s+/);
    const tokens = escaped.split(/(\s+)/);
    let firstIdx = -1;
    let lastIdx = -1;
    let wordCounter = 0;
    for (let i = 0; i < tokens.length; i++) {
      const plainToken = tokens[i].replace(/<[^>]+>/g, '').trim();
      if (plainToken === '') continue;
      if (wordCounter >= plainWords.length) break;
      if (tokens[i].includes(plainWords[wordCounter])) {
        if (firstIdx === -1) firstIdx = i;
        lastIdx = i;
        wordCounter++;
      }
    }
    if (firstIdx !== -1)
      tokens[firstIdx] = `<span class="special-red">${tokens[firstIdx]}</span>`;
    if (lastIdx !== -1 && lastIdx !== firstIdx)
      tokens[lastIdx] = `<span class="special-green">${tokens[lastIdx]}</span>`;
    return symbolYellowSpan + tokens.join('') + (endSymbol ? " " + endSymbol : '');
  }
  function registerAnswer(correct) {
    if (currentAyah == null) return;
    if (!traitedMap.has(currentAyah)) {
      traitedMap.set(currentAyah, correct);
      if (correct) correctCountValue++;
      else incorrectCountValue++;
      updateCounts();
      renderAyahs();
      ayatBox.style.display = 'none';
      currentAyah = null;
      currentSourah = null;
      clearVerseDetails();
      checkIfCompleteStopTimer();
      clearSelectedNum();
    }
  }
  function toggleTreated() {
    showTreated = !showTreated;
    renderAyahs();
  }
  function sortAyahs() {
    ayahs.sort((a, b) => a - b);
    renderAyahs();
  }
  function resetTimer(resetElapsed) {
    clearInterval(timerInterval);
    timerInterval = null;
    startTime = null;
    endTime = null;
    lastUpdateTime = null;
    pageVisible = true;
    if (resetElapsed) elapsedTime = 0;
    timerStartDisplay.textContent = '--:--:--';
    timerElapsedDisplay.textContent = '00:00:00';
    endTimeDisplay.textContent = '--:--:--';
    timerEndBox.style.display = 'none';
  }
  function startTimer() {
    if (startTime) return;
    startTime = Date.now();
    lastUpdateTime = startTime;
    elapsedTime = 0;
    pageVisible = true;
    timerInterval = setInterval(() => updateElapsedTime(), 500);
    timerStartDisplay.textContent = new Date(startTime).toLocaleString();
    timerEndBox.style.display = 'none';
    timerEndDisplay.textContent = '--:--:--';
  }
  function stopTimer() {
    if (!startTime || endTime) return;
    clearInterval(timerInterval);
    timerInterval = null;
    endTime = Date.now();
    timerEndBox.style.display = 'block';
    endTimeDisplay.textContent = new Date(endTime).toLocaleString();
    timerEndDisplay.textContent = new Date(endTime).toLocaleString();
  }
  function resumeTimer() {
    if (traitedMap.size === ayahs.length) return;
    if (!pageVisible) return;
    if (!startTime) {
      startTime = Date.now() - elapsedTime;
      lastUpdateTime = Date.now();
      timerInterval = setInterval(() => updateElapsedTime(), 500);
      timerStartDisplay.textContent = new Date(startTime).toLocaleString();
    } else if (!timerInterval) {
      lastUpdateTime = Date.now();
      timerInterval = setInterval(() => updateElapsedTime(), 500);
    }
  }
  function updateElapsedTime() {
    if (!startTime || !pageVisible) return;
    const now = Date.now();
    elapsedTime += now - lastUpdateTime;
    lastUpdateTime = now;
    timerElapsedDisplay.textContent = formatTime(elapsedTime);
  }
  function formatTime(ms) {
    ms = Math.max(0, ms);
    const sec = Math.floor(ms / 1000);
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    return `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
  }
  function clearVerseDetails() {
    currentAyah = null;
    currentSourah = null;
    ayatBox.style.display = 'none';
    verseHeader.textContent = '';
    verseText.textContent = '';
    clearSelectedNum();
  }
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      pageVisible = false;
      clearInterval(timerInterval);
      timerInterval = null;
    } else {
      pageVisible = true;
      if (startTime && !endTime && traitedMap.size < ayahs.length) {
        lastUpdateTime = Date.now();
        timerInterval = setInterval(() => updateElapsedTime(), 500);
      }
    }
  });
  languageEl.addEventListener('change', () => {
    const lang = languageEl.value;
    setTexts(lang);
    updateLanguageFilterLabels(lang);
    populateSourahOptions();
    updateLimits(true);
    shuffleAyahs();
    resetTimer(true);
    clearVerseDetails();
  });
  sourahEl.addEventListener('change', () => {
    updateLimits(true);
    shuffleAyahs();
    resetTimer(true);
    clearVerseDetails();
    clearSelectedNum();
  });
  startEl.addEventListener('input', () => { if(validateRange()) shuffleAyahs(); });
  endEl.addEventListener('input', () => { if(validateRange()) shuffleAyahs(); });
  btnRedistribuer.addEventListener('click', () => { shuffleAyahs(); resetTimer(true); });
  btnTrier.addEventListener('click', sortAyahs);
  btnToggle.addEventListener('click', toggleTreated);
  btnCorrect.addEventListener('click', () => registerAnswer(true));
  btnIncorrect.addEventListener('click', () => registerAnswer(false));
  document.addEventListener('DOMContentLoaded', () => {
    languageEl.value = 'ar'; // Default Arabic
    setTexts('ar');
    updateLanguageFilterLabels('ar');
    populateSourahOptions();
    sourahEl.value = '1';
    updateLimits(true);
    shuffleAyahs();
  });
})();
</script>
</body>
</html>
