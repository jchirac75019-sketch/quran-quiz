<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Quiz Versets Coran Avancé</title>
<style>
* { box-sizing: border-box; }
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
  background: #f9fafb;
  color: #333;
}
body {
  display: flex;
  flex-direction: column;
  max-width: 100vw;
  min-width: 280px;
  font-size: 16px;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
  -webkit-tap-highlight-color: transparent;
  overscroll-behavior: contain;
  background-attachment: fixed;
  padding-bottom: 130px; /* Adjusted for smaller bottom bar */
  margin: 0;
}
#main-scroll-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow-y: auto;
  padding: 1em 4vw 1.5em;
}
h1 {
  font-weight: 700;
  font-size: 1.4em;
  text-align: center;
  margin: 0;
  margin-bottom: 0.3em;
  color: #222;
  flex-shrink: 0;
  line-height: 1.2em;
  user-select: none;
}
.filters-container {
  display: flex !important;
  flex-wrap: nowrap !important;
  justify-content: flex-start;
  gap: 1rem;
  margin-bottom: 0.1em;
  width: 95%;
  max-width: 650px;
  margin-left: auto;
  margin-right: auto;
  align-items: center !important;
  background: #fff;
  padding: 12px 1.5vw;
  border-radius: 12px;
  box-shadow: 0 3px 15px rgb(0 0 0 / 0.08);
  user-select: none;
  overflow-x: auto;
  white-space: nowrap;
}
.rtl {
  direction: rtl !important;
  text-align: right !important;
}
.selector-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 60px;
  flex-shrink: 1;
  padding: 0 4px;
  white-space: normal;
}
.selector-wrapper#sourah-wrapper {
  max-width: 14vw; /* default width for sourah filter in Arabic */
  margin-left: 8px; /* add small space to left when in LTR */
}
.rtl .selector-wrapper#sourah-wrapper {
  margin-left: 0; /* no left margin in RTL */
  margin-right: 8px; /* add small space right in RTL */
}
.selector-wrapper.non-arabic {
  min-width: 50px;
  max-width: 9vw;
}
.selector-wrapper.non-arabic#sourah-wrapper {
  max-width: 8vw; /* reduced width for sourah filter when language is not Arabic */
}
.selector-wrapper.non-arabic .selector-label {
  font-size: 0.55em;
  white-space: nowrap;
}
.selector-wrapper.non-arabic select {
  font-size: 0.75em !important;
  min-width: 42px;
  padding: 4px 6px;
}
.selector-label {
  font-weight: 700;
  color: #5a552a;
  margin-bottom: 4px;
  white-space: nowrap;
  user-select: none;
  text-align: center;
  background-color: #a89e6e;
  padding: 3px 8px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.12);
  line-height: 1.1em;
  letter-spacing: 0.03em;
  text-transform: uppercase;
}
.language-select select, .sourah-select select, .range-wrap input[type='number'] {
  background-color: #f5f0dc;
  color: #5a552a;
  border: 2px solid #a89e6e;
  font-size: 0.95em;
  padding: 6px 8px;
  border-radius: 10px;
  min-width: 56px;
  max-width: 100%;
  cursor: pointer;
  box-shadow: inset 0 1px 5px rgb(0 0 0 / 0.07);
  flex-shrink: 1;
  transition: border-color 0.3s ease;
  font-weight: 600;
  text-align: center;
}
.language-select select:hover,
.sourah-select select:hover,
.range-wrap input[type='number']:hover,
.language-select select:focus,
.sourah-select select:focus,
.range-wrap input[type='number']:focus {
  border-color: #7a7039;
  outline: none;
}
.range-wrap {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  max-width: 160px;
  background: #fff;
  border-radius: 14px;
  padding: 6px 12px;
  box-shadow: 0 4px 18px rgb(0 0 0 / 0.12);
  flex-shrink: 1;
  flex-direction: row;
  position: relative;
}
.range-input-group {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 65px;
  max-width: 85px;
  gap: 4px;
}
#start-label,
#end-label {
  background-color: #a89e6e;
  padding: 4px 8px;
  border-radius: 10px;
  color: #f5f0dc;
  font-weight: 700;
  cursor: default;
  font-size: 0.7em;
  box-shadow: 0 2px 12px rgb(0 0 0 / 0.18);
  user-select: none;
  white-space: nowrap;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  width: 100%;
  text-align: center;
  line-height: 1.2em;
  height: 1.8em;
}
.controls {
  display: flex !important;
  flex-wrap: nowrap !important;
  gap: 12px;
  justify-content: flex-start;
  margin-top: 0;
  margin-bottom: 0.1em;
  width: auto;
  max-width: 290px;
  margin-left: 0.5em;
  margin-right: auto;
  flex-shrink: 0;
  white-space: nowrap;
}
.controls button {
  flex: 1 1 30%;
  min-width: 64px !important; /* reduced width */
  max-width: 33.3333%;
  padding: 6px 6px !important; /* reduced padding */
  font-size: 0.9em; /* slightly smaller */
  border-radius: 14px;
  color: white;
  font-weight: 700;
  cursor: pointer;
  border: none;
  box-shadow: 0 4px 12px rgb(0 0 0 / 0.28);
  letter-spacing: 0.03em;
  transition: background-color 0.3s ease;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.controls button:hover {
  filter: brightness(110%);
}
#btnRedistribuer {
  background-color: #4caf50;
}
#btnTrier {
  background-color: #2196f3;
}
#btnToggle {
  background-color: #ff9800;
}
#btnShowHideTimer {
  background-color: #795548;
  margin-top: 8px;
  max-width: 290px;
  width: 100%;
  padding: 6px 6px !important;
  font-size: 0.9em;
  border-radius: 14px;
  box-shadow: 0 4px 12px rgb(0 0 0 / 0.28);
  cursor: pointer;
  color: white;
  font-weight: 700;
  border: none;
  letter-spacing: 0.03em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  transition: background-color 0.3s ease;
}
#btnShowHideTimer:hover {
  filter: brightness(110%);
}
#btnFullScreen {
  background-color: #8e44ad;       /* violet doux - turquoise/vert */
}
#btnFullScreen:hover {
  filter: brightness(110%);
}
.table-wrap {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  max-height: 114px;  /* 3 lignes strictes */
  max-width: 95vw;
  overflow-y: auto;
  border-radius: 14px;
  border: 1.5px solid #ccc;
  padding: 8px;
  background: #fff;
  user-select: none;
  margin: 0 auto 10px;
  box-shadow: 0 4px 18px rgb(0 0 0 / 0.07);
  justify-content: center;
  flex-shrink: 1;
}
.num {
  border-radius: 12px;
  background: #d2f0d2;
  border: 1.5px solid #84b784; /* slightly thinner border */
  cursor: pointer;
  width: 36px; /* reduced size */
  height: 36px; /* reduced size */
  text-align: center;
  font-size: 1em; /* slightly smaller font */
  user-select: none;
  box-shadow: 0 2px 5px rgb(0 0 0 / 0.13);
  font-weight: 700;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: background-color 0.2s ease, transform 0.15s ease;
}
.num:hover {
  background-color: #b6deb7;
  transform: scale(1.07);
}
.num.selected {
  background-color: #8bc34a;
  color: #fff;
  border-color: #558b2f;
  transform: scale(1.15);
  box-shadow: 0 4px 12px rgb(0 0 0 / 0.25);
}
.num.traited.correct {
  background-color: #0b3d0b;
  color: #d8f5d8;
  cursor: default;
  border-color: #064206;
  text-decoration: line-through;
}
.num.traited.incorrect {
  background-color: #8b1c1c;
  color: #f5d8d8;
  cursor: default;
  border-color: #5e1212;
  text-decoration: line-through;
}
#ayat-box {
  max-width: 90vw; /* reduced width for better centering */
  margin: 0 auto 10px auto; /* margin-bottom for separation */
  background: #f5f5f5;
  border-radius: 16px;
  padding: 18px 20px; /* slightly reduced padding */
  box-shadow: 0 10px 30px rgb(0 0 0 / 0.14);
  font-size: 1.3em;
  line-height: 1.55em;
  direction: rtl;
  text-align: right;
  overflow-y: auto; /* ensure scroll */
  overflow-x: hidden;
  box-sizing: border-box;
  position: relative;
  z-index: 9999;
  max-height: 50em; /* increased height when timer hidden */
  user-select: text;
  display: none;
  flex-shrink: 1;
  scroll-behavior: smooth;
  transition: max-height 0.3s ease;
}
#verse-header {
  font-weight: 700;
  font-size: 0.95em;
  background: #fff9c4;
  padding: 6px 16px;
  border-radius: 12px;
  margin-bottom: 14px;
  box-shadow: inset 0 1px 4px #d2ca5fbb;
  overflow-wrap: break-word;
}
#verse-header .surah-number,
#verse-header .ayah-number {
  color: blue;
}
#verse-text {
  font-size: 1.26em;
  line-height: 1.5em;
  margin-bottom: 16px;
  overflow-y: auto;
  word-break: break-word;
}
.special-red {
  color: red !important;
  font-weight: 700;
}
.special-green {
  color: green !important;
  font-weight: 700;
}
.special-yellow {
  color: orange !important;
  font-weight: 700;
}
.special-blue {
  color: blue !important;
  font-weight: 700;
}
#response-buttons {
  display: flex;
  justify-content: center;
  gap: 24px;
  margin-top: 12px;
  user-select: none;
  flex-wrap: nowrap;
  max-width: 440px;
  margin-left: auto;
  margin-right: auto;
}
#response-buttons button {
  cursor: pointer;
  flex: 1 1 48%;
  font-weight: 700;
  font-size: 0.88em;
  padding: 5px 12px;
  border: none;
  border-radius: 16px;
  color: white;
  background-color: #4caf50;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  transition: background-color 0.2s ease;
  max-height: 34px;
  line-height: 1.1em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#response-buttons button:hover {
  filter: brightness(110%);
}
#btnIncorrect {
  background-color: #d32f2f !important;
}
#btnCorrect::before {
  content: "✔";
  color: #a5e6a5;
  font-weight: 700;
}
#btnIncorrect::before {
  content: "✖";
  color: #f5a8a8;
  font-weight: 700;
}
.counter-box {
  padding: 6px 14px; /* slightly reduced padding */
  border-radius: 16px;
  font-weight: 700;
  text-align: center;
  color: white;
  margin: 2px;
  user-select: none;
  font-size: 0.82em; /* smaller font */
  min-width: 84px; /* reduced min-width */
  flex-shrink: 0;
  white-space: nowrap;
}
.counter-correct {
  background-color: #0b3d0b;
}
.counter-incorrect {
  background-color: #8b1c1c;
}
.counter-remaining {
  background-color: #505050;
}
#fixed-bottom-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100vw;
  background: linear-gradient(90deg, #d9e4b7, #a79d6e);
  border-top: 1.5px solid #8c8c7a;
  box-shadow: 0 -4px 10px rgb(0 0 0 / 0.15);
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0px 2px; /* Reduced from 6px 10px */
  padding: 0px 2px; /* Reduced from 8px 12px */
  z-index: 99999;
  user-select: none;
  align-items: center;
  overflow-x: auto;
}
#fixed-bottom-bar > .counters-row {
  display: flex;
  justify-content: center;
  width: 100%;
  gap: 6px; /* Reduced from 10px */
  flex-wrap: nowrap;
}
/* Adjusted timer container to be slightly smaller and more compact */
#fixed-bottom-bar > #timer-container {
  margin: 0 auto;
  /* margin-top: -4px;
  /* display: flex;
  /* align-items: flex-start;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px; /* Reduced from 6px */
  padding: 2px 4px; /* Reduced from 8px 16px */
  background-color: #8c8c7a;
  border-radius: 10px; /* Reduced from 16px */
  box-shadow: 0 2px 10px rgb(0 0 0 / 0.25);
  color: #f5f5e1;
  font-weight: 700;
  font-size: 0.85em; /* Reduced from 1em */
  text-align: center;
  user-select: none;
  position: relative;
  flex-wrap: nowrap;
  max-width: calc(100vw - 70px);
  box-sizing: border-box;
}
/* Timer container flex layout for arrows and text lines stacked vertically centered */
#timer-container > #arrow-left,
#timer-container > #arrow-right {
  font-size: 2.2em; /* slightly smaller */
  padding: 8px 18px; /* reduced padding */
  font-weight: 900;
  background-color: #7a722c;
  color: #f5f5e1;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  border-radius: 18px;
  user-select: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.25s ease;
  flex-shrink: 0;
  margin-top: 6px;
}
#timer-container > #arrow-left:hover,
#timer-container > #arrow-right:hover {
  background-color: #8e872f;
  color: #f0f0d7;
  transform: scale(1.15);
}
#timer-container > #arrow-up,
#timer-container > #arrow-down {
  font-size: 1.3em; /* slightly smaller */
  padding: 4px 8px; /* reduced padding */
  cursor: pointer;
  background-color: #a79d6e;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.17);
  user-select: none;
  transition: background-color 0.3s ease, transform 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  white-space: nowrap;
  margin-top: 4px;
}
#timer-container > #arrow-up:hover,
#timer-container > #arrow-down:hover {
  background-color: #bcbc9a;
  color: #2e2e1f;
  transform: scale(1.1);
}
#timer-content {
  display: flex;
  flex-direction: column; /* stacked vertically */
  align-items: center;
  justify-content: center;
  gap: 4px; /* reduced gap */
  user-select: none;
  width: 100%;
  text-align: center;
  flex-grow: 1;
  white-space: normal;
  margin: 0 8px;
}
/* ======= Écran des téléphones : LES MESURES : hauteur - largeur - longueur ======= */
@media (max-width: 767px) {
  body {
    font-size: 14px;
  }
  #main-scroll-container {
    padding: 1em 3vw 1.2em;
  }
  .filters-container {
    max-width: 100% !important;
  }
  .selector-wrapper {
    max-width: 32vw;
    min-width: 70px;
  }
  .selector-wrapper.non-arabic {
    max-width: 28vw;
  }
  .selector-wrapper.non-arabic#sourah-wrapper {
    max-width: 25vw;
  }
  .range-wrap {
    max-width: 140px;
  }
  .controls {
    max-width: 100% !important;
    margin-left: 0.25em;
  }
  .controls button {
    min-width: 55px !important;
    font-size: 0.85em;
    padding: 5px 5px !important;
  }
  #btnShowHideTimer {
    max-width: 100% !important;
  }
  .table-wrap {
    max-height: 136px;
    max-width: 100vw;
    padding: 6px 6px;
    overflow-x: auto;
  }
  .num {
    width: 32px;
    height: 32px;
    font-size: 0.9em;
  }
  #ayat-box {
    max-height: 64em;
    padding: 12px 14px;
    font-size: 1.1em;
  }
  #response-buttons {
    max-width: 100%;
  }
  #response-buttons button {
    padding: 5px 8px;
    font-size: 0.8em;
    max-height: 34px;
  }
  .counter-box {
    min-width: 75px;
    padding: 6px 10px;
    font-size: 0.8em;
  }
  #fixed-bottom-bar {
    gap: 4px 6px;
    padding: 5px 6px;
  }
  #fixed-bottom-bar > .counters-row {
    gap: 6px;
  }
  #fixed-bottom-bar > #timer-container {
    max-width: calc(100vw - 70px);
    padding: 8px 12px;
  }
  #timer-content {
    flex-direction: column;
    white-space: normal;
  }
  #timer-start-label, #timer-elapsed-label, #timer-end-label {
    display: block;
    font-weight: 700;
  }
  #timer-content div {
    line-height: 1.3em;
  }
  #timer-container > #arrow-left,
  #timer-container > #arrow-right {
    font-size: 1.8em;
    padding: 6px 14px;
  }
  #timer-container > #arrow-up,
  #timer-container > #arrow-down {
    font-size: 1.1em;
    padding: 3px 6px;
    margin-top: 4px;
    border-radius: 8px;
  }


/* === Bande basse : hauteur fixe ajustée et suppression du débordement === */
#fixed-bottom-bar {
  /* height: 120px !important;       /* Hauteur totale de la barre */
  /* overflow: hidden !important;    /* Coupe tout contenu dépassant */
  padding: 0 !important;          /* Suppression du padding vertical */
  gap: 8px !important;            /* Espacement minimal entre éléments */
  align-items: center !important; /* Centrage vertical du contenu */
}

/* Ajustements pour les compteurs */
#fixed-bottom-bar .counter-box {
  padding: 8px 10px !important;
  font-size: 0.9em !important;
  line-height: 1.6 !important;
}

/* Ajustements pour le timer */
#fixed-bottom-bar #timer-container {
  padding: 0 8px !important;
  font-size: 0.9em !important;
  line-height: 1.2 !important;
}

/* Réduction de la hauteur de la bande basse dynamique */
 #fixed-bottom-bar {
   padding: 2px 4px !important;      /* padding vertical réduit à 2px */
   gap: 4px !important;              /* espacement horizontal minimal */
   align-items: center !important;   /* aligne verticalement au centre */
 }

/* Compteurs (Réponses, Erreurs, Restantes) */
#fixed-bottom-bar .counter-box {
  padding: 2px 6px !important;      /* padding interne réduit */
  font-size: 0.8em !important;      /* texte plus compact */
  line-height: 1.1 !important;      /* hauteur de ligne minimale */
}

/* Chronomètre */
#fixed-bottom-bar #timer-container {
  padding: 2px 10px !important;      /* padding vertical et horizontal réduit */
  font-size: 0.85em !important;     /* taille de texte légèrement petite */
  line-height: 1.1 !important;      /* hauteur de ligne réduite */
  align-self: center !important;    /* centre verticalement dans la barre */
}


/* === Pilotage de l’affichage du timer === */

/* Cache le timer quand la classe hide-timer est ajoutée */
.hide-timer #timer-container {
  display: none !important;
}

/* Ajuste la bande basse quand le timer est masqué */
.hide-timer #fixed-bottom-bar {
  padding: 0 6px !important;
  gap: 12px !important;
}

/* Empêcher le chevauchement entre sélecteurs */
.filters-container {
  gap: 0.1rem !important;        /* Espace suffisant entre tous les filtres */
  flex-wrap: nowrap !important;/* Pas de retour à la ligne */
}

/* Chaque wrapper garde sa taille minimale et ne rétrécit pas */
.selector-wrapper {
  flex: 0 0 auto !important;   /* flex-grow:0, flex-shrink:0, flex-basis:auto */
}

/* Espace spécifique entre langue et sourate */
#language-wrapper {
  margin-right: 0.07rem !important;
}
#sourah-wrapper {
  margin-left: 0.07rem !important;
}

/* Hauteur de la bande basse pour Android et iOS */
.bande-basse {
  height: 80px !important; /* hauteur par défaut (Android, desktop) */
}

body.ios-device .bande-basse {
  height: 50px !important; /* hauteur réduite sur iOS */
padding-bottom: constant(safe-area-inset-bottom);
}

body.ios-device #fixed-bottom-bar {
  height: 50px !important;
}

/* Nouvelle règle forte pour réduire la hauteur de la bande basse */
//body {
  //padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 50px) !important;
//}

//#fixed-bottom-bar {
  //height: calc(50px + env(safe-area-inset-bottom, 0px)) !important;
  //max-height: calc(50px + env(safe-area-inset-bottom, 0px)) !important;
  //padding: 4px 8px !important;
  //overflow: hidden !important;
  //box-sizing: border-box;
//}

//function fixBottomBarHeight() {
  //fixedBar.style.height = '50px';
  //fixedBar.style.maxHeight = '50px';
//}

window.addEventListener('resize', fixBottomBarHeight);
window.addEventListener('scroll', fixBottomBarHeight);

fixBottomBarHeight();

}
/* ======= Écran d'ordinateur et tablette : LES MESURES : hauteur - largeur - longueur ======= */

@media (min-width: 1024px) {
  body {
    font-size: 17px;
  }
  #main-scroll-container {
    padding: 1.5em 6vw 1.5em;
  }
  .filters-container {
    max-width: 720px;
  }
  .selector-wrapper.non-arabic {
    max-width: 9vw;
  }
  .selector-wrapper.non-arabic#sourah-wrapper {
    max-width: 8vw;
  }
  #ayat-box {
    max-height: 42em;
    font-size: 1.3em;
  }
  .counter-box {
    font-size: 0.95em;
    min-width: 100px;
  }
  #fixed-bottom-bar {
    gap: 10px;
    padding: 6px 12px;
  }
  #fixed-bottom-bar > .counters-row {
    gap: 10px;
  }
  #timer-container {
    font-size: 1em;
    padding: 8px 20px;
  }
  #timer-container > #arrow-left,
  #timer-container > #arrow-right {
    font-size: 2.2em;
    padding: 8px 18px;
  }
  #timer-container > #arrow-up,
  #timer-container > #arrow-down {
    font-size: 1.3em;
    padding: 4px 8px;
    margin-top: 4px;
    border-radius: 10px;
  }

/* === Bande basse : hauteur fixe ajustée et suppression du débordement === */
#fixed-bottom-bar {
  /* height: 120px !important;       /* Hauteur totale de la barre */
  /* overflow: hidden !important;    /* Coupe tout contenu dépassant */
  padding: 0 !important;          /* Suppression du padding vertical */
  gap: 8px !important;            /* Espacement minimal entre éléments */
  align-items: center !important; /* Centrage vertical du contenu */
}

/* Ajustements pour les compteurs */
#fixed-bottom-bar .counter-box {
  padding: 8px 10px !important;
  font-size: 0.9em !important;
  line-height: 1.6 !important;
}

/* Ajustements pour le timer */
#fixed-bottom-bar #timer-container {
  padding: 0 8px !important;
  font-size: 0.9em !important;
  line-height: 1.2 !important;
}

/* Réduction de la hauteur de la bande basse dynamique */
 #fixed-bottom-bar {
   padding: 2px 4px !important;      /* padding vertical réduit à 2px */
   gap: 4px !important;              /* espacement horizontal minimal */
   align-items: center !important;   /* aligne verticalement au centre */
 }

/* Compteurs (Réponses, Erreurs, Restantes) */
#fixed-bottom-bar .counter-box {
  padding: 2px 6px !important;      /* padding interne réduit */
  font-size: 0.8em !important;      /* texte plus compact */
  line-height: 1.1 !important;      /* hauteur de ligne minimale */
}

/* Chronomètre */
#fixed-bottom-bar #timer-container {
  padding: 2px 10px !important;      /* padding vertical et horizontal réduit */
  font-size: 0.85em !important;     /* taille de texte légèrement petite */
  line-height: 1.1 !important;      /* hauteur de ligne réduite */
  align-self: center !important;    /* centre verticalement dans la barre */
}


/* === Pilotage de l’affichage du timer === */

/* Cache le timer quand la classe hide-timer est ajoutée */
.hide-timer #timer-container {
  display: none !important;
}

/* Ajuste la bande basse quand le timer est masqué */
.hide-timer #fixed-bottom-bar {
  padding: 0 6px !important;
  gap: 12px !important;
}

/* Empêcher le chevauchement entre sélecteurs */
.filters-container {
  gap: 0.1rem !important;        /* Espace suffisant entre tous les filtres */
  flex-wrap: nowrap !important;/* Pas de retour à la ligne */
}

/* Chaque wrapper garde sa taille minimale et ne rétrécit pas */
.selector-wrapper {
  flex: 0 0 auto !important;   /* flex-grow:0, flex-shrink:0, flex-basis:auto */
}

/* Espace spécifique entre langue et sourate */
#language-wrapper {
  margin-right: 0.07rem !important;
}
#sourah-wrapper {
  margin-left: 0.07rem !important;
}

/* Hauteur de la bande basse pour Android et iOS */
.bande-basse {
  height: 80px !important; /* hauteur par défaut (Android, desktop) */
}

body.ios-device .bande-basse {
  height: 50px !important; /* hauteur réduite sur iOS */
padding-bottom: constant(safe-area-inset-bottom);
}

body.ios-device #fixed-bottom-bar {
  height: 50px !important;
}

/* Nouvelle règle forte pour réduire la hauteur de la bande basse */
//body {
  //padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 50px) !important;
//}

//#fixed-bottom-bar {
  //height: calc(50px + env(safe-area-inset-bottom, 0px)) !important;
  //max-height: calc(50px + env(safe-area-inset-bottom, 0px)) !important;
  //padding: 4px 8px !important;
  //overflow: hidden !important;
  //box-sizing: border-box;
//}

//function fixBottomBarHeight() {
  //fixedBar.style.height = '50px';
  //fixedBar.style.maxHeight = '50px';
//}

window.addEventListener('resize', fixBottomBarHeight);
window.addEventListener('scroll', fixBottomBarHeight);

fixBottomBarHeight();


</style>
</head>
<body>
<div id="main-scroll-container" tabindex="0">
<h1 id="app-title"></h1>
<div class="filters-container" id="selectors" role="region" aria-label="">
  <div class="selector-wrapper" id="language-wrapper">
    <div class="selector-label" id="language-label" aria-live="polite" aria-atomic="true"></div>
    <div class="language-select">
      <select id="language" aria-labelledby="language-label" name="language" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        <option value="ar" data-ar-label="العربية">العربية</option>
        <option value="fr" data-ar-label="الفرنسية">Français</option>
        <option value="en" data-ar-label="الإنجليزية">English</option>
        <option value="es" data-ar-label="الإspagnole">Español</option>
      </select>
    </div>
  </div>
  <div class="selector-wrapper" id="sourah-wrapper">
    <div class="selector-label" id="sourah-label" aria-live="polite" aria-atomic="true"></div>
    <div class="sourah-select">
      <select id="sourah" aria-labelledby="sourah-label" name="sourah" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></select>
    </div>
  </div>
  <div class="selector-wrapper range-wrap" style="flex-direction: row; gap: 12px; max-width: auto; min-width: auto; align-items: center; justify-content: center;">
    <div class="range-input-group">
      <label class="selector-label" id="start-label" for="start" aria-live="polite" aria-atomic="true"></label>
      <input type="number" id="start" min="1" aria-labelledby="start-label" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
    </div>
    <div class="range-input-group">
      <label class="selector-label" id="end-label" for="end" aria-live="polite" aria-atomic="true"></label>
      <input type="number" id="end" min="1" aria-labelledby="end-label" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
    </div>
  </div>
  <div style="flex-direction: column; max-width: 290px; margin-left: 0.5em; margin-right: auto;">
    <div class="controls">
      <button id="btnRedistribuer" type="button"></button>
      <button id="btnTrier" type="button"></button>
      <button id="btnToggle" type="button"></button>
      <button id="btnFullScreen" type="button">Plein écran</button>
    </div>
    <div class="controls" style="margin-top: 2px;">
      <button id="btnShowHideTimer" type="button"></button>
    </div>
  </div>
</div>
<div class="table-wrap" id="ayahs-container" role="region" aria-label=""></div>
<div id="ayat-box" style="display:none;" role="region" aria-live="polite" aria-atomic="true" tabindex="0">
  <div id="verse-header"></div>
  <div id="verse-text"></div>
  <div id="response-buttons" role="group" aria-label="">
    <button id="btnCorrect" type="button"></button>
    <button id="btnIncorrect" type="button"></button>
  </div>
</div>
</div>
<div id="fixed-bottom-bar" aria-live="polite" aria-atomic="true">
  <div class="counters-row">
    <div class="counter-box counter-correct" style="flex:1;">
      <span id="label-correct"></span> <span id="correct-count">0</span>
    </div>
    <div class="counter-box counter-incorrect" style="flex:1;">
      <span id="label-incorrect"></span> <span id="incorrect-count">0</span>
    </div>
    <div class="counter-box counter-remaining" style="flex:none; min-width:144px; text-align:center;">
      <span id="label-remaining"></span> <span id="remaining-count">0</span> / <span id="total-count">0</span>
    </div>
  </div>
  <div id="timer-container" aria-live="polite" aria-atomic="true" role="group" aria-label="Contrôles du chronomètre">
    <div id="arrow-left" class="timer-arrow" role="button" aria-label="Verset précédent" tabindex="0">←</div>
    <div id="arrow-up" class="arrow-vertical" role="button" aria-label="Versets vers le haut" tabindex="0">↑</div>
    <div id="timer-content">
      <div><strong id="timer-start-label"></strong> <span id="start-time-display">--:--:--</span></div>
      <div><strong id="timer-elapsed-label"></strong> <span id="elapsed-time-display">00:00:00</span></div>
      <div><strong id="timer-end-label"></strong> <span id="timer-end-time">--:--:--</span></div>
    </div>
    <div id="arrow-down" class="arrow-vertical" role="button" aria-label="Versets vers le bas" tabindex="0">↓</div>
    <div id="arrow-right" class="timer-arrow" role="button" aria-label="Verset suivant" tabindex="0">→</div>
  </div>
</div>
<div id="timer-end" style="display:none; flex:none; min-width:280px; margin:0 auto 0 auto;">
  <span></span><span id="end-time-display"></span>
</div>
<script>

// Détection iOS
if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
  document.body.classList.add('ios-device');
}

(() => {
  const STORAGE_KEY = 'quranQuizState_v1';
  const texts = {
    ar: {
      title: "اختبار آيات القرآن المتقدم",
      languageLabel: "اللغة",
      sourahLabel: "السورة",
      startLabel: "بداية",
      endLabel: "نهاية",
      redistribuer: "إعادة التوزيع",
      trier: "ترتيب",
      toggle: "إظهار / إخفاء",
      correct: "إجابة صحيحة",
      incorrect: "إجابة خاطئة",
      labelCorrect: "الإجابات",
      labelIncorrect: "الأخطاء",
      labelRemaining: "المتبقي",
      surahPrefix: "سورة",
      ayahPrefix: "آية",
      timerStart: "البداية:",
      timerElapsed: "الوقت المنقضي:",
      timerEnd: "النهاية:",
      showHideTimerOn: "إخفاء المؤقت",
      showHideTimerOff: "إظهار المؤقت"
    },
    fr: {
      title: "Quiz Versets Coran Avancé",
      languageLabel: "Langue",
      sourahLabel: "Sourate",
      startLabel: "Début",
      endLabel: "Fin",
      redistribuer: "Redistribuer",
      trier: "Trier",
      toggle: "Afficher / Cacher",
      correct: "Bonne réponse",
      incorrect: "Mauvaise réponse",
      labelCorrect: "Réponses",
      labelIncorrect: "Erreurs",
      labelRemaining: "Restantes",
      surahPrefix: "Sourate",
      ayahPrefix: "Verset",
      timerStart: "Début:",
      timerElapsed: "Temps écoulé:",
      timerEnd: "Fin:",
      showHideTimerOn: "Masquer le chronomètre",
      showHideTimerOff: "Afficher le chronomètre"
    },
    en: {
      title: "Advanced Quran Quiz",
      languageLabel: "Language",
      sourahLabel: "Surah",
      startLabel: "Start",
      endLabel: "End",
      redistribuer: "Shuffle",
      trier: "Sort",
      toggle: "Show / Hide",
      correct: "Correct",
      incorrect: "Incorrect",
      labelCorrect: "Correct",
      labelIncorrect: "Errors",
      labelRemaining: "Remaining",
      surahPrefix: "Surah",
      ayahPrefix: "Ayah",
      timerStart: "Start:",
      timerElapsed: "Elapsed:",
      timerEnd: "End:",
      showHideTimerOn: "Hide timer",
      showHideTimerOff: "Show timer"
    },
    es: {
      title: "Quiz Avanzado del Corán",
      languageLabel: "Idioma",
      sourahLabel: "Sura",
      startLabel: "Inicio",
      endLabel: "Fin",
      redistribuer: "Barajar",
      trier: "Ordenar",
      toggle: "Mostrar / Ocultar",
      correct: "Correcto",
      incorrect: "Incorrecto",
      labelCorrect: "Correctos",
      labelIncorrect: "Errores",
      labelRemaining: "Restantes",
      surahPrefix: "Sura",
      ayahPrefix: "Verso",
      timerStart: "Inicio:",
      timerElapsed: "Transcurrido:",
      timerEnd: "Fin:",
      showHideTimerOn: "Ocultar temporizador",
      showHideTimerOff: "Mostrar temporizador"
    }
  };
  const SURAHS = [
    { number:1, names:{ar:"الفاتحة",fr:"Al-Fatiha",en:"Al-Fatiha",es:"Al-Fatiha"}, count:7 },
    { number:2, names:{ar:"البقرة",fr:"Al-Baqara",en:"Al-Baqara",es:"Al-Baqara"}, count:286 },
    { number:7, names:{ar:"الأعراف",fr:"Al-A'raf",en:"Al-A'raf",es:"Al-A'raf"}, count:206 },
    { number:95, names:{ar:"التين",fr:"At-Tin",en:"At-Tin",es:"At-Tin"}, count:8 }
  ];
  const BISMILLAH = "بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ";
  const languageEl = document.getElementById("language");
  const sourahEl = document.getElementById("sourah");
  const startEl = document.getElementById("start");
  const endEl = document.getElementById("end");
  const ayahsContainer = document.getElementById("ayahs-container");
  const ayatBox = document.getElementById("ayat-box");
  const verseHeader = document.getElementById("verse-header");
  const verseText = document.getElementById("verse-text");
  const btnCorrect = document.getElementById("btnCorrect");
  const btnIncorrect = document.getElementById("btnIncorrect");
  const btnRedistribuer = document.getElementById("btnRedistribuer");
  const btnTrier = document.getElementById("btnTrier");
  const btnToggle = document.getElementById("btnToggle");
  const btnShowHideTimer = document.getElementById("btnShowHideTimer");
  const countCorrect = document.getElementById("correct-count");
  const countIncorrect = document.getElementById("incorrect-count");
  const countRemaining = document.getElementById("remaining-count");
  const countTotal = document.getElementById("total-count");
  const labelCorrect = countCorrect.previousElementSibling;
  const labelIncorrect = countIncorrect.previousElementSibling;
  const labelRemaining = countRemaining.previousElementSibling;
  const labelLanguage = document.getElementById("language-label");
  const labelSourah = document.getElementById("sourah-label");
  const labelStart = document.getElementById("start-label");
  const labelEnd = document.getElementById("end-label");
  const timerStartDisplay = document.getElementById("start-time-display");
  const timerElapsedDisplay = document.getElementById("elapsed-time-display");
  const timerEndDisplay = document.getElementById("timer-end-time");
  const timerEndBox = document.getElementById("timer-end");
  const endTimeDisplay = document.getElementById("end-time-display");
  const arrowLeft = document.getElementById('arrow-left');
  const arrowRight = document.getElementById('arrow-right');
  const arrowUp = document.getElementById('arrow-up');
  const arrowDown = document.getElementById('arrow-down');
  let ayahs = [];
  let traitedMap = new Map();
  let currentAyah = null;
  let currentSourah = null;
  let correctCountValue = 0;
  let incorrectCountValue = 0;
  let showTreated = true;
  let startTime = null;
  let endTime = null;
  let elapsedTime = 0;
  let timerInterval = null;
  let lastUpdateTime = null;
  let verseCache = new Map();
  let selectedNumDiv = null;
  let pageVisible = true;
  let wasPageHidden = false;
  let timerVisible = true;
  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      ayahs, traitedMap: Array.from(traitedMap.entries()),
      currentAyah, currentSourah,
      correctCountValue, incorrectCountValue, showTreated,
      startTime, endTime, elapsedTime,
      selectedNumIndex: selectedNumDiv ? [...ayahsContainer.children].indexOf(selectedNumDiv) : null,
      language: languageEl.value, sourah: sourahEl.value,
      start: startEl.value, end: endEl.value,
      timerVisible
    }));
  }
  function loadState() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return false;
    try {
      const state = JSON.parse(saved);
      languageEl.value = state.language || 'ar';
      populateSourahOptions();
      sourahEl.value = state.sourah || '1';
      setTexts(languageEl.value);
      updateLanguageFilterLabels(languageEl.value);
      populateSourahOptions();
      updateLimits(false);
      startEl.value = state.start || 1;
      endEl.value = state.end || 1;
      traitedMap = Array.isArray(state.traitedMap) ? new Map(state.traitedMap) : new Map();
      ayahs = Array.isArray(state.ayahs) ? state.ayahs : [];
      correctCountValue = state.correctCountValue || 0;
      incorrectCountValue = state.incorrectCountValue || 0;
      showTreated = typeof state.showTreated === "boolean" ? state.showTreated : true;
      startTime = typeof state.startTime === 'number' && state.startTime > 0 ? state.startTime : null;
      endTime = typeof state.endTime === 'number' && state.endTime > 0 ? state.endTime : null;
      elapsedTime = typeof state.elapsedTime === 'number' ? state.elapsedTime : 0;
      timerVisible = typeof state.timerVisible === 'boolean' ? state.timerVisible : true;
      updateCounts();
      setTimerVisibility(timerVisible,false);
      renderAyahs();
      if(state.selectedNumIndex !== null && state.selectedNumIndex >= 0 && state.selectedNumIndex < ayahsContainer.children.length) {
        setSelectedNum(ayahsContainer.children[state.selectedNumIndex], false);
        if(currentAyah === null && ayahs[state.selectedNumIndex] !== undefined) {
          showAyah(ayahs[state.selectedNumIndex]);
        }
      }
      updateTimerDisplay();
      if (startTime && !endTime) {
        resumeTimer();
      } else {
        stopTimer(true);
      }
      return true;
    } catch {
      return false;
    }
  }
  function updateTimerDisplay() {
    timerStartDisplay.textContent = startTime ? new Date(startTime).toLocaleString() : '--:--:--';
    timerElapsedDisplay.textContent = formatTime(elapsedTime);
    if (endTime && startTime) {
      timerEndBox.style.display = 'block';
      endTimeDisplay.textContent = new Date(endTime).toLocaleString();
      timerEndDisplay.textContent = new Date(endTime).toLocaleString();
    } else {
      timerEndBox.style.display = 'none';
      endTimeDisplay.textContent = '--:--:--';
      timerEndDisplay.textContent = '--:--:--';
    }
  }
  function setTexts(lang) {
    const t = texts[lang];
    document.title = t.title;
    document.getElementById("app-title").textContent = t.title;
    labelLanguage.textContent = t.languageLabel;
    labelSourah.textContent = t.sourahLabel;
    labelStart.textContent = t.startLabel;
    labelEnd.textContent = t.endLabel;
    btnRedistribuer.textContent = t.redistribuer;
    btnTrier.textContent = t.trier;
    btnToggle.textContent = t.toggle;
    btnCorrect.textContent = t.correct;
    btnIncorrect.textContent = t.incorrect;
    labelCorrect.textContent = t.labelCorrect;
    labelIncorrect.textContent = t.labelIncorrect;
    labelRemaining.textContent = t.labelRemaining;
    timerStartDisplay.previousElementSibling.textContent = t.timerStart;
    timerElapsedDisplay.previousElementSibling.textContent = t.timerElapsed;
    timerEndDisplay.previousElementSibling.textContent = t.timerEnd;
    timerEndDisplay.previousElementSibling.id = "timer-end-label";
    updateButtonShowHideTimerText();
    updateDirection(lang);
  }
  function updateButtonShowHideTimerText(){
    const lang = languageEl.value;
    const textKey = timerVisible ? 'showHideTimerOn' : 'showHideTimerOff';
    btnShowHideTimer.textContent = texts[lang][textKey] || texts['fr'][textKey];
  }
  function updateDirection(lang) {
    const rtl = lang === "ar";
    document.documentElement.dir = rtl ? "rtl" : "ltr";
    const wrappers = [document.getElementById('language-wrapper'), document.getElementById('sourah-wrapper')];
    if(rtl){
      wrappers.forEach(w => w.classList.remove('non-arabic'));
      const sourahWrapper = document.getElementById('sourah-wrapper');
      if(sourahWrapper){
        sourahWrapper.style.maxWidth = '14vw';
        sourahWrapper.style.marginLeft = '';
        sourahWrapper.style.marginRight = '8px';
      }
    } else {
      wrappers.forEach(w => w.classList.add('non-arabic'));
      const sourahWrapper = document.getElementById('sourah-wrapper');
      if(sourahWrapper){
        sourahWrapper.style.maxWidth = '8vw';
        sourahWrapper.style.marginRight = '';
        sourahWrapper.style.marginLeft = '8px';
      }
    }
    document.body.classList.toggle('rtl', rtl);
  }
  function updateLanguageFilterLabels(lang) {
    if(lang === 'ar') {
      languageEl.options[0].textContent = 'العربية';
      languageEl.options[1].textContent = 'الفرنسية';
      languageEl.options[2].textContent = 'الإنجليزية';
      languageEl.options[3].textContent = 'الإسبانية';
    } else {
      languageEl.options[0].textContent = 'العربية';
      languageEl.options[1].textContent = 'Français';
      languageEl.options[2].textContent = 'English';
      languageEl.options[3].textContent = 'Español';
    }
    updateButtonShowHideTimerText();
  }
  function populateSourahOptions() {
  // Mémoriser la valeur sélectionnée avant de vider la liste
  const selectedBefore = sourahEl.value;
  sourahEl.innerHTML = '';
  const lang = languageEl.value;
  for (const s of SURAHS) {
    const opt = document.createElement('option');
    opt.value = s.number;
    opt.textContent = (lang === 'ar')
      ? `${s.number} – ${s.names.ar}`
      : `${s.number} – ${s.names.fr}`;
    sourahEl.appendChild(opt);
  }
  // Réappliquer la sélection précédente si possible
  if ([...sourahEl.options].some(o => o.value === selectedBefore)) {
    sourahEl.value = selectedBefore;
  }
}
  function updateLimits(reinit = true) {
    const s = SURAHS.find(x => x.number == sourahEl.value);
    if (!s) return;
    startEl.min = 1; startEl.max = s.count;
    endEl.min = 1; endEl.max = s.count;
    if (reinit) {
      startEl.value = 1;
      endEl.value = s.count;
    } else {
      if (startEl.value < 1) startEl.value = 1;
      if (startEl.value > s.count) startEl.value = s.count;
      if (endEl.value < 1) endEl.value = 1;
      if (endEl.value > s.count) endEl.value = s.count;
    }
  }
  function validateRange() {
    let s = SURAHS.find(x => x.number == sourahEl.value);
    if (!s) return false;
    let start = Number(startEl.value);
    let end = Number(endEl.value);
    if (isNaN(start) || start < 1) start = 1;
    if (isNaN(end) || end < 1) end = 1;
    if (start > s.count) start = s.count;
    if (end > s.count) end = s.count;
    if (start > end) start = end;
    startEl.value = start;
    endEl.value = end;
    return true;
  }
  function shuffleAyahs(save = true) {
    if (!validateRange()) return;
    ayahs = [];
    let start = Number(startEl.value);
    let end = Number(endEl.value);
    for (let i = start; i <= end; i++) {
      ayahs.push(i);
    }
    for (let i = ayahs.length - 1; i > 0; i--) {
      let j = Math.floor(Math.random() * (i + 1));
      [ayahs[i], ayahs[j]] = [ayahs[j], ayahs[i]];
    }
    traitedMap.clear();
    correctCountValue = 0;
    incorrectCountValue = 0;
    verseCache.clear();
    currentAyah = null;
    currentSourah = null;
    resetTimer(true);
    updateCounts();
    renderAyahs();
    clearVerseDetails();
    clearSelectedNum(false);
    if(save) saveState();
  }
  function renderAyahs() {
    ayahsContainer.innerHTML = '';
    for (const num of ayahs) {
      if (traitedMap.has(num) && !showTreated) continue;
      let div = document.createElement('div');
      div.textContent = num;
      div.classList.add('num');
      div.tabIndex = 0;
      if (traitedMap.get(num) === true) div.classList.add('traited', 'correct');
      else if (traitedMap.get(num) === false) div.classList.add('traited', 'incorrect');
      else {
        div.onclick = () => {
          if(!startTime){
            startTimer();
          }
          showAyah(num);
          resumeTimer();
          setSelectedNum(div);
          div.focus();
          ayatBox.scrollTop = 0;
        };
        div.ontouchstart = () => {
          if(!startTime){
            startTimer();
          }
          setSelectedNum(div);
          div.focus();
          ayatBox.scrollTop = 0;
        };
      }
      ayahsContainer.appendChild(div);
    }
    updateCounts();
    saveState();
    checkIfQuizFinished();
  }

    function scrollToCenter(element) {
  element.scrollIntoView({
    behavior: 'smooth',
    block: 'center',   // centre verticalement l'élément si possible
    inline: 'nearest'  // comportement horizontal (ne pas décaler)
  });
}


  function setSelectedNum(div, showAyahFlag = true) {
    if (selectedNumDiv) selectedNumDiv.classList.remove('selected');
    selectedNumDiv = div;
    if (selectedNumDiv) selectedNumDiv.classList.add('selected');

    setTimeout(() => {
    scrollToCenter(selectedNumDiv);
    }, 10); // Petit délai avant scroll

    if(showAyahFlag && selectedNumDiv) {
      const ayahNum = Number(selectedNumDiv.textContent);
      const surahNo = Number(sourahEl.value);
      const surahData = SURAHS.find(s => s.number === surahNo);
      if (surahData && ayahNum >=1 && ayahNum <= surahData.count) {
        showAyah(ayahNum);
        if(!startTime) startTimer();
        resumeTimer();
        ayatBox.scrollTop = 0;
      } else {
        verseText.textContent = 'Verset hors limites.';
        verseHeader.textContent = '';
      }
    }
    saveState();
  }
  function clearSelectedNum(save = true) {
    if (selectedNumDiv) {
      selectedNumDiv.classList.remove('selected');
      selectedNumDiv = null;
      if(save) saveState();
    }
  }
  function updateCounts() {
    correctCountValue = [...traitedMap.values()].filter(v => v === true).length;
    incorrectCountValue = [...traitedMap.values()].filter(v => v === false).length;
    countCorrect.textContent = correctCountValue;
    countIncorrect.textContent = incorrectCountValue;
    countRemaining.textContent = ayahs.length - traitedMap.size;
    countTotal.textContent = ayahs.length;
  }
  function checkIfQuizFinished(){
    if (ayahs.length > 0 && traitedMap.size === ayahs.length && startTime && !endTime) {
      endTime = Date.now();
      stopTimer(false);
      saveState();
    }
    updateTimerDisplay();
  }
    async function fetchVerseWithFallback(surah, ayah, lang) {
    const surahData = SURAHS.find(s => s.number == surah);
    if (!surahData || ayah < 1 || ayah > surahData.count) {
      throw new Error('Verse number out of range');
    }
    const key = `${surah}:${ayah}:${lang}`;
    if (verseCache.has(key)) return verseCache.get(key);

    // Sources à tester
    const attempts = [
      // Source principale
      { url: `https://api.alquran.cloud/v1/ayah/${surah}:${ayah}/ar.alafasy`, extractor: data => data.data?.text?.trim() },
      // Source alternative 1
      { url: `https://alquran-api.pages.dev/ayah/${surah}/${ayah}`, extractor: data => data.text?.trim() },
      // Source alternative 2
      { url: `https://tanzil.net/versebyverse.php?chapter=${surah}&verse=${ayah}&mode=json`, extractor: data => data.verse?.text_uthmani?.trim() }
    ];


    let lastErr;
    for (const src of attempts) {
      try {
        const res = await fetch(src.url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        const txt = src.extractor(json);
        if (!txt) throw new Error('No text in response');
        verseCache.set(key, txt);
        return txt;
      } catch (err) {
        lastErr = err;
        console.warn('fallback attempt failed', src.url, err);
      }
    }
    throw new Error('All sources failed: ' + lastErr);
  }
  async function showAyah(num) {
    if (!num) return;
    const surahNo = Number(sourahEl.value);
    const surahData = SURAHS.find(s => s.number == surahNo);
    if (!surahData || num < 1 || num > surahData.count) {
      verseText.textContent = 'Verset hors limites.';
      verseHeader.textContent = '';
      return;
    }
    currentAyah = num;
    currentSourah = sourahEl.value;
    ayatBox.style.display = 'block';
    const key = `${currentSourah}:${currentAyah}:ar`;
    if (verseCache.has(key)) {
      verseText.innerHTML = verseCache.get(key);
      updateHeader();
      ayatBox.scrollTop = 0;
      return;
    }
    verseText.textContent = 'Chargement...';
    try {
      let txt = await fetchVerseWithFallback(currentSourah, currentAyah, 'ar');
      if (surahNo === 95 && currentAyah === 1) {
        const bismillahRegex = new RegExp('^\\s*بِّسْمِ\\s*ٱللَّهِ\\s*ٱلرَّحْمَٰنِ\\s*ٱلرَّحِيمِ\\s*', 'u');
        txt = txt.replace(bismillahRegex, '').trim();
      } else if (surahNo === 1) {
      } else if (surahNo === 9) {
      } else {
        const bismillahRegex = new RegExp('^\\s*بِسْمِ\\s*ٱللَّهِ\\s*ٱلرَّحْمَٰنِ\\s*ٱلرَّحِيمِ\\s*', 'u');
        if (num !== 27 || (num === 27 && currentAyah === 30)) {
          txt = txt.replace(bismillahRegex, '').trim();
        }
      }
      let colored = colorVerseText(txt);
      verseText.innerHTML = `<div>${colored}</div>`;
      verseCache.set(key, verseText.innerHTML);
      updateHeader();
      ayatBox.scrollTop = 0;
    } catch {
      verseText.textContent = 'Erreur lors du chargement du verset.';
    }
    if (!startTime) startTimer();
  }
  function updateHeader() {
    if (currentSourah && currentAyah) {
      const lang = languageEl.value;
      const t = texts[lang] || texts.fr;
      verseHeader.innerHTML = `${t.surahPrefix} <span class="surah-number" style="color:blue;">${currentSourah}</span>, ${t.ayahPrefix} <span class="ayah-number" style="color:blue;">${currentAyah}</span>`;
    } else {
      verseHeader.textContent = '';
    }
  }
  function colorVerseText(text) {
    if (!text) return '';
    const specialSigns = ["ۚ", "ۗ", "ۖ", "ۘ", "ۛ"];
    const normalSigns = ["۞", "۩"];
    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&apos;' })[m]);
    }
    let escaped = escapeHtml(text);
    let symbolYellowSpan = '';
    const symbolReg = new RegExp(escapeHtml("۞"), 'g');
    if (symbolReg.test(escaped)) {
      symbolYellowSpan = '<span class="special-yellow">۞</span> ';
      escaped = escaped.replace(symbolReg, '');
    }
    for (const s of specialSigns) {
      const esc = escapeHtml(s);
      escaped = escaped.replace(new RegExp(esc, 'gu'), `<span class="special-red">${esc}</span>`);
    }
    for (const s of normalSigns) {
      if (s === "۞") continue;
      const esc = escapeHtml(s);
      escaped = escaped.replace(new RegExp(esc, 'gu'), `<span class="special-blue">${esc}</span>`);
    }
    let match = escaped.match(/(<span class="special-blue">۩<\/span>)$/);
    let endSymbol = "";
    if (match) {
      escaped = escaped.replace(/(<span class="special-blue">۩<\/span>)$/, "").trim();
      endSymbol = match[1];
    }
    const tmpDiv = document.createElement('div');
    tmpDiv.innerHTML = escaped;
    for (const sp of tmpDiv.querySelectorAll('span.special-red, span.special-yellow, span.special-blue')) {
      sp.replaceWith(document.createTextNode(sp.textContent));
    }
    const cleanText = tmpDiv.textContent.trim();
    if (!cleanText) return symbolYellowSpan + escaped + (endSymbol ? " " + endSymbol : '');
    const plainWords = cleanText.split(/\s+/);
    const tokens = escaped.split(/(\s+)/);
    let firstIdx = -1;
    let lastIdx = -1;
    let wordCounter = 0;
    for (let i = 0; i < tokens.length; i++) {
      const plainToken = tokens[i].replace(/<[^>]+>/g, '').trim();
      if (plainToken === '') continue;
      if (wordCounter >= plainWords.length) break;
      if (tokens[i].includes(plainWords[wordCounter])) {
        if (firstIdx === -1) firstIdx = i;
        lastIdx = i;
        wordCounter++;
      }
    }
    if (firstIdx !== -1) tokens[firstIdx] = `<span class="special-red">${tokens[firstIdx]}</span>`;
    if (lastIdx !== -1 && lastIdx !== firstIdx) tokens[lastIdx] = `<span class="special-green">${tokens[lastIdx]}</span>`;
    return symbolYellowSpan + tokens.join('') + (endSymbol ? " " + endSymbol : '');
  }
  function registerAnswer(correct) {
    if (currentAyah == null) return;
    if (!traitedMap.has(currentAyah)) {
      traitedMap.set(currentAyah, correct);
      if (correct) correctCountValue++;
      else incorrectCountValue++;
      updateCounts();
      renderAyahs();
      // Modified: Do not hide the ayatBox after registering answer
      // Just update the current selection to still show the verse
      // clearVerseDetails(); // removed to keep display
      saveState();
      checkIfQuizFinished();

      // Sélectionner la case suivante (Pourque ça fonctionne supprime // du code (que les titres non))
      // const currentIndex = [...ayahsContainer.children].findIndex(child => child.textContent == currentAyah);
      // const nextIndex = currentIndex + 1;
      // if (nextIndex < ayahsContainer.children.length) {
      // setSelectedNum(ayahsContainer.children[nextIndex], false);
     // }

      // Sélectionner la case même de la grille sans passer à la suivante.
      const currentIndex = [...ayahsContainer.children].findIndex(child => child.textContent == currentAyah);
      if (currentIndex >= 0 && currentIndex < ayahsContainer.children.length) {
      setSelectedNum(ayahsContainer.children[currentIndex], false);
     }

    }
  }
  function toggleTreated() {
    showTreated = !showTreated;
    renderAyahs();
    saveState();
  }
  function sortAyahs() {
    ayahs.sort((a, b) => a - b);
    renderAyahs();
    saveState();
  }
  function resetTimer(resetElapsed) {
    clearInterval(timerInterval);
    timerInterval = null;
    elapsedTime = resetElapsed ? 0 : elapsedTime;
    startTime = null;
    endTime = null;
    lastUpdateTime = null;
    pageVisible = true;
    wasPageHidden = false;
    updateTimerDisplay();
    saveState();
  }
  function startTimer() {
    if(startTime) return;
    startTime = Date.now();
    elapsedTime = 0;
    lastUpdateTime = Date.now();
    timerInterval = setInterval(updateElapsedTime,500);
    updateTimerDisplay();
    saveState();
  }
  function stopTimer(manualStop) {
    if (!startTime || endTime) return;
    clearInterval(timerInterval);
    timerInterval = null;
    endTime = Date.now();
    updateTimerDisplay();
    saveState();
  }
  function resumeTimer() {
    if (startTime && !endTime && !timerInterval) {
      lastUpdateTime = Date.now();
      timerInterval = setInterval(updateElapsedTime, 500);
    }
  }
  function updateElapsedTime() {
    if (!startTime || endTime) return;
    const now = Date.now();
    elapsedTime += now - lastUpdateTime;
    lastUpdateTime = now;
    timerElapsedDisplay.textContent = formatTime(elapsedTime);
    saveState();
  }
  function formatTime(ms) {
    ms = Math.max(0, ms);
    const sec = Math.floor(ms / 1000);
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    return `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
  }
  function clearVerseDetails() {
    currentAyah = null;
    currentSourah = null;
    ayatBox.style.display = 'none';
    verseHeader.textContent = '';
    verseText.textContent = '';
    clearSelectedNum(false);
  }
  function handleKeyNavigation(e) {
    if (!selectedNumDiv) return;
    const key = e.key;
    const children = [...ayahsContainer.children];
    if (children.length === 0) return;
    const index = children.indexOf(selectedNumDiv);
    if (index === -1) return;
    if (!['ArrowRight', 'ArrowLeft', 'ArrowDown', 'ArrowUp'].includes(key)) return;
    e.preventDefault();
    let newIndex = index;
    const elementTops = children.map(c => c.offsetTop);
    const currentRowTop = selectedNumDiv.offsetTop;
    const indexesSameRow = children
      .map((c, i) => (elementTops[i] === currentRowTop ? i : -1))
      .filter(i => i !== -1);
    const colIndex = indexesSameRow.indexOf(index);
    const uniqueRowTops = [...new Set(elementTops)].sort((a,b) => a-b);
    const currentRowNumber = uniqueRowTops.indexOf(currentRowTop);
    const isRTL = languageEl.value === "ar";
    switch(key) {
      case 'ArrowRight':
        if (isRTL) {
          if (index > 0) newIndex = index - 1;
        } else {
          if (index < children.length -1) newIndex = index +1;
        }
        break;
      case 'ArrowLeft':
        if (isRTL) {
          if (index < children.length -1) newIndex = index + 1;
        } else {
          if (index > 0) newIndex = index -1;
        }
        break;
      case 'ArrowDown': {
        const nextRowNumber = currentRowNumber + 1;
        if (nextRowNumber < uniqueRowTops.length) {
          const nextRowTop = uniqueRowTops[nextRowNumber];
          const nextRowIndexes = children
            .map((c, i) => (elementTops[i] === nextRowTop ? i : -1))
            .filter(i => i !== -1);
          if (colIndex < nextRowIndexes.length) {
            newIndex = nextRowIndexes[colIndex];
          } else {
            newIndex = nextRowIndexes[nextRowIndexes.length -1];
          }
        } else {
          newIndex = index;
        }
        break;
      }
      case 'ArrowUp': {
        const prevRowNumber = currentRowNumber - 1;
        if (prevRowNumber >= 0) {
          const prevRowTop = uniqueRowTops[prevRowNumber];
          const prevRowIndexes = children
            .map((c, i) => (elementTops[i] === prevRowTop ? i : -1))
            .filter(i => i !== -1);
          if (colIndex < prevRowIndexes.length) {
            newIndex = prevRowIndexes[colIndex];
          } else {
            newIndex = prevRowIndexes[prevRowIndexes.length -1];
          }
        } else {
          newIndex = index;
        }
        break;
      }
    }
    if(newIndex !== index) {
      setSelectedNum(children[newIndex]);
      children[newIndex].focus();
    }
  }
  function moveToPreviousAyah() {
    if (!selectedNumDiv) return;
    const children = [...ayahsContainer.children];
    if (children.length === 0) return;
    const index = children.indexOf(selectedNumDiv);
    if (index === -1) return;
    let newIndex;
    if (languageEl.value === 'ar') {
      newIndex = (index + 1) % children.length;
    } else {
      newIndex = (index - 1 + children.length) % children.length;
    }
    setSelectedNum(children[newIndex]);
    children[newIndex].focus();
  }
  function moveToNextAyah() {
    if (!selectedNumDiv) return;
    const children = [...ayahsContainer.children];
    if (children.length === 0) return;
    const index = children.indexOf(selectedNumDiv);
    if (index === -1) return;
    let newIndex;
    if (languageEl.value === 'ar') {
      newIndex = (index - 1 + children.length) % children.length;
    } else {
      newIndex = (index + 1) % children.length;
    }
    setSelectedNum(children[newIndex]);
    children[newIndex].focus();
  }
  function moveToFirstAyahBelow() {
    if (!selectedNumDiv) return;
    const children = [...ayahsContainer.children];
    if (children.length === 0) return;
    const index = children.indexOf(selectedNumDiv);
    if (index === -1) return;
    const elementTops = children.map(c => c.offsetTop);
    const currentRowTop = selectedNumDiv.offsetTop;
    const uniqueRowTops = [...new Set(elementTops)].sort((a,b) => a-b);
    const currentRowNumber = uniqueRowTops.indexOf(currentRowTop);
    const nextRowNumber = currentRowNumber + 1;
    if (nextRowNumber < uniqueRowTops.length) {
      const nextRowTop = uniqueRowTops[nextRowNumber];
      const nextRowIndexes = children
        .map((c, i) => (elementTops[i] === nextRowTop ? i : -1))
        .filter(i => i !== -1);
      let indexesCurrentRow = children
        .map((c,i) => (elementTops[i] === currentRowTop ? i : -1))
        .filter(i => i !== -1);
      const colInRow = indexesCurrentRow.indexOf(index);
      let targetIndex = (colInRow < nextRowIndexes.length) ? nextRowIndexes[colInRow] : nextRowIndexes[nextRowIndexes.length - 1];
      if (targetIndex !== undefined) {
        setSelectedNum(children[targetIndex]);
        children[targetIndex].focus();
      }
    }
  }
  function moveToLastAyahAbove() {
    if (!selectedNumDiv) return;
    const children = [...ayahsContainer.children];
    if (children.length === 0) return;
    const index = children.indexOf(selectedNumDiv);
    if (index === -1) return;
    const elementTops = children.map(c => c.offsetTop);
    const currentRowTop = selectedNumDiv.offsetTop;
    const uniqueRowTops = [...new Set(elementTops)].sort((a,b) => a-b);
    const currentRowNumber = uniqueRowTops.indexOf(currentRowTop);
    const prevRowNumber = currentRowNumber - 1;
    if (prevRowNumber >= 0) {
      const prevRowTop = uniqueRowTops[prevRowNumber];
      const prevRowIndexes = children
        .map((c, i) => (elementTops[i] === prevRowTop ? i : -1))
        .filter(i => i !== -1);
      let indexesCurrentRow = children
        .map((c,i) => (elementTops[i] === currentRowTop ? i : -1))
        .filter(i => i !== -1);
      const colInRow = indexesCurrentRow.indexOf(index);
      let targetIndex = (colInRow < prevRowIndexes.length) ? prevRowIndexes[colInRow] : prevRowIndexes[prevRowIndexes.length - 1];
      if (targetIndex !== undefined) {
        setSelectedNum(children[targetIndex]);
        children[targetIndex].focus();
      }
    }
  }
  // Setup continuous navigation on long press for arrows
  function setupLongPressContinuous(el, moveFunc) {
    let timerId = null;
    let isLongPress = false;
    const intervalDelay = 150; // ms between repeated calls
    const startAction = () => {
      if (timerId) return;
      isLongPress = false;
      timerId = setTimeout(() => {
        isLongPress = true;
        timerId = setInterval(() => {
          moveFunc();
        }, intervalDelay);
      }, 400);
    };
    const stopAction = () => {
      if(timerId) {
        clearTimeout(timerId);
        clearInterval(timerId);
        timerId = null;
      }
      isLongPress = false;
    };
    el.addEventListener('mousedown', (e) => {
      e.preventDefault();
      startAction();
    });
    el.addEventListener('touchstart', (e) => {
      e.preventDefault();
      startAction();
    }, {passive:false});
    el.addEventListener('mouseup', (e) => {
      e.preventDefault();
      if(!isLongPress) moveFunc();
      stopAction();
    });
    el.addEventListener('mouseleave', (e) => {
      stopAction();
    });
    el.addEventListener('touchend', (e) => {
      e.preventDefault();
      if(!isLongPress) moveFunc();
      stopAction();
    });
    el.addEventListener('touchcancel', (e) => {
      e.preventDefault();
      stopAction();
    });
  }
  function initLongPressScrolling() {
    setupLongPressContinuous(arrowLeft, moveToPreviousAyah);
    setupLongPressContinuous(arrowRight, moveToNextAyah);
    setupLongPressContinuous(arrowUp, moveToLastAyahAbove);
    setupLongPressContinuous(arrowDown, moveToFirstAyahBelow);
  }
  arrowLeft.removeEventListener('click', moveToPreviousAyah);
  arrowRight.removeEventListener('click', moveToNextAyah);
  arrowDown.removeEventListener('click', moveToFirstAyahBelow);
  arrowUp.removeEventListener('click', moveToLastAyahAbove);
  arrowLeft.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      moveToPreviousAyah();
    }
  });
  arrowRight.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      moveToNextAyah();
    }
  });
  arrowDown.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      moveToFirstAyahBelow();
    }
  });
  arrowUp.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      moveToLastAyahAbove();
    }
  });
  initLongPressScrolling();
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      pageVisible = false;
      wasPageHidden = true;
      clearInterval(timerInterval);
      timerInterval = null;
    } else {
      pageVisible = true;
      if (startTime && !endTime && traitedMap.size < ayahs.length) {
        resumeTimer();
      }
    }
  });
  btnShowHideTimer.addEventListener('click', () => {
    setTimerVisibility(!timerVisible,true);
  });
  function setTimerVisibility(visible, save = true){
  timerVisible = visible;
  const timerContainer = document.getElementById('timer-container');
  if(timerVisible){
    timerContainer.style.display = 'flex';
    ayahsContainer.style.maxHeight = '140px';  // grillette 3 lignes max
    ayatBox.style.maxHeight = '52em';
  } else {
    timerContainer.style.display = 'none';
    ayahsContainer.style.maxHeight = '140px';  // grillette 3 lignes max
    ayatBox.style.maxHeight = '44em';
  }
  updateButtonShowHideTimerText();
  if(save) saveState();
}
  languageEl.addEventListener('change', () => {
    setTexts(languageEl.value);
    updateLanguageFilterLabels(languageEl.value);
    populateSourahOptions();
    updateLimits(true);
    shuffleAyahs();
    resetTimer(true);
    clearVerseDetails();
    saveState();
  });
  sourahEl.addEventListener('change', () => {
    updateLimits(true);
    shuffleAyahs();
    resetTimer(true);
    clearVerseDetails();
    clearSelectedNum(false);
    saveState();
  });
  startEl.addEventListener('input', () => { if(validateRange()) shuffleAyahs(); });
  endEl.addEventListener('input', () => { if(validateRange()) shuffleAyahs(); });
  btnRedistribuer.addEventListener('click', () => { shuffleAyahs(); resetTimer(true); });
  btnTrier.addEventListener('click', sortAyahs);
  btnToggle.addEventListener('click', toggleTreated);
  btnCorrect.addEventListener('click', () => registerAnswer(true));
  btnIncorrect.addEventListener('click', () => registerAnswer(false));
  window.addEventListener('beforeunload', () => {
    if (startTime && !endTime) {
      saveState();
    }
  });
  let wakeLock = null;
  async function requestWakeLock() {
    if ('wakeLock' in navigator) {
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', requestWakeLock);
      } catch (err) {
        setTimeout(requestWakeLock, 15000);
      }
    }
  }
  requestWakeLock();
  ['visibilitychange', 'click', 'touchstart', 'keydown'].forEach(evt => {
    document.addEventListener(evt, () => {
      if (!wakeLock) requestWakeLock();
    });
  });
  document.addEventListener('keydown', (e) => {
    if(['ArrowRight','ArrowLeft','ArrowDown','ArrowUp'].includes(e.key)) {
      const focused = document.activeElement;
      if (ayahsContainer.contains(focused) || focused.classList.contains('num') || selectedNumDiv) {
        handleKeyNavigation(e);
      }
    }
  });
  document.addEventListener('DOMContentLoaded', () => {
  populateSourahOptions();
  loadState();
  // Charger la liste de sourates AVANT tout
  populateSourahOptions();
  
  if (!loadState()) {
    languageEl.value = 'ar';
    setTexts('ar');
    updateLanguageFilterLabels('ar');
    // NE PAS rappeler populateSourahOptions() ici
    sourahEl.value = '1';
    updateLimits(true);
    shuffleAyahs();
  } else {
    // Après chargement de l’état, réappliquer la valeur enregistrée
    sourahEl.value = sourahEl.value;  // déclenche ni reinitialisation ni vidage
    updateLimits(false);
    renderAyahs();
  }
});
})();
function toggleFullScreen() {
  const doc = window.document;
  const docEl = doc.documentElement;
  const isFull = !!(doc.fullscreenElement || doc.mozFullScreenElement || doc.webkitFullscreenElement || doc.msFullscreenElement);
  if (!isFull) {
    const request = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullscreen || docEl.msRequestFullscreen;
    if (request) request.call(docEl);
  } else {
    const exit = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;
    if (exit) exit.call(doc);
  }
}

// Liaison avec le bouton
document.getElementById('btnFullScreen').addEventListener('click', toggleFullScreen);

</script>
</body>
</html>
