<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Versets Coran Avancé</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 8px 12px;
    max-width: 620px;
    font-size: 15px;
    background-color: #f7fff7;
    color: #244d24;
  }
  h1 {
    font-size: 1.5em;
    text-align: center;
    margin-bottom: 16px;
  }
  label {
    font-weight: bold;
    margin-right: 8px;
  }
  select, input[type=number] {
    font-size: 14px;
    margin: 6px 12px 6px 0;
    padding: 5px 10px;
    border-radius: 4px;
    border: 1px solid #7cbea4;
    min-width: 100px;
  }
  #ayah-container {
    margin: 16px 0;
    padding: 10px;
    background-color: #e6f0e6;
    border-radius: 6px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    max-height: 180px;
    overflow-y: auto;
    user-select: none;
  }
  .num {
    cursor: pointer;
    min-width: 34px;
    padding: 8px 12px;
    background: #a7d4a2;
    border: 2px solid #6a996d;
    border-radius: 5px;
    font-weight: 600;
    text-align: center;
    transition: background 0.3s, border-color 0.3s;
  }
  .num:hover {
    background-color: #79b170;
  }
  .num.traited.correct {
    background-color: #3a6b31;
    border-color: #1f3f19;
    color: #cff6c1;
    cursor: default;
    text-decoration: line-through;
  }
  .num.traited.incorrect {
    background-color: #7a211f;
    border-color: #4e1a1a;
    color: #f7c9c8;
    cursor: default;
    text-decoration: line-through;
  }
  #display-ayat {
    border: 2px solid #68a355;
    border-radius: 8px;
    padding: 16px 20px;
    margin-bottom: 16px;
    background-color: #d9f0d7;
    font-size: 18px;
    line-height: 1.45;
    direction: rtl;
    text-align: right;
    min-height: 140px;
    user-select: text;
  }
  #display-ayat-header {
    font-weight: bold;
    color: #256625;
    margin-bottom: 8px;
    font-size: 1.2em;
  }
  #controls {
    display: flex;
    justify-content: center;
    gap: 14px;
    margin-bottom: 16px;
  }
  button {
    background-color: #6caf75;
    border: none;
    border-radius: 6px;
    padding: 10px 18px;
    color: white;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }
  button:hover {
    background-color: #519251;
  }
  #counters {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-bottom: 10px;
    font-weight: 700;
    user-select: none;
  }
  .counter-box {
    background-color: #459945;
    border-radius: 8px;
    padding: 10px 18px;
    color: white;
    text-align: center;
    min-width: 120px;
  }
  .counter-box.incorrect {
    background-color: #8b2f2f;
  }
  .counter-box.remaining {
    background-color: #4a904a;
  }
  @media (max-width: 480px) {
    #ayah-container {
      max-height: 140px;
      gap: 6px;
    }
    .num {
      min-width: 28px;
      padding: 6px 10px;
      font-size: 13px;
    }
    #display-ayat {
      font-size: 16px;
      min-height: 110px;
      padding: 14px 16px;
    }
  }
</style>
</head>
<body>
<h1>اختبار آيات القرآن الكريم</h1>

<div>
  <label for="language">اللغة :</label>
  <select id="language">
    <option value="ar">العربية</option>
    <option value="fr">Français</option>
    <option value="en">English</option>
    <option value="es">Español</option>
  </select>

  <label for="sourah">السورة :</label>
  <select id="sourah"></select>

  <label for="start">بداية :</label>
  <input type="number" id="start" min="1" />
  <label for="end">نهاية :</label>
  <input type="number" id="end" min="1" />
</div>

<div id="controls">
  <button id="btn-redistribute">Redistribuer</button>
  <button id="btn-sort">Trier</button>
  <button id="btn-toggle-treated">Afficher/Cacher traités</button>
</div>

<div id="counters">
  <div class="counter-box correct">Réponses : <span id="count-correct">0</span></div>
  <div class="counter-box incorrect">Erreurs : <span id="count-error">0</span></div>
  <div class="counter-box remaining">Restantes : <span id="count-remaining">0</span></div>
</div>

<div id="ayah-container"></div>

<div id="display-ayat" style="display: none;">
  <div id="display-ayat-header"></div>
  <div id="display-ayat-text"></div>
  <div style="text-align: center; margin-top: 12px;">
    <button id="btn-correct">✔️ Correct</button>
    <button id="btn-incorrect">❌ Incorrect</button>
  </div>
</div>

<script>
(() => {
  const SURAHS = [
    { number:1, name:"الفاتحة", count:7 },
    { number:2, name:"البقرة", count:286 },
    { number:3, name:"آل عمران", count:200 },
    { number:4, name:"النساء", count:176 },
    { number:5, name:"المائدة", count:120 },
    { number:6, name:"الأنعام", count:165 },
    { number:7, name:"الأعراف", count:206 },
    { number:8, name:"الأنفال", count:75 },
    { number:9, name:"التوبة", count:129 },
    { number:10, name:"يونس", count:109 },
    /* ... Ajouter toutes les sourates ici ... */
    { number:114, name:"الناس", count:6 }
  ];

  const languageEl = document.getElementById("language");
  const sourahEl = document.getElementById("sourah");
  const startEl = document.getElementById("start");
  const endEl = document.getElementById("end");
  const ayahContainer = document.getElementById("ayah-container");
  const displayAyat = document.getElementById("display-ayat");
  const displayHeader = document.getElementById("display-ayat-header");
  const displayText = document.getElementById("display-ayat-text");
  const countCorrect = document.getElementById("count-correct");
  const countError = document.getElementById("count-error");
  const countRemaining = document.getElementById("count-remaining");
  const btnRedistribute = document.getElementById("btn-redistribute");
  const btnSort = document.getElementById("btn-sort");
  const btnToggleTreated = document.getElementById("btn-toggle-treated");
  const btnCorrect = document.getElementById("btn-correct");
  const btnIncorrect = document.getElementById("btn-incorrect");

  let ayahNumbers = [];
  let traitedMap = new Map();
  let currentAyah = null;
  let currentSourah = null;
  let correctCount = 0;
  let errorCount = 0;
  let showTreated = true;

  function populateSourahs() {
    sourahEl.innerHTML = "";
    SURAHS.forEach(s => {
      let opt = document.createElement("option");
      opt.value = s.number;
      opt.textContent = `${s.number} - ${s.name}`;
      sourahEl.appendChild(opt);
    });
  }

  function updateRange() {
    const s = SURAHS.find(x => x.number == sourahEl.value);
    if (!s) return;
    startEl.min = 1; startEl.max = s.count; startEl.value = 1;
    endEl.min = 1; endEl.max = s.count; endEl.value = s.count;
  }

  function validateRange() {
    const s = SURAHS.find(x => x.number == sourahEl.value);
    if (!s) return false;
    if (startEl.value < 1 || startEl.value > s.count) startEl.value = 1;
    if (endEl.value < 1 || endEl.value > s.count) endEl.value = s.count;
    if (+startEl.value > +endEl.value) startEl.value = endEl.value;
    return true;
  }

  function generateAyahNumbers() {
    if (!validateRange()) return false;
    ayahNumbers = [];
    for(let i = +startEl.value; i <= +endEl.value; i++) {
      ayahNumbers.push(i);
    }
    return true;
  }

  function shuffle(array) {
    for(let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function shuffleAyahs() {
    if(!generateAyahNumbers()) return;
    shuffle(ayahNumbers);
    traitedMap.clear();
    correctCount = 0; errorCount = 0; currentAyah = null;
    displayAyat.style.display = 'none';
    renderAyahs();
    updateCounters();
    saveProgress();
  }

  function sortAyahs() {
    ayahNumbers.sort((a, b) => a - b);
    renderAyahs();
  }

  function renderAyahs() {
    ayahContainer.innerHTML = "";
    ayahNumbers.forEach(num => {
      if (!showTreated && traitedMap.has(num)) return;
      let div = document.createElement("div");
      div.className = "num";
      div.textContent = num;
      if (traitedMap.has(num)) {
        div.classList.add("traited");
        div.classList.add(traitedMap.get(num) ? "correct" : "incorrect");
      } else {
        div.onclick = () => showAyah(num);
      }
      ayahContainer.appendChild(div);
    });
    updateCounters();
  }

  function updateCounters() {
    countCorrect.textContent = correctCount;
    countError.textContent = errorCount;
    countRemaining.textContent = ayahNumbers.length - traitedMap.size;
  }

  function showAyah(num) {
    currentAyah = num;
    currentSourah = sourahEl.value;
    displayHeader.textContent = `Sourate ${currentSourah} - Verset ${num}`;
    displayText.textContent = "Chargement du verset...";
    displayAyat.style.display = "block";

    fetch(`https://api.alquran.cloud/v1/ayah/${currentSourah}:${num}/ar.alafasy`)
      .then(res => res.json())
      .then(data => {
        if(data.code === 200 && data.data && data.data.text) {
          displayText.textContent = data.data.text;
        } else {
          displayText.textContent = "Erreur lors du chargement du verset.";
        }
      })
      .catch(() => displayText.textContent = "Erreur réseau");
  }

  function registerResponse(isCorrect) {
    if(currentAyah === null) return;
    if(traitedMap.has(currentAyah)) return;
    traitedMap.set(currentAyah, isCorrect);
    if(isCorrect) correctCount++; else errorCount++;
    updateCounters();
    renderAyahs();
    displayAyat.style.display = "none";
    currentAyah = null;
    if(traitedMap.size === ayahNumbers.length) {
      alert("Quiz terminé !");
      // Ici vous pouvez arrêter le chrono si implémenté
    }
    saveProgress();
  }

  function saveProgress() {
    const data = {
      sourah: sourahEl.value,
      start: startEl.value,
      end: endEl.value,
      ayahNumbers,
      traited: Array.from(traitedMap.entries()),
      correctCount,
      errorCount
    };
    localStorage.setItem('quran_quiz_progress', JSON.stringify(data));
  }

  function loadProgress() {
    const raw = localStorage.getItem('quran_quiz_progress');
    if(!raw) return false;
    try {
      const data = JSON.parse(raw);
      if(data.sourah) sourahEl.value = data.sourah;
      if(data.start) startEl.value = data.start;
      if(data.end) endEl.value = data.end;
      ayahNumbers = data.ayahNumbers || [];
      traitedMap = new Map(data.traited || []);
      correctCount = data.correctCount || 0;
      errorCount = data.errorCount || 0;
      return true;
    } catch {
      return false;
    }
  }

  // Écouteurs événements
  languageEl.onchange = () => {
    alert("Language change not yet implemented, please reload with desired language.");
  };

  sourahEl.onchange = () => {
    updateRange();
    shuffleAyahs();
    // reset chrono si implémenté
  };

  startEl.onchange = () => { if(validateRange()) shuffleAyahs(); };
  endEl.onchange = () => { if(validateRange()) shuffleAyahs(); };

  btnRedistribute.onclick = shuffleAyahs;
  btnSort.onclick = sortAyahs;
  btnToggleTreated.onclick = () => {
    showTreated = !showTreated;
    renderAyahs();
  };
  btnCorrect.onclick = () => registerResponse(true);
  btnIncorrect.onclick = () => registerResponse(false);

  // Initialisation
  populateSourahs();
  languageEl.value = "ar";
  updateRange();
  if(!loadProgress()) shuffleAyahs();
  else {
    renderAyahs();
    updateCounters();
  }

})();
</script>

</body>
</html>
