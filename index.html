<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Versets Coran Avancé</title>
<style>
/* (Même CSS que dans la version précédente, conservé pour la lisibilité, n’hésitez pas à me redemander si besoin) */
body { font-family: Arial, sans-serif; margin: 5px; max-width: 100%; padding: 0 5px; font-size: 14px; }
h1 { font-size: 1.2em; text-align: center; margin-bottom: 6px; }
label, select, input { font-size: 0.9em; margin: 0 4px 6px 0; }
input[type=number] { width: 50px; }
.range-wrap { display: flex; gap: 6px; align-items: center; }
.rtl-range { direction: rtl; }
.controls { margin-bottom: 8px; display: flex; gap: 6px; flex-wrap: nowrap; }
button { padding: 4px 8px; font-size: 0.9em; cursor: pointer; }
.table-wrap { display: flex; flex-wrap: wrap; gap: 6px; max-height: 160px; overflow-y: auto; border: 1px solid #ccc; padding: 4px; background: #fafafa; user-select: none; }
.num { border-radius: 5px; padding: 6px 10px; background: #d2f0d2; border: 1px solid #84b784; cursor: pointer; transition: background-color 0.3s; min-width: 36px; text-align: center; font-size: 0.95em; }
.num.traited.correct { background-color: #0b3d0b; color: #d8f5d8; cursor: default; border-color: #064206; text-decoration: line-through; }
.num.traited.incorrect { background-color: #8b1c1c; color: #f5d8d8; cursor: default; border-color: #5e1212; text-decoration: line-through; }
#ayat-box { position: fixed; bottom: 10px; left: 10px; right: 10px; background: #f5f5f5; border-radius: 8px; padding: 10px 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); max-height: 22em; font-size: 1.2em; line-height: 1.4em; direction: rtl; text-align: right; display: none; overflow-y: visible; z-index: 1000; }
#verse-header { font-weight: 600; font-size: 1.1em; margin-bottom: 6px; }
#verse-text { max-height: 15em; overflow-y: auto; font-size: 1.2em; line-height: 1.4em; margin-bottom: 8px; }
#response-buttons { margin-top: 6px; display: flex; justify-content: space-between; gap: 8px; }
#response-buttons button { flex: 1; font-size: 1.1em; padding: 10px 0; line-height: 1.3em; }
#counters { display: flex; gap: 10px; margin-top: 14px; font-size: 1em; font-weight: 600; flex-wrap: wrap; justify-content: center; }
.counter-box { padding: 8px 14px; border-radius: 5px; color: white; flex: 1 1 130px; text-align: center; }
.correct-box { background-color: #0b3d0b; }
.incorrect-box { background-color: #8b1c1c; }
.remaining-box { background-color: #505050; }
.verset-red { color: red; font-weight: bold; }
.verset-green { color: green; font-weight: bold; }
.verset-blue { color: blue; font-weight: bold; }
.verset-yellow { color: orange; font-weight: bold; }
.number-blue { color: blue; font-weight: bold; }
@media (max-width: 400px) {
  body { font-size: 13px; }
  #ayat-box { max-height: 24em; font-size: 1.3em; padding: 12px 14px; overflow-y: visible; }
  #verse-text { max-height: 17em; font-size: 1.3em; }
  #response-buttons button { padding: 12px 0; font-size: 1.2em; }
  .table-wrap { max-height: 140px; }
  .num { padding: 6px 10px; min-width: 34px; font-size: 1em; }
  #counters { font-size: 1.1em; }
}
</style>
</head>
<body>

<h1 id="app-title">اختبار آيات القرآن المتقدم</h1>

<label for="language" id="label-language">اللغة :</label>
<select id="language">
  <option value="ar">العربية</option>
  <option value="fr">Français</option>
  <option value="en">English</option>
  <option value="es">Español</option>
</select>

<label for="sourah" id="label-sourah">السورة :</label>
<select id="sourah"></select>

<div id="range-wrap" class="range-wrap">
  <label for="start" id="label-start">بداية :</label>
  <input type="number" id="start" min="1" />
  <label for="end" id="label-end">نهاية :</label>
  <input type="number" id="end" min="1" />
</div>

<div class="controls">
  <button id="btnRedistribuer">إعادة التوزيع</button>
  <button id="btnTrier">ترتيب</button>
  <button id="btnToggleTraites">إظهار / إخفاء المعالَجَة</button>
</div>

<div class="table-wrap" id="ayah-numbers"></div>

<div id="ayat-box" style="display:none;">
  <div id="verse-header"></div>
  <div id="verse-text"></div>
  <div id="response-buttons">
    <button id="btnCorrect">إجابة صحيحة</button>
    <button id="btnIncorrect">إجابة خاطئة</button>
  </div>
</div>

<div id="counters">
  <div class="counter-box correct-box"><span id="label-correctCount">الإجابات الصحيحة :</span> <span id="correct-count">0</span></div>
  <div class="counter-box incorrect-box"><span id="label-errorCount">الأخطاء :</span> <span id="error-count">0</span></div>
  <div class="counter-box remaining-box"><span id="label-remainingCount">المتبقية :</span> <span id="remaining-count">0</span> / <span id="total-count">0</span></div>
</div>

<script>
(() => {
  const SURAHS = [
    {number:1, name_ar:"الفاتحة", name_fr:"Al-Fatiha", count:7},
    {number:2, name_ar:"البقرة", name_fr:"Al-Baqara", count:286},
    {number:3, name_ar:"آل عمران", name_fr:"Al-i-Imran", count:200},
    {number:4, name_ar:"النساء", name_fr:"An-Nisa", count:176},
    {number:5, name_ar:"المائدة", name_fr:"Al-Ma'ida", count:120},
    {number:6, name_ar:"الأنعام", name_fr:"Al-An'am", count:165},
    {number:7, name_ar:"الأعراف", name_fr:"Al-A'raf", count:206},
    {number:8, name_ar:"الأنفال", name_fr:"Al-Anfal", count:75},
    {number:9, name_ar:"التوبة", name_fr:"At-Tawba", count:129},
    {number:10, name_ar:"يونس", name_fr:"Yunus", count:109},
    {number:11, name_ar:"هود", name_fr:"Hud", count:123},
    {number:12, name_ar:"يوسف", name_fr:"Yusuf", count:111},
    {number:13, name_ar:"الرعد", name_fr:"Ar-Ra'd", count:43},
    {number:14, name_ar:"إبراهيم", name_fr:"Ibrahim", count:52},
    {number:15, name_ar:"الحجر", name_fr:"Al-Hijr", count:99},
    {number:16, name_ar:"النحل", name_fr:"An-Nahl", count:128},
    {number:17, name_ar:"الإسراء", name_fr:"Al-Isra", count:111},
    {number:18, name_ar:"الكهف", name_fr:"Al-Kahf", count:110},
    {number:19, name_ar:"مريم", name_fr:"Maryam", count:98},
    {number:20, name_ar:"طه", name_fr:"Ta-Ha", count:135},
    {number:21, name_ar:"الأنبياء", name_fr:"Al-Anbiya", count:112},
    {number:22, name_ar:"الحج", name_fr:"Al-Hajj", count:78},
    {number:23, name_ar:"المؤمنون", name_fr:"Al-Mu'minun", count:118},
    {number:24, name_ar:"النور", name_fr:"An-Nur", count:64},
    {number:25, name_ar:"الفرقان", name_fr:"Al-Furqan", count:77},
    {number:26, name_ar:"الشعراء", name_fr:"Ash-Shu'ara", count:227},
    {number:27, name_ar:"النمل", name_fr:"An-Naml", count:93},
    {number:28, name_ar:"القصص", name_fr:"Al-Qasas", count:88},
    {number:29, name_ar:"العنكبوت", name_fr:"Al-Ankabut", count:69},
    {number:30, name_ar:"الروم", name_fr:"Ar-Rum", count:60},
    {number:31, name_ar:"لقمان", name_fr:"Luqman", count:34},
    {number:32, name_ar:"السجدة", name_fr:"As-Sajda", count:30},
    {number:33, name_ar:"الأحزاب", name_fr:"Al-Ahzab", count:73},
    {number:34, name_ar:"سبأ", name_fr:"Saba", count:54},
    {number:35, name_ar:"فاطر", name_fr:"Fatir", count:45},
    {number:36, name_ar:"يس", name_fr:"Ya-Sin", count:83},
    {number:37, name_ar:"الصافات", name_fr:"As-Saffat", count:182},
    {number:38, name_ar:"ص", name_fr:"Sad", count:88},
    {number:39, name_ar:"الزمر", name_fr:"Az-Zumar", count:75},
    {number:40, name_ar:"غافر", name_fr:"Ghafir", count:85},
    {number:41, name_ar:"فصلت", name_fr:"Fussilat", count:54},
    {number:42, name_ar:"الشورى", name_fr:"Ash-Shura", count:53},
    {number:43, name_ar:"الزخرف", name_fr:"Az-Zukhruf", count:89},
    {number:44, name_ar:"الدخان", name_fr:"Ad-Dukhan", count:59},
    {number:45, name_ar:"الجاثية", name_fr:"Al-Jathiya", count:37},
    {number:46, name_ar:"الأحقاف", name_fr:"Al-Ahqaf", count:35},
    {number:47, name_ar:"محمد", name_fr:"Muhammad", count:38},
    {number:48, name_ar:"الفتح", name_fr:"Al-Fath", count:29},
    {number:49, name_ar:"الحجرات", name_fr:"Al-Hujurat", count:18},
    {number:50, name_ar:"ق", name_fr:"Qaf", count:45},
    {number:51, name_ar:"الذاريات", name_fr:"Adh-Dhariyat", count:60},
    {number:52, name_ar:"الطور", name_fr:"At-Tur", count:49},
    {number:53, name_ar:"النجم", name_fr:"An-Najm", count:62},
    {number:54, name_ar:"القمر", name_fr:"Al-Qamar", count:55},
    {number:55, name_ar:"الرحمن", name_fr:"Ar-Rahman", count:78},
    {number:56, name_ar:"الواقعة", name_fr:"Al-Waqia", count:96},
    {number:57, name_ar:"الحديد", name_fr:"Al-Hadid", count:29},
    {number:58, name_ar:"المجادلة", name_fr:"Al-Mujadila", count:22},
    {number:59, name_ar:"الحشر", name_fr:"Al-Hashr", count:24},
    {number:60, name_ar:"الممتحنة", name_fr:"Al-Mumtahina", count:13},
    {number:61, name_ar:"الصف", name_fr:"As-Saff", count:14},
    {number:62, name_ar:"الجمعة", name_fr:"Al-Jumu'a", count:11},
    {number:63, name_ar:"المنافقون", name_fr:"Al-Munafiqoon", count:11},
    {number:64, name_ar:"التغابن", name_fr:"At-Taghabun", count:18},
    {number:65, name_ar:"الطلاق", name_fr:"At-Talaq", count:12},
    {number:66, name_ar:"التحريم", name_fr:"At-Tahrim", count:12},
    {number:67, name_ar:"الملك", name_fr:"Al-Mulk", count:30},
    {number:68, name_ar:"القلم", name_fr:"Al-Qalam", count:52},
    {number:69, name_ar:"الحاقة", name_fr:"Al-Haqqah", count:52},
    {number:70, name_ar:"المعارج", name_fr:"Al-Ma'arij", count:44},
    {number:71, name_ar:"نوح", name_fr:"Nuh", count:28},
    {number:72, name_ar:"الجن", name_fr:"Al-Jinn", count:28},
    {number:73, name_ar:"المزّمّل", name_fr:"Al-Muzzammil", count:20},
    {number:74, name_ar:"المدّثر", name_fr:"Al-Muddaththir", count:56},
    {number:75, name_ar:"القيامة", name_fr:"Al-Qiyama", count:40},
    {number:76, name_ar:"الإنسان", name_fr:"Al-Insan", count:31},
    {number:77, name_ar:"المرسلات", name_fr:"Al-Mursalat", count:50},
    {number:78, name_ar:"النبأ", name_fr:"An-Naba", count:40},
    {number:79, name_ar:"النازعات", name_fr:"An-Nazi'at", count:46},
    {number:80, name_ar:"عبس", name_fr:"Abasa", count:42},
    {number:81, name_ar:"التكوير", name_fr:"At-Takwir", count:29},
    {number:82, name_ar:"الإنفطار", name_fr:"Al-Infitar", count:19},
    {number:83, name_ar:"المطفّفين", name_fr:"Al-Mutaffifin", count:36},
    {number:84, name_ar:"الإنشقاق", name_fr:"Al-Inshiqaq", count:25},
    {number:85, name_ar:"البروج", name_fr:"Al-Buruj", count:22},
    {number:86, name_ar:"الطارق", name_fr:"At-Tariq", count:17},
    {number:87, name_ar:"الأعلى", name_fr:"Al-A'la", count:19},
    {number:88, name_ar:"الغاشية", name_fr:"Al-Ghashiya", count:26},
    {number:89, name_ar:"الفجر", name_fr:"Al-Fajr", count:30},
    {number:90, name_ar:"البلد", name_fr:"Al-Balad", count:20},
    {number:91, name_ar:"الشمس", name_fr:"Ash-Shams", count:15},
    {number:92, name_ar:"الليل", name_fr:"Al-Lail", count:21},
    {number:93, name_ar:"الضحى", name_fr:"Ad-Dhuha", count:11},
    {number:94, name_ar:"الإنشراح", name_fr:"Al-Inshirah", count:8},
    {number:95, name_ar:"التين", name_fr:"At-Tin", count:8},
    {number:96, name_ar:"العلق", name_fr:"Al-Alaq", count:19},
    {number:97, name_ar:"القدر", name_fr:"Al-Qadr", count:5},
    {number:98, name_ar:"البينة", name_fr:"Al-Bayyina", count:8},
    {number:99, name_ar:"الزلزلة", name_fr:"Az-Zalzala", count:8},
    {number:100, name_ar:"العاديات", name_fr:"Al-Adiyat", count:11},
    {number:101, name_ar:"القارعة", name_fr:"Al-Qaria", count:11},
    {number:102, name_ar:"التكاثر", name_fr:"At-Takathur", count:8},
    {number:103, name_ar:"العصر", name_fr:"Al-Asr", count:3},
    {number:104, name_ar:"الهمزة", name_fr:"Al-Humaza", count:9},
    {number:105, name_ar:"الفيل", name_fr:"Al-Fil", count:5},
    {number:106, name_ar:"قريش", name_fr:"Quraysh", count:4},
    {number:107, name_ar:"الماعون", name_fr:"Al-Maun", count:7},
    {number:108, name_ar:"الكوثر", name_fr:"Al-Kawthar", count:3},
    {number:109, name_ar:"الكافرون", name_fr:"Al-Kafirun", count:6},
    {number:110, name_ar:"النصر", name_fr:"An-Nasr", count:3},
    {number:111, name_ar:"المسد", name_fr:"Al-Masad", count:5},
    {number:112, name_ar:"الإخلاص", name_fr:"Al-Ikhlas", count:4},
    {number:113, name_ar:"الفلق", name_fr:"Al-Falaq", count:5},
    {number:114, name_ar:"الناس", name_fr:"An-Nas", count:6}
  ];

  let ayahNumbers = [];
  let traitedMap = new Map();
  let showTreated = true;
  let currentAyah = null;
  let currentSourah = null;
  let correctCount = 0;
  let errorCount = 0;
  let verseCache = new Map();

  const STORAGE_KEY = "quranQuizProgress";

  // DOM Elements
  const languageEl = document.getElementById("language");
  const sourahEl = document.getElementById("sourah");
  const startEl = document.getElementById("start");
  const endEl = document.getElementById("end");
  const ayahContainer = document.getElementById("ayah-numbers");
  const ayatBox = document.getElementById("ayat-box");
  const verseTextEl = document.getElementById("verse-text");
  const verseHeaderEl = document.getElementById("verse-header");
  const correctEl = document.getElementById("correct-count");
  const errorEl = document.getElementById("error-count");
  const remainingEl = document.getElementById("remaining-count");
  const totalEl = document.getElementById("total-count");

  const startTimeEl = document.getElementById("start-time");
  const elapsedTimeEl = document.getElementById("elapsed-time");
  const totalTimeEl = document.getElementById("total-time");

  // Timer variables and functions…
  let startTime = null;
  let elapsedTime = 0;
  let timerInterval = null;
  let quizRunning = false;
  let quizFinished = false;

  function formatTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const h = Math.floor(totalSeconds / 3600).toString().padStart(2,'0');
    const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2,'0');
    const s = (totalSeconds % 60).toString().padStart(2,'0');
    return `${h}:${m}:${s}`;
  }

  function updateElapsed() {
    if (startTime) {
      elapsedTime = Date.now() - startTime;
      elapsedTimeEl.textContent = formatTime(elapsedTime);
    }
  }

  function startTimer() {
    if (quizRunning || quizFinished) return;
    startTime = Date.now();
    startTimeEl.textContent = new Date(startTime).toLocaleString();
    timerInterval = setInterval(updateElapsed, 500);
    quizRunning = true;
  }

  function pauseTimer() {
    if(!quizRunning) return;
    clearInterval(timerInterval);
    updateElapsed();
    quizRunning = false;
  }

  function resumeTimer() {
    if(quizRunning || quizFinished) return;
    startTime = Date.now() - elapsedTime;
    timerInterval = setInterval(updateElapsed, 500);
    quizRunning = true;
  }

  function stopTimer() {
    if(timerInterval) clearInterval(timerInterval);
    updateElapsed();
    quizRunning = false;
    quizFinished = true;
    totalTimeEl.textContent = formatTime(elapsedTime);
  }

  // Handle page visibility for pause/resume timer
  document.addEventListener("visibilitychange", () => {
    if(quizRunning) {
      document.hidden ? pauseTimer() : resumeTimer();
    }
  });

  // Translation texts omitted here for brevity; import your texts object as before...

  function saveProgress() {
    const data = {
      sourah: sourahEl.value,
      start: startEl.value,
      end: endEl.value,
      ayahNumbers,
      traited: Array.from(traitedMap.entries()),
      correctCount,
      errorCount,
      startTime: startTime ? startTime : null,
      elapsedTime,
      quizRunning,
      quizFinished
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function loadProgress() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    try {
      const data = JSON.parse(raw);
      sourahEl.value = data.sourah;
      startEl.value = data.start;
      endEl.value = data.end;
      ayahNumbers = Array.isArray(data.ayahNumbers) ? data.ayahNumbers : [];
      traitedMap = new Map(data.traited || []);
      correctCount = data.correctCount || 0;
      errorCount = data.errorCount || 0;
      startTime = data.startTime;
      elapsedTime = data.elapsedTime || 0;
      quizRunning = data.quizRunning || false;
      quizFinished = data.quizFinished || false;
      updateRange();
      renderAyahs();
      updateCounters();
      if (startTime) startTimeEl.textContent = new Date(startTime).toLocaleString();
      if (quizRunning) timerInterval = setInterval(updateElapsed, 500);
      else elapsedTimeEl.textContent = formatTime(elapsedTime);
      if (quizFinished) totalTimeEl.textContent = formatTime(elapsedTime);
      return true;
    } catch {
      return false;
    }
  }

  function clearProgress() {
    localStorage.removeItem(STORAGE_KEY);
  }

  // Other functions (renderAyahs, showAyah, registerResponse, etc.) with logic exactly as before, 
  // making sure in renderAyahs() the click handler is : div.onclick = () => showAyah(num);

  // populateSourates, updateRange, validateInputs, shuffleAyahs, sortAyahs, toggleTreated, updateCounters, colorVerseText

  // Initialization
  populateSourates();
  languageEl.value = "ar";
  updateInterfaceTexts("ar");
  if (!loadProgress()) shuffleAyahs();

  languageEl.addEventListener("change", e => updateInterfaceTexts(e.target.value));
  sourahEl.addEventListener("change", () => { updateRange(); shuffleAyahs(); });
  startEl.addEventListener("input", validateInputs);
  endEl.addEventListener("input", validateInputs);
  startEl.addEventListener("change", () => shuffleAyahs());
  endEl.addEventListener("change", () => shuffleAyahs());
  document.getElementById("btnRedistribuer").onclick = shuffleAyahs;
  document.getElementById("btnTrier").onclick = sortAyahs;
  document.getElementById("btnToggleTraites").onclick = toggleTreated;
  document.getElementById("btnCorrect").onclick = () => registerResponse(true);
  document.getElementById("btnIncorrect").onclick = () => registerResponse(false);

})();
</script>

</body>
</html>
