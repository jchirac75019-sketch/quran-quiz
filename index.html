<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Versets Coran Avancé</title>
<style>
  body { font-family: Arial, sans-serif; margin: 5px; max-width: 100%; padding: 0 5px; font-size: 14px; }
  h1 { font-size: 1.2em; text-align: center; margin-bottom: 6px; }
  label, select, input { font-size: 0.9em; margin: 0 4px 6px 0; }
  input[type=number] { width: 50px; }
  .range-wrap { display: flex; gap: 6px; align-items: center; }
  .rtl-range { direction: rtl; }
  .controls { margin-bottom: 8px; display: flex; gap: 6px; flex-wrap: nowrap; }
  button { padding: 4px 8px; font-size: 0.9em; cursor: pointer; }
  .table-wrap { display: flex; flex-wrap: wrap; gap: 6px; max-height: 160px; overflow-y: auto; border: 1px solid #ccc; padding: 4px; background: #fafafa; user-select: none; }
  .num { border-radius: 5px; padding: 6px 10px; background: #d2f0d2; border: 1px solid #84b784; cursor: pointer; transition: background-color 0.3s; min-width: 36px; text-align: center; font-size: 0.95em; }
  .num.traited.correct { background-color: #0b3d0b; color: #d8f5d8; cursor: default; border-color: #064206; text-decoration: line-through; }
  .num.traited.incorrect { background-color: #8b1c1c; color: #f5d8d8; cursor: default; border-color: #5e1212; text-decoration: line-through; }
  #ayat-box { position: fixed; bottom: 10px; left: 10px; right: 10px; background: #f5f5f5; border-radius: 8px; padding: 10px 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); max-height: 22em; font-size: 1.2em; line-height: 1.4em; direction: rtl; text-align: right; display: none; overflow-y: visible; z-index: 1000; }
  #verse-header { font-weight: 600; font-size: 1.1em; margin-bottom: 6px; }
  #verse-text { max-height: 15em; overflow-y: auto; font-size: 1.2em; line-height: 1.4em; margin-bottom: 8px; }
  #response-buttons { margin-top: 6px; display: flex; justify-content: space-between; gap: 8px; }
  #response-buttons button { flex: 1; font-size: 1.1em; padding: 10px 0; line-height: 1.3em; }
  #counters { display: flex; gap: 10px; margin-top: 14px; font-size: 1em; font-weight: 600; flex-wrap: wrap; justify-content: center; }
  .counter-box { padding: 8px 14px; border-radius: 5px; color: white; flex: 1 1 130px; text-align: center; }
  .correct-box { background-color: #0b3d0b; }
  .incorrect-box { background-color: #8b1c1c; }
  .remaining-box { background-color: #505050; }
  .verset-red { color: red; font-weight: bold; }
  .verset-green { color: green; font-weight: bold; }
  .verset-blue { color: blue; font-weight: bold; }
  .verset-yellow { color: orange; font-weight: bold; }
  .number-blue { color: blue; font-weight: bold; }
  @media (max-width: 400px) {
    body { font-size: 13px; }
    #ayat-box { max-height: 24em; font-size: 1.3em; padding: 12px 14px; overflow-y: visible; }
    #verse-text { max-height: 17em; font-size: 1.3em; }
    #response-buttons button { padding: 12px 0; font-size: 1.2em; }
    .table-wrap { max-height: 140px; }
    .num { padding: 6px 10px; min-width: 34px; font-size: 1em; }
    #counters { font-size: 1.1em; }
  }
</style>
</head>
<body>
<h1 id="app-title">اختبار آيات القرآن المتقدم</h1>
<label for="language" id="label-language">اللغة :</label>
<select id="language">
  <option value="ar">العربية</option>
  <option value="fr">Français</option>
  <option value="en">English</option>
  <option value="es">Español</option>
</select>
<label for="sourah" id="label-sourah">السورة :</label>
<select id="sourah"></select>
<div id="range-wrap" class="range-wrap">
  <label for="start" id="label-start">بداية :</label>
  <input type="number" id="start" min="1" />
  <label for="end" id="label-end">نهاية :</label>
  <input type="number" id="end" min="1" />
</div>
<div class="controls">
  <button id="btnRedistribuer">إعادة التوزيع</button>
  <button id="btnTrier">ترتيب</button>
  <button id="btnToggleTraites">إظهار / إخفاء المعالَجَة</button>
</div>
<div class="table-wrap" id="ayah-numbers"></div>
<div id="ayat-box" style="display:none;">
  <div id="verse-header"></div>
  <div id="verse-text"></div>
  <div id="response-buttons">
    <button id="btnCorrect">إجابة صحيحة</button>
    <button id="btnIncorrect">إجابة خاطئة</button>
  </div>
</div>
<div id="counters">
  <div class="counter-box correct-box"><span id="label-correctCount">الإجابات الصحيحة :</span> <span id="correct-count">0</span></div>
  <div class="counter-box incorrect-box"><span id="label-errorCount">الأخطاء :</span> <span id="error-count">0</span></div>
  <div class="counter-box remaining-box"><span id="label-remainingCount">المتبقية :</span> <span id="remaining-count">0</span> / <span id="total-count">0</span></div>
</div>
<div class="counter-box remaining-box" id="end-time-box" style="display:none; margin-top: 8px; font-weight: bold; text-align:center; color:#fff; background: #222; border-radius:5px; padding:6px 12px;">
  Fin : <span id="end-time-display">--:--:--</span>
</div>
<script>
(() => {
const texts = {
  fr: {
    title: "Quiz Versets du Coran Avancé",
    languageLabel: "Langue :",
    sourateLabel: "Sourate :",
    startLabel: "Début :",
    endLabel: "Fin :",
    redistribuerBtn: "Redistribuer",
    trierBtn: "Trier",
    toggleTraitesBtn: "Afficher / Cacher Traités",
    correctBtn: "Bonne réponse",
    incorrectBtn: "Mauvaise réponse",
    correctCountLabel: "Réponses justes :",
    errorCountLabel: "Erreurs :",
    remainingCountLabel: "Restantes :",
    surahText: "Sourate N° : ",
    ayahText: "Verset N° : "
  },
  ar: {
    title: "اختبار آيات القرآن المتقدم",
    languageLabel: "اللغة :",
    sourateLabel: "السورة :",
    startLabel: "بداية :",
    endLabel: "نهاية :",
    redistribuerBtn: "إعادة التوزيع",
    trierBtn: "ترتيب",
    toggleTraitesBtn: "إظهار / إخفاء المعالَجَة",
    correctBtn: "إجابة صحيحة",
    incorrectBtn: "إجابة خاطئة",
    correctCountLabel: "الإجابات الصحيحة :",
    errorCountLabel: "الأخطاء :",
    remainingCountLabel: "المتبقية :",
    surahText: "السورة عدد: ",
    ayahText: "الآية عدد: "
  },
  en: {
    title: "Advanced Quran Verses Quiz",
    languageLabel: "Language:",
    sourateLabel: "Surah:",
    startLabel: "Start:",
    endLabel: "End:",
    redistribuerBtn: "Shuffle",
    trierBtn: "Sort",
    toggleTraitesBtn: "Show / Hide Treated",
    correctBtn: "Correct Answer",
    incorrectBtn: "Wrong Answer",
    correctCountLabel: "Correct Answers:",
    errorCountLabel: "Errors:",
    remainingCountLabel: "Remaining:",
    surahText: "Surah No.: ",
    ayahText: "Ayah No.: "
  },
  es: {
    title: "Cuestionario Avanzado de Versos del Corán",
    languageLabel: "Idioma:",
    sourateLabel: "Sura:",
    startLabel: "Inicio:",
    endLabel: "Fin:",
    redistribuerBtn: "Reordenar",
    trierBtn: "Ordenar",
    toggleTraitesBtn: "Mostrar / Ocultar Tratados",
    correctBtn: "Respuesta correcta",
    incorrectBtn: "Respuesta incorrecta",
    correctCountLabel: "Respuestas correctas:",
    errorCountLabel: "Errores:",
    remainingCountLabel: "Restantes:",
    surahText: "Sura N°: ",
    ayahText: "Verso N°: "
  }
};

const SURAHS = [
  // Liste complète des sourates comme avant...
  {number:1, name_ar:"الفاتحة", name_fr:"Al-Fatiha", count:7},
  {number:2, name_ar:"البقرة", name_fr:"Al-Baqara", count:286},
  {number:3, name_ar:"آل عمران", name_fr:"Al-i-Imran", count:200},
  {number:4, name_ar:"النساء", name_fr:"An-Nisa", count:176},
  // ... continuer toute la liste ...
  {number:114, name_ar:"الناس", name_fr:"An-Nas", count:6}
];

const STORAGE_KEY = "quranQuizProgress";
const languageEl = document.getElementById("language");
const sourahEl = document.getElementById("sourah");
const startEl = document.getElementById("start");
const endEl = document.getElementById("end");
const ayahContainer = document.getElementById("ayah-numbers");
const ayatBox = document.getElementById("ayat-box");
const verseTextEl = document.getElementById("verse-text");
const verseHeaderEl = document.getElementById("verse-header");
const correctEl = document.getElementById("correct-count");
const errorEl = document.getElementById("error-count");
const remainingEl = document.getElementById("remaining-count");
const totalEl = document.getElementById("total-count");
const btnRedistribuer = document.getElementById("btnRedistribuer");
const btnTrier = document.getElementById("btnTrier");
const btnToggleTraites = document.getElementById("btnToggleTraites");
const btnCorrect = document.getElementById("btnCorrect");
const btnIncorrect = document.getElementById("btnIncorrect");
const labelTitle = document.getElementById("app-title");
const labelLanguage = document.getElementById("label-language");
const labelSourate = document.getElementById("label-sourah");
const labelStart = document.getElementById("label-start");
const labelEnd = document.getElementById("label-end");
const labelCorrectCount = document.getElementById("label-correctCount");
const labelErrorCount = document.getElementById("label-errorCount");
const labelRemainingCount = document.getElementById("label-remainingCount");
const rangeWrap = document.getElementById("range-wrap");
const endTimeBox = document.getElementById("end-time-box");
const endDisplay = document.getElementById("end-time-display");

let ayahNumbers = [];
let traitedMap = new Map();
let showTreated = true;
let currentAyah = null;
let currentSourah = null;
let correctCount = 0;
let errorCount = 0;
let verseCache = new Map();

let startTime = null;
let endTime = null;
let elapsedTime = 0;
let timerInterval = null;
let lastUpdateTime = null;

const timerBox = document.createElement('div');
timerBox.classList.add('counter-box','remaining-box');
timerBox.style.fontWeight = 'normal';
timerBox.style.color = 'white';
timerBox.innerHTML = 'Début : <span id="start-time-display">--:--:--</span> &nbsp; Durée : <span id="elapsed-time-display">00:00:00</span>';
document.getElementById('counters').appendChild(timerBox);
const startDisplay = document.getElementById('start-time-display');
const elapsedDisplay = document.getElementById('elapsed-time-display');

function formatTime(ms) {
  const totalSeconds = Math.floor(ms / 1000);
  const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
  const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
  const s = String(totalSeconds % 60).padStart(2, '0');
  return `${h}:${m}:${s}`;
}

function updateTimerDisplay() {
  if (startTime && !endTime) {
    const now = Date.now();
    elapsedTime += now - lastUpdateTime;
    lastUpdateTime = now;
    elapsedDisplay.textContent = formatTime(elapsedTime);
  } else if (startTime && endTime) {
    elapsedDisplay.textContent = formatTime(elapsedTime);
  }
}

function startTimer() {
  if (startTime) return;
  startTime = Date.now();
  lastUpdateTime = startTime;
  endTime = null;
  endTimeBox.style.display = 'none'; // masque la date fin si redémarrage quiz
  startDisplay.textContent = new Date(startTime).toLocaleString();
  elapsedTime = 0;
  timerInterval = setInterval(() => {
    if (document.visibilityState === 'visible') updateTimerDisplay();
  }, 500);
}

function stopTimer() {
  if (!startTime || endTime) return;
  clearInterval(timerInterval);
  timerInterval = null;
  endTime = Date.now();
  endTimeBox.style.display = 'block';
  endDisplay.textContent = new Date(endTime).toLocaleString();
  updateTimerDisplay();
}

document.addEventListener('visibilitychange', () => {
  if (!startTime) return;
  if (document.visibilityState === 'visible') {
    lastUpdateTime = Date.now();
    if (!timerInterval && !endTime) {
      timerInterval = setInterval(() => {
        if (document.visibilityState === 'visible') updateTimerDisplay();
      }, 500);
    }
  } else {
    clearInterval(timerInterval);
    timerInterval = null;
  }
});

function saveProgress() {
  const data = {
    sourah: sourahEl.value,
    start: startEl.value,
    end: endEl.value,
    ayahNumbers,
    traited: Array.from(traitedMap.entries()),
    correctCount,
    errorCount,
    startTime,
    elapsedTime,
    endTime
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function loadProgress() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return false;
  try {
    const data = JSON.parse(raw);
    sourahEl.value = data.sourah;
    startEl.value = data.start;
    endEl.value = data.end;
    ayahNumbers = Array.isArray(data.ayahNumbers) ? data.ayahNumbers : [];
    traitedMap = new Map(data.traited || []);
    correctCount = data.correctCount || 0;
    errorCount = data.errorCount || 0;
    startTime = data.startTime || null;
    elapsedTime = data.elapsedTime || 0;
    endTime = data.endTime || null;
    updateRange();
    renderAyahs();
    updateCounters();
    if (startTime) {
      startDisplay.textContent = new Date(startTime).toLocaleString();
      if (document.visibilityState === 'visible' && !endTime) {
        lastUpdateTime = Date.now();
        timerInterval = setInterval(() => {
          if (document.visibilityState === 'visible') updateTimerDisplay();
        }, 500);
      }
    }
    if (endTime) {
      endTimeBox.style.display = 'block';
      endDisplay.textContent = new Date(endTime).toLocaleString();
    }
    updateVerseHeader();
    return true;
  } catch {
    return false;
  }
}

function clearProgress() {
  localStorage.removeItem(STORAGE_KEY);
  startTime = null;
  endTime = null;
  elapsedTime = 0;
  clearInterval(timerInterval);
  timerInterval = null;
  startDisplay.textContent = "--:--:--";
  elapsedDisplay.textContent = "00:00:00";
  endTimeBox.style.display = 'none';
  endDisplay.textContent = "--:--:--";
}

function updateInterfaceTexts(lang) {
  const t = texts[lang];
  document.title = t.title;
  labelTitle.textContent = t.title;
  labelLanguage.textContent = t.languageLabel;
  labelSourate.textContent = t.sourateLabel;
  labelStart.textContent = t.startLabel;
  labelEnd.textContent = t.endLabel;
  btnRedistribuer.textContent = t.redistribuerBtn;
  btnTrier.textContent = t.trierBtn;
  btnToggleTraites.textContent = t.toggleTraitesBtn;
  btnCorrect.textContent = t.correctBtn;
  btnIncorrect.textContent = t.incorrectBtn;
  labelCorrectCount.textContent = t.correctCountLabel;
  labelErrorCount.textContent = t.errorCountLabel;
  labelRemainingCount.textContent = t.remainingCountLabel;
  lang === "ar" ? rangeWrap.classList.add("rtl-range") : rangeWrap.classList.remove("rtl-range");
  updateVerseHeader();
}

function updateVerseHeader() {
  if (currentSourah !== null && currentAyah !== null) {
    const t = texts[languageEl.value];
    verseHeaderEl.innerHTML = `${t.surahText}<span class="number-blue">${currentSourah}</span>, ${t.ayahText}<span class="number-blue">${currentAyah}</span>`;
  } else {
    verseHeaderEl.innerHTML = "";
  }
}

function populateSourates() {
  sourahEl.innerHTML = "";
  SURAHS.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.number;
    opt.text = `${s.number} - ${s.name_ar} (${s.name_fr})`;
    sourahEl.appendChild(opt);
  });
}

function updateRange() {
  const sel = SURAHS.find(s => s.number == sourahEl.value);
  if (!sel) return;
  startEl.min = 1;
  startEl.max = sel.count;
  startEl.value = 1;
  endEl.min = 1;
  endEl.max = sel.count;
  endEl.value = sel.count;
}

function validateInputs() {
  const sel = SURAHS.find(s => s.number == sourahEl.value);
  if (!sel) return false;
  let maxVerset = sel.count;
  let startVal = parseInt(startEl.value);
  let endVal = parseInt(endEl.value);
  if (isNaN(startVal) || startVal < 1) startVal = 1;
  if (isNaN(endVal) || endVal < 1) endVal = 1;
  if (startVal > maxVerset) startVal = maxVerset;
  if (endVal > maxVerset) endVal = maxVerset;
  if (startVal > endVal) startVal = endVal;
  startEl.value = startVal;
  endEl.value = endVal;
  return true;
}

function shuffleAyahs() {
  if (!validateInputs()) return;
  ayahNumbers = [];
  for (let i = +startEl.value; i <= +endEl.value; i++) ayahNumbers.push(i);
  for (let i = ayahNumbers.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [ayahNumbers[i], ayahNumbers[j]] = [ayahNumbers[j], ayahNumbers[i]];
  }
  traitedMap.clear();
  correctCount = 0;
  errorCount = 0;
  verseCache.clear();
  updateCounters();
  currentAyah = null;
  currentSourah = null;
  ayatBox.style.display = "none";
  renderAyahs();
  updateVerseHeader();
  clearProgress();
  saveProgress();
}

function sortAyahs() {
  ayahNumbers.sort((a, b) => a - b);
  renderAyahs();
}

function toggleTreated() {
  showTreated = !showTreated;
  renderAyahs();
}

function updateCounters() {
  correctEl.textContent = correctCount;
  errorEl.textContent = errorCount;
  totalEl.textContent = ayahNumbers.length;
  const remaining = ayahNumbers.length - traitedMap.size;
  remainingEl.textContent = remaining < 0 ? 0 : remaining;
}

function colorVerseText(text) {
  if (!text) return "";
  text = text.trim();
  const SIGNES = ["۞", "۩"];
  let cleanedText = text;
  SIGNES.forEach(s => {
    cleanedText = cleanedText.split(s).join("");
  });
  cleanedText = cleanedText.trim();
  const words = cleanedText.split(/\s+/).filter(w => w.length > 0);
  if (words.length === 0) return text;
  const firstWord = `<span class="verset-red">${words[0]}</span>`;
  const lastWord = words.length > 1 ? `<span class="verset-green">${words[words.length - 1]}</span>` : "";
  const originalParts = text.split(/\s+/).filter(p => p.length > 0);
  let wordIndex = 0;
  return originalParts.map(part => {
    if (part === "۞") return `<span class="verset-yellow">${part}</span>`;
    if (part === "۩") return `<span class="verset-blue">${part}</span>`;
    if (wordIndex === 0) {
      wordIndex++;
      return firstWord;
    } else if (wordIndex === words.length - 1) {
      wordIndex++;
      return lastWord;
    } else if (wordIndex > 0 && wordIndex < words.length - 1) {
      const w = words[wordIndex];
      wordIndex++;
      return w;
    }
    return part;
  }).join(" ");
}

function showAyah(num) {
  currentAyah = num;
  currentSourah = sourahEl.value;
  ayatBox.style.display = "block";
  const lang = languageEl.value;
  const cacheKey = `${currentSourah}:${num}:${lang}`;
  if (verseCache.has(cacheKey)) {
    verseTextEl.innerHTML = verseCache.get(cacheKey);
    updateVerseHeader();
    return;
  }
  verseTextEl.innerHTML = "Chargement du verset...";
  fetch(`https://api.alquran.cloud/v1/ayah/${currentSourah}:${num}/ar.alafasy`)
    .then(res => res.json())
    .then(data => {
      if (data.code === 200 && data.data && data.data.text) {
        let verseText = data.data.text;
        const bismillah = "بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ";
        if (num === 1 && verseText.startsWith(bismillah)) {
          verseText = verseText.slice(bismillah.length).trim();
        }
        const colored = colorVerseText(verseText);
        verseTextEl.innerHTML = `<div>${colored}</div>`;
        verseCache.set(cacheKey, verseTextEl.innerHTML);
        updateVerseHeader();
      } else {
        verseTextEl.innerHTML = "Erreur lors du chargement du verset.";
      }
    })
    .catch(() => {
      verseTextEl.innerHTML = "Erreur lors du chargement du verset.";
    });

  if (!startTime) {
    startTimer();
    saveProgress();
  }
}

function registerResponse(isCorrect) {
  if (currentAyah === null) return;
  if (!traitedMap.has(currentAyah)) {
    traitedMap.set(currentAyah, isCorrect);
    if (isCorrect) correctCount++;
    else errorCount++;
    updateCounters();
    renderAyahs();
    ayatBox.style.display = "none";
    currentAyah = null;
    currentSourah = null;
    updateVerseHeader();

    if (traitedMap.size === ayahNumbers.length) {
      stopTimer();
      saveProgress();
    } else {
      saveProgress();
    }
  }
}

function renderAyahs() {
  ayahContainer.innerHTML = "";
  ayahNumbers.forEach(num => {
    const status = traitedMap.get(num);
    if (status !== undefined && !showTreated) return;
    const div = document.createElement("div");
    div.classList.add("num");
    if (status === true) div.classList.add("traited", "correct");
    else if (status === false) div.classList.add("traited", "incorrect");
    div.innerText = num;
    if (status === undefined) div.onclick = () => showAyah(num);
    ayahContainer.appendChild(div);
  });
  updateCounters();
}

populateSourates();
const defaultLang = "ar";
languageEl.value = defaultLang;
updateInterfaceTexts(defaultLang);
if (!loadProgress()) shuffleAyahs();

languageEl.addEventListener("change", e => updateInterfaceTexts(e.target.value));
sourahEl.addEventListener("change", () => {
  updateRange();
  shuffleAyahs();
});
startEl.addEventListener("input", validateInputs);
endEl.addEventListener("input", validateInputs);
startEl.addEventListener("change", () => shuffleAyahs());
endEl.addEventListener("change", () => shuffleAyahs());
btnRedistribuer.onclick = shuffleAyahs;
btnTrier.onclick = sortAyahs;
btnToggleTraites.onclick = toggleTreated;
btnCorrect.onclick = () => registerResponse(true);
btnIncorrect.onclick = () => registerResponse(false);

})();
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .then(registration => {
        console.log('Service Worker enregistré avec succès:', registration.scope);
      })
      .catch(error => {
        console.log('Erreur d’enregistrement du Service Worker:', error);
      });
  });
}
</script>
<script>
let wakeLock = null;
async function requestWakeLock() {
  if ('wakeLock' in navigator) {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', () => { console.log('Wake Lock released'); });
      console.log('Wake Lock is active');
    } catch (err) {
      console.error(`Erreur de Wake Lock : ${err.name}, ${err.message}`);
    }
  } else {
    console.log('Wake Lock API non supportée sur ce navigateur.');
  }
}
window.addEventListener('load', () => { requestWakeLock(); });
document.addEventListener('visibilitychange', () => {
  if (wakeLock !== null && document.visibilityState === 'visible') {
    requestWakeLock();
  }
});
</script>
</body>
</html>
