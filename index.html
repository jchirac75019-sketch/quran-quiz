<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Quiz Versets Coran Avancé</title>
<style>
* { box-sizing: border-box; }
body {
  font-family: Arial, sans-serif;
  margin: 14px auto 8px;
  padding: 0 4vw 20px;
  font-size: 16px;
  background: #f9fafb;
  color: #333;
  max-width: 100%;
  min-width: 280px;
}
h1 {
  font-weight: 700;
  font-size: 1.4em;
  text-align: center;
  margin: 8px 0 14px 0;
  color: #222;
}
.filters-container {
  display: flex; flex-wrap: nowrap; /* Force single line */
  justify-content: center;
  gap: 1.2rem; margin-bottom: 10px; width: 95%; max-width: 650px;
  margin-left: auto; margin-right: auto; align-items: center;
  background: #fff; padding: 12px 2vw; border-radius: 12px;
  box-shadow: 0 3px 15px rgb(0 0 0 / 0.08); user-select: none;
  /* Prevent wrapping and force child shrinking if needed */
  overflow-x: auto;
}
.selector-group {
  display: flex; align-items: center; gap: 6px; min-width: 0; max-width: 48vw; justify-content: center;
  background: #fefde9; border: 2px solid #a89e6e; border-radius: 10px;
  padding: 6px 12px; font-weight: 600; color: #5a552a; font-size: 1em;
  cursor: default; box-sizing: border-box;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  flex-shrink: 1; /* Let items shrink to keep single line */
}
.language-label, .sourah-label {
  background-color: #a89e6e; padding: 8px 10px; border-radius: 10px;
  color: #f5f0dc; font-weight: 700; cursor: default; display: flex; align-items: center;
  justify-content: center; margin: 0; box-shadow: 0 2px 8px rgb(0 0 0 / 0.12);
  font-size: 1em; letter-spacing: 0.03em; max-width: 30vw;
  overflow: hidden; text-overflow: ellipsis;
  flex-shrink: 1; /* Allow shrinking */
}
.language-select select, .sourah-select select, .range-wrap input[type='number'] {
  background-color: #f5f0dc; color: #5a552a; border: 2px solid #a89e6e; font-size: 1em;
  padding: 7px 12px; border-radius: 10px; min-width: 90px; max-width: 75vw; cursor: pointer;
  box-shadow: inset 0 1px 5px rgb(0 0 0 / 0.07);
  flex-shrink: 1;
}
.range-wrap {
  display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: nowrap;
  margin-bottom: 14px; width: 95%; max-width: 210px; margin-left: auto; margin-right: auto;
  background: #fff; border-radius: 14px; padding: 8px 2vw; box-shadow: 0 4px 18px rgb(0 0 0 / 0.12);
}
#start-label, #end-label {
  background-color: #a89e6e; padding: 8px 10px; border-radius: 10px;
  color: #f5f0dc; font-weight: 700; cursor: default; font-size: 1em;
  box-shadow: 0 2px 12px rgb(0 0 0 / 0.18);
}
label.ltr::after { content: " :"; font-weight: 700; letter-spacing: 0.05em; }
label.rtl::before { content: " :"; font-weight: 700; letter-spacing: 0.05em; }
.controls {
  display: flex; gap: 12px; justify-content: center; margin-top: 20px; margin-bottom: 12px;
  flex-wrap: wrap; width: 95%; max-width: 510px; margin-left: auto; margin-right: auto;
}
.controls button {
  flex: 0 0 auto; min-width: 136px; padding: 10px 16px; font-size: 1.07em;
  border-radius: 14px; color: white; font-weight: 700; cursor: pointer; border: none;
  box-shadow: 0 4px 12px rgb(0 0 0 / 0.28); letter-spacing: 0.03em;
}
#btnRedistribuer { background-color: #4caf50; }
#btnTrier { background-color: #2196f3; }
#btnToggle { background-color: #ff9800; }
.table-wrap {
  display: flex; flex-wrap: wrap; gap: 8px; max-height: 150px; max-width: 100%; overflow-y: auto;
  border-radius: 14px; border: 1.5px solid #ccc; padding: 10px 10px; background: #fff; user-select: none; margin-bottom: 10px;
  box-shadow: 0 4px 18px rgb(0 0 0 / 0.07); justify-content: center;
}
.num {
  border-radius: 14px; background: #d2f0d2; border: 1.8px solid #84b784; cursor: pointer; width: 42px; height: 42px;
  text-align: center; font-size: 1.1em; user-select: none; box-shadow: 0 2px 6px rgb(0 0 0 / 0.13); font-weight: 700;
  display: flex; justify-content: center; align-items: center;
}
.num:hover { background-color: #b6deb7; transform: scale(1.07); }
.num.traited.correct {
  background-color: #0b3d0b; color: #d8f5d8; cursor: default; border-color: #064206; text-decoration: line-through;
}
.num.traited.incorrect {
  background-color: #8b1c1c; color: #f5d8d8; cursor: default; border-color: #5e1212; text-decoration: line-through;
}
#ayat-box {
  max-width: 100%; margin: 0 auto; background: #f5f5f5;
  border-radius: 16px; padding: 18px 22px; box-shadow: 0 10px 30px rgb(0 0 0 / 0.14);
  font-size: 1.18em; line-height: 1.55em; direction: rtl; text-align: right; overflow: auto;
  box-sizing: border-box; position: static; z-index: 9999; max-height: 28em; user-select: text;
  display: none;
}
#verse-header {
  font-weight: 700; font-size: 1.07em; background: #fff9c4;
  padding: 10px 16px; border-radius: 12px; margin-bottom: 16px;
  box-shadow: inset 0 1px 4px #d2ca5fbb;
}
#verse-text {
  font-size: 1.24em; line-height: 1.5em; margin-bottom: 18px;
  overflow-y: auto; word-break: break-word;
}
.special-red { color: red !important; font-weight: 700; }
.special-green { color: green !important; font-weight: 700; }
.special-yellow { color: orange !important; font-weight: 700; }
.special-blue { color: blue !important; font-weight: 700; }
#response-buttons {
  display: flex; justify-content: center; gap: 24px; margin-top: 18px; user-select: none;
  flex-wrap: nowrap; max-width: 480px; margin-left: auto; margin-right: auto;
}
#response-buttons button {
  cursor: pointer; flex: 1 1 48%; font-weight: 700; font-size: 1.09em; padding: 11px 18px; border: none;
  border-radius: 16px; color: white; background-color: #4caf50;
  display: flex; justify-content: center; align-items: center; gap: 10px;
}
#btnIncorrect { background-color: #d32f2f !important; }
#btnCorrect::before { content: "✔"; color: #a5e6a5; font-weight: 700; }
#btnIncorrect::before { content: "✖"; color: #f5a8a8; font-weight: 700; }
.counter-box {
  padding: 14px 26px; border-radius: 16px; font-weight: 700;
  text-align: center; color: white; margin: 4px; user-select: none;
  font-size: 1.06em; min-width: 92px;
}
.counter-correct { background-color: #0b3d0b; }
.counter-incorrect { background-color: #8b1c1c; }
.counter-remaining { background-color: #505050; }
#timer-container {
  margin-top: 28px; text-align: center;
  font-weight: 700; font-size: 1.16em; color: #606060; user-select: none;
  letter-spacing: 0.035em;
}
#timer-container div { margin: 8px 0; }
#timer-end {
  margin-top: 16px; background: #222; color: white;
  padding: 14px 20px; border-radius: 14px; display: none;
  text-align: center; font-size: 1.16em;
  box-shadow: 0 5px 20px #000000dc; user-select: none;
}
@media (max-width: 480px) {
  body { padding: 0 4vw 18px; font-size: 15px; }
  .filters-container { gap: 0.7rem; padding: 6px 3vw; }
  /* Allow wrap on small screens */
  .filters-container {
    flex-wrap: wrap !important;
  }
  .selector-group { max-width: 45%; font-size: 0.9em; padding: 5px 8px; white-space: normal; }
  .language-label, .sourah-label { max-width: 40%; font-size: 0.9em; padding: 6px 8px; white-space: normal; }
  #start-label, #end-label { min-width: 60px; max-width: 33vw; font-size: 0.9em; padding: 6px 10px; }
  .language-select select, .sourah-select select, .range-wrap input[type='number'] { min-width: 80px; max-width: 45vw; font-size: 0.9em; padding: 6px 10px; }
  .range-wrap { max-width: 180px; padding: 6px 3vw; gap: 8px; margin-bottom: 12px; }
  .controls { max-width: 100%; gap: 10px; }
  .controls button { min-width: 96px; padding: 7px 10px; font-size: 1em; }
  .table-wrap { max-height: 115px; gap: 6px; padding: 8px 10px; }
  .num { width: 32px; height: 32px; font-size: 0.98em; }
  #ayat-box { font-size: 1em; padding: 14px 10px; max-height: 23em; }
  #verse-header { font-size: 0.93em; padding: 7px 8px; margin-bottom: 11px; }
  #verse-text { font-size: 1em; margin-bottom: 10px; }
  #response-buttons { max-width: 100%; gap: 13px; }
  #response-buttons button { font-size: 0.93em; padding: 7px 10px; }
  .counter-box { padding: 8px 11px; min-width: 66px; font-size: 1em; }
  #timer-container { font-size: 0.96em; margin-top: 13px; }
  #timer-end { font-size: 0.93em; padding: 8px 11px; margin-top: 10px; }
}
</style>
</head>
<body>
<h1 id="app-title"></h1>
<div class="filters-container" id="selectors">
  <div class="selector-group rtl-flip language-label" id="language-label"></div>
  <div class="selector-group rtl-flip language-select">
    <select id="language" >
      <option value="ar" selected>العربية</option>
      <option value="fr">Français</option>
      <option value="en">English</option>
      <option value="es">Español</option>
    </select>
  </div>
  <div class="selector-group rtl-flip sourah-label" id="sourah-label"></div>
  <div class="selector-group rtl-flip sourah-select">
    <select id="sourah"></select>
  </div>
</div>
<div id="range-wrap" class="rtl-flip input-group range-wrap">
  <label id="start-label" for="start"></label>
  <input type="number" id="start" min="1" />
  <label id="end-label" for="end"></label>
  <input type="number" id="end" min="1" />
</div>
<div class="controls rtl-flip" id="controls">
  <button id="btnRedistribuer"></button>
  <button id="btnTrier"></button>
  <button id="btnToggle"></button>
</div>
<div class="table-wrap" id="ayahs-container"></div>
<div id="ayat-box" style="display:none;">
  <div id="verse-header"></div>
  <div id="verse-text"></div>
  <div id="response-buttons">
    <button id="btnCorrect"></button>
    <button id="btnIncorrect"></button>
  </div>
</div>
<div id="counters" class="rtl-flip" style="display:flex; justify-content:center; gap:12px; margin-bottom:12px;">
  <div class="counter-box counter-correct" style="flex:1; margin:0;">
    <span id="label-correct"></span> <span id="correct-count">0</span>
  </div>
  <div class="counter-box counter-incorrect" style="flex:1; margin:0;">
    <span id="label-incorrect"></span> <span id="incorrect-count">0</span>
  </div>
  <div class="counter-box counter-remaining" style="flex:none; margin:0; min-width:144px; text-align:center;">
    <span id="label-remaining"></span> <span id="remaining-count">0</span> / <span id="total-count">0</span>
  </div>
  <div id="timer-end" style="display:none; flex:none; min-width:280px; margin:0;">
    <span>Fin: </span><span id="end-time-display"></span>
  </div>
</div>
<div id="timer-container">
  <div><strong>Début:</strong> <span id="start-time-display">--:--:--</span></div>
  <div><strong>Temps écoulé:</strong> <span id="elapsed-time-display">00:00:00</span></div>
  <div><strong>Fin:</strong> <span id="timer-end-time">--:--:--</span></div>
</div>
<script>
(() => {
  const texts = {
    fr: {
      title: "Quiz Versets Coran Avancé",
      languageLabel: "Langue",
      sourahLabel: "Sourate",
      startLabel: "Début",
      endLabel: "Fin",
      redistribuer: "Redistribuer",
      trier: "Trier",
      toggle: "Afficher / Cacher",
      correct: "Bonne réponse",
      incorrect: "Mauvaise réponse",
      labelCorrect: "Réponses",
      labelIncorrect: "Erreurs",
      labelRemaining: "Restantes",
      surahPrefix: "Sourate",
      ayahPrefix: "Verset"
    },
    ar: {
      title: "اختبار آيات القرآن المتقدم",
      languageLabel: "اللغة",
      sourahLabel: "السورة",
      startLabel: "بداية",
      endLabel: "نهاية",
      redistribuer: "إعادة التوزيع",
      trier: "ترتيب",
      toggle: "إظهار / إخفاء",
      correct: "إجابة صحيحة",
      incorrect: "إجابة خاطئة",
      labelCorrect: "الإجابات",
      labelIncorrect: "الأخطاء",
      labelRemaining: "المتبقي",
      surahPrefix: "سورة",
      ayahPrefix: "آية"
    },
    en: {
      title: "Advanced Quran Quiz",
      languageLabel: "Language",
      sourahLabel: "Surah",
      startLabel: "Start",
      endLabel: "End",
      redistribuer: "Shuffle",
      trier: "Sort",
      toggle: "Show / Hide",
      correct: "Correct",
      incorrect: "Incorrect",
      labelCorrect: "Correct",
      labelIncorrect: "Errors",
      labelRemaining: "Remaining",
      surahPrefix: "Surah",
      ayahPrefix: "Ayah"
    },
    es: {
      title: "Quiz Avanzado del Corán",
      languageLabel: "Idioma",
      sourahLabel: "Sura",
      startLabel: "Inicio",
      endLabel: "Fin",
      redistribuer: "Barajar",
      trier: "Ordenar",
      toggle: "Mostrar / Ocultar",
      correct: "Correcto",
      incorrect: "Incorrecto",
      labelCorrect: "Correctos",
      labelIncorrect: "Errores",
      labelRemaining: "Restantes",
      surahPrefix: "Sura",
      ayahPrefix: "Verso"
    }
  };
  const SURAHS = [
    { number: 1, name_ar: "الفاتحة", name_fr: "Al-Fatiha", count: 7 },
    { number: 2, name_ar: "البقرة", name_fr: "Al-Baqara", count: 286 },
    { number: 7, name_ar: "الأعراف", name_fr: "Al-A’raf", count: 206 },
    { number: 95, name_ar: "التين", name_fr: "At-Tin", count: 8 }
  ];
  const BISMILLAH = "بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ";

  const languageEl = document.getElementById("language");
  const sourahEl = document.getElementById("sourah");
  const startEl = document.getElementById("start");
  const endEl = document.getElementById("end");
  const ayahsContainer = document.getElementById("ayahs-container");
  const ayatBox = document.getElementById("ayat-box");
  const verseHeader = document.getElementById("verse-header");
  const verseText = document.getElementById("verse-text");
  const btnCorrect = document.getElementById("btnCorrect");
  const btnIncorrect = document.getElementById("btnIncorrect");
  const btnRedistribuer = document.getElementById("btnRedistribuer");
  const btnTrier = document.getElementById("btnTrier");
  const btnToggle = document.getElementById("btnToggle");
  const labelCorrect = document.getElementById("label-correct");
  const labelIncorrect = document.getElementById("label-incorrect");
  const labelRemaining = document.getElementById("label-remaining");
  const countCorrect = document.getElementById("correct-count");
  const countIncorrect = document.getElementById("incorrect-count");
  const countRemaining = document.getElementById("remaining-count");
  const countTotal = document.getElementById("total-count");
  const labelLanguage = document.getElementById("language-label");
  const labelSourah = document.getElementById("sourah-label");
  const labelStart = document.getElementById("start-label");
  const labelEnd = document.getElementById("end-label");
  const timerBox = document.getElementById("timer-container");
  const startTimerDisplay = document.getElementById("start-time-display");
  const elapsedTimerDisplay = document.getElementById("elapsed-time-display");
  const endTimerDisplay = document.getElementById("timer-end-time");
  const endTimeBox = document.getElementById("timer-end");

  let ayahs = [];
  let traitedMap = new Map();
  let currentAyah = null;
  let currentSourah = null;
  let correctCountValue = 0;
  let incorrectCountValue = 0;
  let showTreated = true;
  let startTime = null;
  let endTime = null;
  let elapsedTime = 0;
  let timerInterval = null;
  let lastUpdateTime = null;
  let verseCache = new Map();
  let pageVisible = true;

  function setTexts(lang) {
    const t = texts[lang];
    document.title = t.title;
    labelCorrect.textContent = t.labelCorrect;
    labelIncorrect.textContent = t.labelIncorrect;
    labelRemaining.textContent = t.labelRemaining;
    labelLanguage.textContent = t.languageLabel;
    labelSourah.textContent = t.sourahLabel;
    labelStart.textContent = t.startLabel;
    labelEnd.textContent = t.endLabel;
    btnRedistribuer.textContent = t.redistribuer;
    btnTrier.textContent = t.trier;
    btnToggle.textContent = t.toggle;
    btnCorrect.textContent = t.correct;
    btnIncorrect.textContent = t.incorrect;
    updateDirection(lang);
  }
  function updateDirection(lang) {
    let rtl = lang === "ar";
    let baseDir = rtl ? "rtl" : "ltr";
    document.documentElement.dir = baseDir;
    document.getElementById("selectors").style.direction = baseDir;
    const rangeWrap = document.getElementById("range-wrap");
    while(rangeWrap.firstChild) rangeWrap.removeChild(rangeWrap.firstChild);
    if(rtl) {
      rangeWrap.classList.add("rtl-flip");
      rangeWrap.appendChild(labelStart);
      rangeWrap.appendChild(startEl);
      rangeWrap.appendChild(labelEnd);
      rangeWrap.appendChild(endEl);
    } else {
      rangeWrap.classList.remove("rtl-flip");
      rangeWrap.appendChild(labelStart);
      rangeWrap.appendChild(startEl);
      rangeWrap.appendChild(labelEnd);
      rangeWrap.appendChild(endEl);
    }
  }
  function populateSourahOptions() {
    sourahEl.innerHTML = "";
    for(const s of SURAHS){
      let opt = document.createElement("option");
      opt.value = s.number;
      opt.textContent = `${s.number} - ${s.name_ar} (${s.name_fr})`;
      sourahEl.appendChild(opt);
    }
  }
  function updateLimits(reinit=true){
    const s = SURAHS.find(x=>x.number==sourahEl.value);
    if(!s) return;
    startEl.min = 1; startEl.max = s.count;
    endEl.min = 1; endEl.max = s.count;
    if(reinit){
      startEl.value = 1;
      endEl.value = s.count;
    } else {
      if(startEl.value < 1) startEl.value=1;
      if(startEl.value > s.count) startEl.value=s.count;
      if(endEl.value < 1) endEl.value=1;
      if(endEl.value > s.count) endEl.value=s.count;
    }
  }
  function validateRange() {
    let s = SURAHS.find(x => x.number == sourahEl.value);
    if(!s) return false;
    let start = Number(startEl.value);
    let end = Number(endEl.value);
    if(isNaN(start) || start < 1) start = 1;
    if(isNaN(end) || end < 1) end = 1;
    if(start > s.count) start = s.count;
    if(end > s.count) end = s.count;
    if(start > end) start = end;
    startEl.value = start;
    endEl.value = end;
    return true;
  }
  function shuffleAyahs() {
    if(!validateRange()) return;
    ayahs = [];
    let start = Number(startEl.value);
    let end = Number(endEl.value);
    for(let i=start;i<=end;i++) {
      ayahs.push(i);
    }
    for(let i=ayahs.length-1;i>0;i--) {
      let j = Math.floor(Math.random()*(i+1));
      [ayahs[i], ayahs[j]] = [ayahs[j], ayahs[i]];
    }
    traitedMap.clear();
    correctCountValue = 0;
    incorrectCountValue = 0;
    verseCache.clear();
    currentAyah = null;
    currentSourah = null;
    updateCounts();
    renderAyahs();
    resetTimer(true);
    saveProgress();
    clearVerseDetails();
  }
  function renderAyahs() {
    ayahsContainer.innerHTML = "";
    for(const num of ayahs){
      if(traitedMap.has(num) && !showTreated) continue;
      let div = document.createElement("div");
      div.textContent = num;
      div.classList.add("num");
      if(traitedMap.get(num)===true) div.classList.add("traited","correct");
      else if(traitedMap.get(num)===false) div.classList.add("traited","incorrect");
      else div.onclick = () => {
        showAyah(num);
        resumeTimer();
      };
      ayahsContainer.appendChild(div);
    }
    updateCounts();
    checkIfCompleteStopTimer();
  }
  function updateCounts() {
    correctCountValue = [...traitedMap.values()].filter(v=>v===true).length;
    incorrectCountValue = [...traitedMap.values()].filter(v=>v===false).length;
    countCorrect.textContent = correctCountValue;
    countIncorrect.textContent = incorrectCountValue;
    countRemaining.textContent = ayahs.length - traitedMap.size;
    countTotal.textContent = ayahs.length;
  }
  function checkIfCompleteStopTimer() {
    if(traitedMap.size === ayahs.length && ayahs.length > 0){
      stopTimer();
    }
  }
  async function fetchVerseWithFallback(surah, ayah, lang) {
    const key = `${surah}:${ayah}:${lang}`;
    if(verseCache.has(key)) return verseCache.get(key);
    const fetchPrimary = () => fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${ayah}/${lang}.hafs`)
      .then(res => { if (!res.ok) throw new Error('Primary source response not ok'); return res.json(); })
      .then(data => { if(data.code === 200 && data.data && data.data.text) return data.data.text.trim(); throw new Error('Primary source data missing or invalid'); });
    const fetchAlt1 = () => fetch(`https://alquran-api.pages.dev/api/v2/ayah/${surah}/${ayah}`)
      .then(res => { if (!res.ok) throw new Error('Alt1 response not ok'); return res.json(); })
      .then(data => { if(data && data.text) return data.text.trim(); throw new Error('Alt1 data missing or invalid'); });
    const fetchAlt2 = () => fetch(`https://tanzil.net/api/ayah/${surah}/${ayah}`)
      .then(res => { if (!res.ok) throw new Error('Alt2 response not ok'); return res.text(); })
      .then(text => { let trimmed = text.trim(); if(trimmed.length > 0) return trimmed; throw new Error('Alt2 data empty'); });
    try { return await fetchPrimary(); }
    catch (e) {
      try { return await fetchAlt1(); }
      catch (e1) {
        try { return await fetchAlt2(); }
        catch (e2) { throw new Error('All sources failed'); }
      }
    }
  }
  async function showAyah(num) {
    if(!num) return;
    currentAyah = num;
    currentSourah = sourahEl.value;
    ayatBox.style.display = "block";
    const lang = languageEl.value;
    const surahNo = Number(currentSourah);
    const key = `${currentSourah}:${currentAyah}:${lang}`;
    if(verseCache.has(key)){
      verseText.innerHTML = verseCache.get(key);
      updateHeader();
      return;
    }
    verseText.textContent = "Chargement...";
    try {
      let txt = await fetchVerseWithFallback(currentSourah, currentAyah, lang);
      if(surahNo === 1 && num === 1) {
      } else if(surahNo === 9) {
      } else if(surahNo === 95 && num === 1) {
        if(txt.startsWith(BISMILLAH)){
          txt = txt.slice(BISMILLAH.length).trim();
        }
        txt = "وَٱلتِّينِ وَٱلزَّيْتُونِ";
      } else if(num === 1){
        if(txt.startsWith(BISMILLAH)){
          txt = txt.slice(BISMILLAH.length).trim();
        }
      }
      let colored = colorVerseText(txt);
      verseText.innerHTML = `<div>${colored}</div>`;
      verseCache.set(key, verseText.innerHTML);
      updateHeader();
    } catch (error) {
      verseText.textContent = "Erreur lors du chargement du verset.";
    }
    if(!startTime) startTimer();
    saveProgress();
  }
  function clearVerseDetails(){
    currentAyah = null;
    currentSourah = null;
    ayatBox.style.display = "none";
    verseHeader.textContent = "";
    verseText.textContent = "";
  }
  function updateHeader(){
    if(currentSourah && currentAyah){
      const t = texts[languageEl.value];
      verseHeader.innerHTML = `${t.surahPrefix} ${currentSourah}, ${t.ayahPrefix} ${currentAyah}`;
    } else {
      verseHeader.textContent = "";
    }
  }
  function colorVerseText(text){
    if(!text) return "";
    const specialSigns = ["ۚ", "ۗ", "ۖ", "ۘ", "ۛ"];
    const normalSigns = ["۞", "۩"];
    function escapeHtml(str){
      return str.replace(/[&<>"']/g,m=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&apos;'})[m])
    }
    let escaped = escapeHtml(text);
    let symbolYellowSpan = '';
    const symbolReg = new RegExp(escapeHtml("۞"), 'g');
    if(symbolReg.test(escaped)){
      symbolYellowSpan = '<span class="special-yellow">۞</span> ';
      escaped = escaped.replace(symbolReg,'');
    }
    for(const s of specialSigns){
      const esc = escapeHtml(s);
      escaped = escaped.replace(new RegExp(esc,'gu'), `<span class="special-red">${esc}</span>`);
    }
    for(const s of normalSigns){
      if(s==="۞") continue;
      const esc = escapeHtml(s);
      escaped = escaped.replace(new RegExp(esc,'gu'), `<span class="special-blue">${esc}</span>`);
    }
    let match = escaped.match(/(<span class="special-blue">۩<\/span>)$/);
    let endSymbol = "";
    if(match){
      escaped = escaped.replace(/(<span class="special-blue">۩<\/span>)$/,"").trim();
      endSymbol = match[1];
    }
    const tmpDiv = document.createElement('div');
    tmpDiv.innerHTML = escaped;
    for(const sp of tmpDiv.querySelectorAll('span.special-red, span.special-yellow, span.special-blue')){
      sp.replaceWith(document.createTextNode(sp.textContent))
    }
    const cleanText = tmpDiv.textContent.trim();
    if(!cleanText) return symbolYellowSpan+escaped+(endSymbol?(" "+endSymbol):"");
    const plainWords = cleanText.split(/\s+/);
    const tokens = escaped.split(/(\s+)/);
    let firstIdx = -1;
    let lastIdx = -1;
    let wordCounter=0;
    for(let i=0; i<tokens.length; i++){
      const plainToken = tokens[i].replace(/<[^>]+>/g,'').trim();
      if(plainToken === '') continue;
      if(wordCounter >= plainWords.length) break;
      if(tokens[i].includes(plainWords[wordCounter])){
        if(firstIdx===-1) firstIdx=i;
        lastIdx=i;
        wordCounter++;
      }
    }
    if(firstIdx!==-1)
      tokens[firstIdx] = `<span style="color:red;font-weight:700;">${tokens[firstIdx]}</span>`;
    if(lastIdx!==-1 && lastIdx!==firstIdx)
      tokens[lastIdx] = `<span style="color:green;font-weight:700;">${tokens[lastIdx]}</span>`;
    return symbolYellowSpan + tokens.join('') + (endSymbol ? (" "+endSymbol) : "");
  }
  function registerAnswer(correct){
    if(currentAyah==null) return;
    if(!traitedMap.has(currentAyah)){
      traitedMap.set(currentAyah,correct);
      if(correct) correctCountValue++;
      else incorrectCountValue++;
      updateCounts();
      renderAyahs();
      ayatBox.style.display="none";
      currentAyah=null;
      currentSourah=null;
      updateHeader();
      saveProgress();
      checkIfCompleteStopTimer();
    }
  }
  function toggleTreated(){
    showTreated = !showTreated;
    renderAyahs();
  }
  function sortAyahs(){
    ayahs.sort((a,b)=>a-b);
    renderAyahs();
  }
  function saveProgress(){
    const data = {
      sourah:sourahEl.value, start:startEl.value, end:endEl.value,
      ayahs, treated: Array.from(traitedMap.entries()),
      correct: correctCountValue, incorrect: incorrectCountValue,
      startTime, elapsedTime, endTime
    };
    localStorage.setItem("quizProgress", JSON.stringify(data));
  }
  function loadProgress(){
    const str = localStorage.getItem("quizProgress");
    if(!str) return false;
    try{
      const data = JSON.parse(str);
      sourahEl.value = data.sourah || sourahEl.value;
      startEl.value = data.start || startEl.value;
      endEl.value = data.end || endEl.value;
      ayahs = Array.isArray(data.ayahs) ? data.ayahs : [];
      traitedMap = new Map(data.treated || []);
      correctCountValue = data.correct || 0;
      incorrectCountValue = data.incorrect || 0;
      startTime = data.startTime || null;
      elapsedTime = data.elapsedTime || 0;
      endTime = data.endTime || null;
      updateLimits(false);
      renderAyahs();
      updateCounts();
      if(startTime && !endTime){
        lastUpdateTime = Date.now();
        timerInterval = setInterval(()=>updateElapsedTime(),500);
      }
      if(endTime){
        endTimeBox.style.display = "block";
        document.getElementById("end-time-display").textContent = new Date(endTime).toLocaleString();
        endTimerDisplay.textContent = new Date(endTime).toLocaleString();
      }
      updateHeader();
      setTexts(languageEl.value);
      checkIfCompleteStopTimer();
      return true;
    }catch{
      return false;
    }
  }
  function clearProgress(){
    localStorage.removeItem("quizProgress");
    ayahs = [];
    traitedMap.clear();
    correctCountValue=0;
    incorrectCountValue=0;
    startTime=null;
    elapsedTime=0;
    endTime=null;
    clearInterval(timerInterval);
    timerInterval=null;
    currentAyah=null;
    currentSourah=null;
    ayatBox.style.display="none";
    updateCounts();
    renderAyahs();
    updateHeader();
    startTimerDisplay.textContent="--:--:--";
    elapsedTimerDisplay.textContent="00:00:00";
    endTimerDisplay.textContent="--:--:--";
    endTimeBox.style.display="none";
  }
  function updateElapsedTime(){
    if(!startTime || !pageVisible) return;
    const now = Date.now();
    elapsedTime += now - lastUpdateTime;
    lastUpdateTime = now;
    elapsedTimerDisplay.textContent = formatTime(elapsedTime);
  }
  function formatTime(ms){
    ms = Math.max(0, ms);
    const sec = Math.floor(ms / 1000);
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
  }
  function startTimer(){
    if(startTime) return;
    startTime = Date.now();
    lastUpdateTime = startTime;
    elapsedTime = 0;
    pageVisible = true;
    timerInterval = setInterval(()=>updateElapsedTime(),500);
    startTimerDisplay.textContent = new Date(startTime).toLocaleString();
    endTimeBox.style.display = "none";
    endTimerDisplay.textContent = "--:--:--";
  }
  function stopTimer(){
    if(!startTime || endTime) return;
    clearInterval(timerInterval);
    timerInterval=null;
    endTime = Date.now();
    endTimeBox.style.display = "block";
    document.getElementById("end-time-display").textContent = new Date(endTime).toLocaleString();
    endTimerDisplay.textContent = new Date(endTime).toLocaleString();
  }
  function resetTimer(resetElapsed){
    clearInterval(timerInterval);
    timerInterval=null;
    startTime=null;
    endTime=null;
    lastUpdateTime=null;
    pageVisible=true;
    if(resetElapsed)
      elapsedTime=0;
    startTimerDisplay.textContent="--:--:--";
    elapsedTimerDisplay.textContent="00:00:00";
    endTimerDisplay.textContent="--:--:--";
    endTimeBox.style.display="none";
  }
  function resumeTimer(){
    if(traitedMap.size === ayahs.length) return;
    if(!pageVisible) return;
    if(!startTime){
      startTime=Date.now()-elapsedTime;
      lastUpdateTime=Date.now();
      timerInterval=setInterval(()=>updateElapsedTime(),500);
      startTimerDisplay.textContent = new Date(startTime).toLocaleString();
    } else if(!timerInterval){
      lastUpdateTime=Date.now();
      timerInterval=setInterval(()=>updateElapsedTime(),500);
    }
  }
  document.addEventListener("visibilitychange",()=>{
    if(document.hidden){
      pageVisible=false;
      clearInterval(timerInterval);
      timerInterval=null;
    } else {
      pageVisible=true;
      if(startTime && !endTime && traitedMap.size < ayahs.length){
        lastUpdateTime=Date.now();
        timerInterval=setInterval(()=>updateElapsedTime(),500);
      }
    }
  });
  languageEl.addEventListener("change",()=>{
    setTexts(languageEl.value);
    saveProgress();
  });
  sourahEl.addEventListener("change",()=>{
    updateLimits(true);
    shuffleAyahs();
    resetTimer(true);
    clearVerseDetails();
  });
  startEl.addEventListener("input", ()=>{ if(validateRange()) shuffleAyahs(); });
  endEl.addEventListener("input", ()=>{ if(validateRange()) shuffleAyahs(); });
  btnRedistribuer.addEventListener("click", ()=>{ shuffleAyahs(); resetTimer(true); });
  btnTrier.addEventListener("click", sortAyahs);
  btnToggle.addEventListener("click", ()=>{ showTreated = !showTreated; renderAyahs(); });
  btnCorrect.addEventListener("click", ()=> registerAnswer(true));
  btnIncorrect.addEventListener("click", ()=> registerAnswer(false));
  document.addEventListener("DOMContentLoaded", ()=>{
    setTexts(languageEl.value);
    populateSourahOptions();
    if(!loadProgress()){
      sourahEl.value=1;
      updateLimits(true);
      shuffleAyahs();
    }
  });
})();
</script>
</body>
</html>
