<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Versets Coran Avancé</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 10px auto;
  max-width: 800px;
  padding: 0 16px;
  font-size: 16px;
  box-sizing: border-box;
}
h1 {
  font-size: 1.2em;
  text-align: center;
  margin-bottom: 8px;
  font-weight: 600;
}
.selectors-container {
  display: flex;
  justify-content: center;
  gap: 15px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
.selector-group {
  display: flex;
  align-items: center;
  gap: 6px;
  direction: ltr;
}
.selector-group.rtl-flip {
  direction: rtl;
  flex-direction: row-reverse;
  gap: 6px;
}
.range-wrap {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: center;
  flex-wrap: wrap;
  margin-bottom: 16px;
  direction: ltr;
}
.range-wrap.rtl-flip {
  direction: rtl;
  flex-direction: row-reverse;
  gap: 12px;
}
label {
  background-color: #a89e6e;
  padding: 6px 8px;
  border-radius: 4px;
  color: #f5f0dc;
  font-weight: 600;
  user-select: none;
  cursor: default;
}
label.ltr::after {
  content: " :";
  font-weight: 600;
}
label.rtl::before {
  content: " :";
  font-weight: 600;
}
select,
input[type='number'] {
  background-color: #f5f0dc;
  font-family: inherit;
  color: #5a552a;
  border: 1px solid #888;
  font-size: 1em;
  padding: 4px 6px;
  border-radius: 4px;
  user-select: text;
}
input[type='number'] {
  width: 60px;
}
#start {
  width: 75px;
}
#end {
  width: 75px;
}
input[type='number']:focus,
select:focus {
  border-color: #3a8d3a;
  box-shadow: 0 0 8px #4caf5080;
  outline: none;
  background-color: #e6e0b8;
}
.controls {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 16px;
  flex-wrap: nowrap;
}
.controls.rtl-reverse {
  direction: rtl;
  justify-content: center !important;
  flex-wrap: nowrap;
  gap: 12px;
}
.controls button {
  flex: 0 0 auto;
  min-width: 140px;
  padding: 8px 14px;
  font-size: 1.1em;
  border-radius: 6px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: background-color 0.3s;
}
.controls button:hover {
  filter: brightness(90%);
}
#btnRedistribuer {
  background-color: #4caf50;
}
#btnTrier {
  background-color: #2196f3;
}
#btnToggle {
  background-color: #ff9800;
}
#btnRedistribuer:hover {
  background-color: #388e3c;
}
#btnTrier:hover {
  background-color: #1976d2;
}
#btnToggle:hover {
  background-color: #ef6c00;
}
.table-wrap {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  max-height: 140px;
  overflow-y: auto;
  overflow-x: auto;
  border: 1px solid #ccc;
  padding: 8px;
  background: #fafafa;
  user-select: none;
  margin-bottom: 12px;
  box-sizing: border-box;
}
.num {
  border-radius: 6px;
  background: #d2f0d2;
  border: 1px solid #84b784;
  padding: 8px 14px;
  cursor: pointer;
  min-width: 42px;
  text-align: center;
  font-size: 1.1em;
  user-select: none;
  transition: background-color 0.3s;
}
.num.traited.correct {
  background-color: #0b3d0b;
  color: #d8f5d8;
  cursor: default;
  border-color: #064206;
  text-decoration: line-through;
}
.num.traited.incorrect {
  background-color: #8b1c1c;
  color: #f5d8d8;
  cursor: default;
  border-color: #5e1212;
  text-decoration: line-through;
}
#ayat-box {
  max-width: 100%;
  margin: 0 auto;
  background: #f5f5f5;
  border-radius: 10px;
  padding: 24px 30px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.18);
  font-size: 1.8em;
  line-height: 1.65em;
  direction: rtl;
  text-align: right;
  overflow: auto;
  display: none;
  box-sizing: border-box;
  position: static;
  z-index: 9999;
  max-height: 28em;
}
#verse-header {
  font-weight: 700;
  font-size: 1.3em;
  background: #fff9c4;
  padding: 8px 12px;
  border-radius: 6px;
  margin-bottom: 12px;
  user-select: none;
}
#verse-text {
  font-size: 1.9em;
  line-height: 1.7em;
  margin-bottom: 14px;
  overflow-y: auto;
  word-break: break-word;
  user-select: text;
  white-space: normal;
}
.special-red {
  color: red !important;
  font-weight: 700;
}
.special-green {
  color: green !important;
  font-weight: 700;
}
.special-yellow {
  color: orange !important;
  font-weight: 700;
}
.special-blue {
  color: blue !important;
  font-weight: 700;
}
#response-buttons {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 15px;
  user-select: none;
  flex-wrap: nowrap;
}
#response-buttons button {
  cursor: pointer;
  min-width: 140px;
  font-weight: 700;
  font-size: 1.15em;
  padding: 8px 16px;
  border: none;
  border-radius: 10px;
  color: white;
  background-color: #4caf50;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  transition: background-color 0.3s;
}
#response-buttons button:hover {
  filter: brightness(0.85);
}
#btnIncorrect {
  background-color: #d32f2f !important;
}
#btnIncorrect:hover {
  filter: brightness(0.85);
}
#btnCorrect::before {
  content: "✔";
  color: #a5e6a5;
  font-weight: 700;
}
#btnIncorrect::before {
  content: "✖";
  color: #f5a8a8;
  font-weight: 700;
}
.counter-box {
  padding: 12px 20px;
  border-radius: 10px;
  font-weight: 700;
  text-align: center;
  color: white;
  margin: 4px;
  user-select: none;
}
.counter-correct {
  background-color: #0b3d0b;
}
.counter-incorrect {
  background-color: #8b1c1c;
}
.counter-remaining {
  background-color: #505050;
}
#timer-container {
  margin-top: 22px;
  text-align: center;
  font-weight: 700;
  font-size: 1.1em;
  color: #505050;
  user-select: none;
}
#timer-container div {
  margin: 6px 0;
}
#timer-end {
  margin-top: 10px;
  background: #222;
  color: white;
  padding: 10px 16px;
  border-radius: 8px;
  display: none;
}
</style>
</head>
<body>
<h1 id="app-title"></h1>
<div class="selectors-container" id="selectors">
  <div class="selector-group rtl-flip language-label" id="language-label"></div>
  <div class="selector-group rtl-flip language-select">
    <select id="language">
      <option value="ar">العربية</option>
      <option value="fr">Français</option>
      <option value="en">English</option>
      <option value="es">Español</option>
    </select>
  </div>
  <div class="selector-group rtl-flip sourah-label" id="sourah-label"></div>
  <div class="selector-group rtl-flip sourah-select">
    <select id="sourah"></select>
  </div>
</div>
<div id="range-wrap" class="rtl-flip input-group">
  <label id="start-label" for="start"></label>
  <input type="number" id="start" min="1" />
  <label id="end-label" for="end"></label>
  <input type="number" id="end" min="1" />
</div>
<div class="controls rtl-flip" id="controls">
  <button id="btnRedistribuer"></button>
  <button id="btnTrier"></button>
  <button id="btnToggle"></button>
</div>
<div class="table-wrap" id="ayahs-container"></div>
<div id="ayat-box" style="display:none;">
  <div id="verse-header"></div>
  <div id="verse-text"></div>
  <div id="response-buttons">
    <button id="btnCorrect"></button>
    <button id="btnIncorrect"></button>
  </div>
</div>
<div id="counters" class="rtl-flip">
  <div class="counter-box counter-correct">
    <span id="label-correct"></span> <span id="correct-count">0</span>
  </div>
  <div class="counter-box counter-incorrect">
    <span id="label-incorrect"></span> <span id="incorrect-count">0</span>
  </div>
  <div class="counter-box counter-remaining">
    <span id="label-remaining"></span> <span id="remaining-count">0</span> / <span id="total-count">0</span>
  </div>
  <div id="timer-end" style="display:none;">
    <span>Fin: </span><span id="end-time-display"></span>
  </div>
</div>
<div id="timer-container">
  <div><strong>Début:</strong> <span id="start-time-display">--:--:--</span></div>
  <div><strong>Temps écoulé:</strong> <span id="elapsed-time-display">00:00:00</span></div>
  <div><strong>Fin:</strong> <span id="timer-end-time">--:--:--</span></div>
</div>
<script>
(() => {
  const texts = {
    fr: {
      title: "Quiz Versets Coran Avancé",
      languageLabel: "Langue",
      sourahLabel: "Sourate",
      startLabel: "Début",
      endLabel: "Fin",
      redistribuer: "Redistribuer",
      trier: "Trier",
      toggle: "Afficher / Cacher",
      correct: "Bonne réponse",
      incorrect: "Mauvaise réponse",
      labelCorrect: "Réponses",
      labelIncorrect: "Erreurs",
      labelRemaining: "Restantes",
      surahPrefix: "Sourate",
      ayahPrefix: "Verset"
    },
    ar: {
      title: "اختبار آيات القرآن المتقدم",
      languageLabel: "اللغة",
      sourahLabel: "السورة",
      startLabel: "بداية",
      endLabel: "نهاية",
      redistribuer: "إعادة التوزيع",
      trier: "ترتيب",
      toggle: "إظهار / إخفاء",
      correct: "إجابة صحيحة",
      incorrect: "إجابة خاطئة",
      labelCorrect: "الإجابات",
      labelIncorrect: "الأخطاء",
      labelRemaining: "المتبقي",
      surahPrefix: "سورة",
      ayahPrefix: "آية"
    },
    en: {
      title: "Advanced Quran Quiz",
      languageLabel: "Language",
      sourahLabel: "Surah",
      startLabel: "Start",
      endLabel: "End",
      redistribuer: "Shuffle",
      trier: "Sort",
      toggle: "Show / Hide",
      correct: "Correct",
      incorrect: "Incorrect",
      labelCorrect: "Correct",
      labelIncorrect: "Errors",
      labelRemaining: "Remaining",
      surahPrefix: "Surah",
      ayahPrefix: "Ayah"
    },
    es: {
      title: "Quiz Avanzado del Corán",
      languageLabel: "Idioma",
      sourahLabel: "Sura",
      startLabel: "Inicio",
      endLabel: "Fin",
      redistribuer: "Barajar",
      trier: "Ordenar",
      toggle: "Mostrar / Ocultar",
      correct: "Correcto",
      incorrect: "Incorrecto",
      labelCorrect: "Correctos",
      labelIncorrect: "Errores",
      labelRemaining: "Restantes",
      surahPrefix: "Sura",
      ayahPrefix: "Verso"
    }
  };
  const SURAHS = [
    { number: 1, name_ar: "الفاتحة", name_fr: "Al-Fatiha", count: 7 },
    { number: 2, name_ar: "البقرة", name_fr: "Al-Baqara", count: 286 },
    { number: 3, name_ar: "آل عمران", name_fr: "Al-Imran", count: 200 },
    { number: 4, name_ar: "النساء", name_fr: "An-Nisa", count: 176 },
    { number: 5, name_ar: "المائدة", name_fr: "Al-Ma'ida", count: 120 },
    { number: 6, name_ar: "الأنعام", name_fr: "Al-An'am", count: 165 },
    { number: 7, name_ar: "الأعراف", name_fr: "Al-A'raf", count: 206 },
    { number: 8, name_ar: "الأنفال", name_fr: "Al-Anfal", count: 75 },
    { number: 9, name_ar: "التوبة", name_fr: "At-Tawba", count: 129 },
    { number: 10, name_ar: "يونس", name_fr: "Yunus", count: 109 },
    { number: 11, name_ar: "هود", name_fr: "Hud", count: 123 },
    { number: 12, name_ar: "يوسف", name_fr: "Yusuf", count: 111 },
    { number: 13, name_ar: "الرعد", name_fr: "Ar-Ra'd", count: 43 },
    { number: 14, name_ar: "إبراهيم", name_fr: "Ibrahim", count: 52 },
    { number: 15, name_ar: "الحجر", name_fr: "Al-Hijr", count: 99 },
    { number: 16, name_ar: "النحل", name_fr: "An-Nahl", count: 128 },
    { number: 17, name_ar: "الإسراء", name_fr: "Al-Isra", count: 111 },
    { number: 18, name_ar: "الكهف", name_fr: "Al-Kahf", count: 110 },
    { number: 19, name_ar: "مريم", name_fr: "Maryam", count: 98 },
    { number: 20, name_ar: "طه", name_fr: "Ta-Ha", count: 135 },
    { number: 21, name_ar: "الأنبياء", name_fr: "Al-Anbiya", count: 112 },
    { number: 22, name_ar: "الحج", name_fr: "Al-Hajj", count: 78 },
    { number: 23, name_ar: "المؤمنون", name_fr: "Al-Mu'minun", count: 118 },
    { number: 24, name_ar: "النور", name_fr: "An-Nur", count: 64 },
    { number: 25, name_ar: "الفرقان", name_fr: "Al-Furqan", count: 77 },
    { number: 26, name_ar: "الشعراء", name_fr: "Ash-Shu'ara", count: 227 },
    { number: 27, name_ar: "النمل", name_fr: "An-Naml", count: 93 },
    { number: 28, name_ar: "القصص", name_fr: "Al-Qasas", count: 88 },
    { number: 29, name_ar: "العنكبوت", name_fr: "Al-Ankabut", count: 69 },
    { number: 30, name_ar: "الروم", name_fr: "Ar-Rum", count: 60 },
    { number: 31, name_ar: "لقمان", name_fr: "Luqman", count: 34 },
    { number: 32, name_ar: "السجدة", name_fr: "As-Sajda", count: 30 },
    { number: 33, name_ar: "الأحزاب", name_fr: "Al-Ahzab", count: 73 },
    { number: 34, name_ar: "سبأ", name_fr: "Saba", count: 54 },
    { number: 35, name_ar: "فاطر", name_fr: "Fatir", count: 45 },
    { number: 36, name_ar: "يس", name_fr: "Ya-Sin", count: 83 },
    { number: 37, name_ar: "الصافات", name_fr: "As-Saffat", count: 182 },
    { number: 38, name_ar: "ص", name_fr: "Sad", count: 88 },
    { number: 39, name_ar: "الزلزلة", name_fr: "Az-Zalzala", count: 7 },
    { number: 40, name_ar: "الرحمن", name_fr: "Ar-Rahman", count: 78 },
    { number: 41, name_ar: "الملك", name_fr: "Al-Mulk", count: 30 },
    { number: 42, name_ar: "الكافرون", name_fr: "Al-Kafirun", count: 6 },
    { number: 43, name_ar: "الإخلاص", name_fr: "Al-Ikhlas", count: 4 },
    { number: 44, name_ar: "الفلق", name_fr: "Al-Falaq", count: 5 },
    { number: 45, name_ar: "الناس", name_fr: "An-Nas", count: 6 }
  ];

  const languageEl = document.getElementById("language");
  const sourahEl = document.getElementById("sourah");
  const startEl = document.getElementById("start");
  const endEl = document.getElementById("end");
  const ayahsContainer = document.getElementById("ayahs-container");
  const ayatBox = document.getElementById("ayat-box");
  const verseHeader = document.getElementById("verse-header");
  const verseText = document.getElementById("verse-text");
  const btnCorrect = document.getElementById("btnCorrect");
  const btnIncorrect = document.getElementById("btnIncorrect");
  const btnRedistribuer = document.getElementById("btnRedistribuer");
  const btnTrier = document.getElementById("btnTrier");
  const btnToggle = document.getElementById("btnToggle");
  const labelCorrect = document.getElementById("label-correct");
  const labelIncorrect = document.getElementById("label-incorrect");
  const labelRemaining = document.getElementById("label-remaining");
  const countCorrect = document.getElementById("correct-count");
  const countIncorrect = document.getElementById("incorrect-count");
  const countRemaining = document.getElementById("remaining-count");
  const countTotal = document.getElementById("total-count");
  const labelLanguage = document.getElementById("language-label");
  const labelSourah = document.getElementById("sourah-label");
  const labelStart = document.getElementById("start-label");
  const labelEnd = document.getElementById("end-label");
  const timerBox = document.getElementById("timer-container");
  const startTimerDisplay = document.getElementById("start-time-display");
  const elapsedTimerDisplay = document.getElementById("elapsed-time-display");
  const endTimerDisplay = document.getElementById("timer-end-time");
  const endTimeBox = document.getElementById("timer-end");

  let ayahs = [];
  let traitedMap = new Map();
  let currentAyah = null;
  let currentSourah = null;
  let correctCountValue = 0;
  let incorrectCountValue = 0;
  let showTreated = true;
  let startTime = null;
  let endTime = null;
  let elapsedTime = 0;
  let timerInterval = null;
  let lastUpdateTime = null;
  let verseCache = new Map();

  function setTexts(lang) {
    const t = texts[lang];
    document.title = t.title;
    labelCorrect.textContent = t.labelCorrect;
    labelIncorrect.textContent = t.labelIncorrect;
    labelRemaining.textContent = t.labelRemaining;
    labelLanguage.textContent = t.languageLabel;
    labelSourah.textContent = t.sourahLabel;
    labelStart.textContent = t.startLabel;
    labelEnd.textContent = t.endLabel;
    btnRedistribuer.textContent = t.redistribuer;
    btnTrier.textContent = t.trier;
    btnToggle.textContent = t.toggle;
    btnCorrect.textContent = t.correct;
    btnIncorrect.textContent = t.incorrect;
    updateDirection(lang);
  }

  function updateDirection(lang) {
    let rtl = lang === "ar";
    let baseDir = rtl ? "rtl" : "ltr";
    document.documentElement.dir = baseDir;
    document.getElementById("selectors").style.direction = baseDir;
  }

  function populateSourahOptions() {
    sourahEl.innerHTML = "";
    for (const s of SURAHS) {
      let opt = document.createElement("option");
      opt.value = s.number;
      opt.textContent = `${s.number} - ${s.name_ar} (${s.name_fr})`;
      sourahEl.appendChild(opt);
    }
  }

  function updateLimits(reinit = true) {
    const s = SURAHS.find((x) => x.number == sourahEl.value);
    if (!s) return;
    startEl.min = 1;
    startEl.max = s.count;
    endEl.min = 1;
    endEl.max = s.count;
    if (reinit) {
      startEl.value = 1;
      endEl.value = s.count;
    } else {
      if (startEl.value < 1) startEl.value = 1;
      if (startEl.value > s.count) startEl.value = s.count;
      if (endEl.value < 1) endEl.value = 1;
      if (endEl.value > s.count) endEl.value = s.count;
    }
  }

  function validateRange() {
    let s = SURAHS.find((x) => x.number == sourahEl.value);
    if (!s) return false;
    let start = Number(startEl.value);
    let end = Number(endEl.value);
    if (isNaN(start) || start < 1) start = 1;
    if (isNaN(end) || end < 1) end = 1;
    if (start > s.count) start = s.count;
    if (end > s.count) end = s.count;
    if (start > end) start = end;
    startEl.value = start;
    endEl.value = end;
    return true;
  }

  function shuffleAyahs() {
    if (!validateRange()) return;
    ayahs = [];
    let start = Number(startEl.value);
    let end = Number(endEl.value);
    for (let i = start; i <= end; i++) {
      ayahs.push(i);
    }
    for (let i = ayahs.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [ayahs[i], ayahs[j]] = [ayahs[j], ayahs[i]];
    }
    traitedMap.clear();
    correctCountValue = 0;
    incorrectCountValue = 0;
    verseCache.clear();
    currentAyah = null;
    currentSourah = null;
    updateCounts();
    renderAyahs();
    saveProgress();
  }

  function renderAyahs() {
    ayahsContainer.innerHTML = "";
    for (const num of ayahs) {
      if (traitedMap.has(num) && !showTreated) continue;
      let div = document.createElement("div");
      div.textContent = num;
      div.classList.add("num");
      if (traitedMap.get(num) === true) div.classList.add("traited", "correct");
      else if (traitedMap.get(num) === false) div.classList.add("traited", "incorrect");
      else div.onclick = () => showAyah(num);
      ayahsContainer.appendChild(div);
    }
    updateCounts();
  }

  function updateCounts() {
    correctCountValue = [...traitedMap.values()].filter((v) => v === true).length;
    incorrectCountValue = [...traitedMap.values()].filter((v) => v === false).length;
    countCorrect.textContent = correctCountValue;
    countIncorrect.textContent = incorrectCountValue;
    countRemaining.textContent = ayahs.length - traitedMap.size;
    countTotal.textContent = ayahs.length;
  }

  function showAyah(num) {
    if (!num) return;
    currentAyah = num;
    currentSourah = sourahEl.value;
    ayatBox.style.display = "block";
    const lang = languageEl.value;
    const key = `${currentSourah}:${currentAyah}:${lang}`;
    if (verseCache.has(key)) {
      verseText.innerHTML = verseCache.get(key);
      updateHeader();
      return;
    }
    verseText.textContent = "Chargement...";
    fetch(`https://api.alquran.cloud/v1/ayah/${currentSourah}:${currentAyah}/ar.alafasy`)
      .then((res) => res.json())
      .then((data) => {
        if (data.code === 200 && data.data && data.data.text) {
          let txt = data.data.text;
          const bismillah = "بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ";
          if (currentAyah === 1 && txt.startsWith(bismillah)) {
            txt = txt.slice(bismillah.length).trim();
          }
          let colored = colorVerseText(txt);
          verseText.innerHTML = `<div>${colored}</div>`;
          verseCache.set(key, verseText.innerHTML);
          updateHeader();
        } else {
          verseText.textContent = "Erreur lors du chargement du verset.";
        }
      })
      .catch(() => {
        verseText.textContent = "Erreur lors du chargement du verset.";
      });
    if (!startTime) startTimer();
    saveProgress();
  }

  function updateHeader() {
    if (currentSourah && currentAyah) {
      const t = texts[languageEl.value];
      verseHeader.innerHTML = `${t.surahPrefix} ${currentSourah}, ${t.ayahPrefix} ${currentAyah}`;
    } else {
      verseHeader.textContent = "";
    }
  }

  // Correction fiable du premier mot rouge, sans affecter le symbole ۞
  function colorVerseText(text) {
    if (!text) return "";
    const specialSigns = ["ۚ", "ۗ", "ۖ", "ۘ", "ۛ"];
    const normalSigns = ["۞", "۩"];

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, (m) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&apos;',
      }[m]));
    }

    // Echapper html
    let escaped = escapeHtml(text);

    // Extraire et retirer les symboles ۞ en début, en les plaçant en premier
    let symbolYellowSpan = '';
    const symbolReg = new RegExp(escapeHtml("۞"), 'g');
    const hasSymbol = symbolReg.test(escaped);
    if (hasSymbol) {
      symbolYellowSpan = '<span class="special-yellow">۞</span> ';
      escaped = escaped.replace(symbolReg, '');
    }

    // Colorer les autres signes spéciaux en rouge
    for (const s of specialSigns) {
      const esc = escapeHtml(s);
      escaped = escaped.replace(new RegExp(esc, 'gu'), `<span class="special-red">${esc}</span>`);
    }

    // Colorer le reste des signes normaux (sauf ۞) en bleu
    for (const s of normalSigns) {
      if (s === "۞") continue;
      const esc = escapeHtml(s);
      escaped = escaped.replace(new RegExp(esc, 'gu'), `<span class="special-blue">${esc}</span>`);
    }

    // Construire DOM pour nettoyage
    const tmpDiv = document.createElement('div');
    tmpDiv.innerHTML = escaped;
    // Retirer balises spéciales pour obtenir texte propre
    for (const sp of tmpDiv.querySelectorAll('span.special-red, span.special-yellow, span.special-blue')) {
      sp.replaceWith(document.createTextNode(sp.textContent));
    }
    const cleanText = tmpDiv.textContent.trim();
    if (!cleanText) return symbolYellowSpan + escaped;

    // Diviser en mots
    const plainWords = cleanText.split(/\s+/);
    const tokens = escaped.split(/(\s+)/);

    let firstIdx = -1;
    let lastIdx = -1;
    let wordCounter = 0;
    for (let i = 0; i < tokens.length; i++) {
      const plainToken = tokens[i].replace(/<[^>]+>/g, '').trim();
      if (plainToken === '') continue;
      if (wordCounter >= plainWords.length) break;
      if (tokens[i].includes(plainWords[wordCounter])) {
        if (firstIdx === -1) firstIdx = i;
        lastIdx = i;
        wordCounter++;
      }
    }

    // Appliquer rouge au premier mot, vert au dernier
    if (firstIdx !== -1) {
      tokens[firstIdx] = `<span style="color:red;font-weight:700;">${tokens[firstIdx]}</span>`;
    }
    if (lastIdx !== -1 && lastIdx !== firstIdx) {
      tokens[lastIdx] = `<span style="color:green;font-weight:700;">${tokens[lastIdx]}</span>`;
    }

    return symbolYellowSpan + tokens.join('');
  }

  function registerAnswer(correct) {
    if (currentAyah == null) return;
    if (!traitedMap.has(currentAyah)) {
      traitedMap.set(currentAyah, correct);
      if (correct) correctCountValue++;
      else incorrectCountValue++;
      updateCounts();
      renderAyahs();
      ayatBox.style.display = "none";
      currentAyah = null;
      currentSourah = null;
      updateHeader();
      if (traitedMap.size === ayahs.length) stopTimer();
      saveProgress();
    }
  }
  function toggleTreated() {
    showTreated = !showTreated;
    renderAyahs();
  }
  function sortAyahs() {
    ayahs.sort((a, b) => a - b);
    renderAyahs();
  }
  function saveProgress() {
    const data = {
      sourah: sourahEl.value,
      start: startEl.value,
      end: endEl.value,
      ayahs,
      treated: Array.from(traitedMap.entries()),
      correct: correctCountValue,
      incorrect: incorrectCountValue,
      startTime,
      elapsedTime,
      endTime,
    };
    localStorage.setItem("quizProgress", JSON.stringify(data));
  }
  function loadProgress() {
    const str = localStorage.getItem("quizProgress");
    if (!str) return false;
    try {
      const data = JSON.parse(str);
      sourahEl.value = data.sourah || sourahEl.value;
      startEl.value = data.start || startEl.value;
      endEl.value = data.end || endEl.value;
      ayahs = Array.isArray(data.ayahs) ? data.ayahs : [];
      traitedMap = new Map(data.treated || []);
      correctCountValue = data.correct || 0;
      incorrectCountValue = data.incorrect || 0;
      startTime = data.startTime || null;
      elapsedTime = data.elapsedTime || 0;
      endTime = data.endTime || null;
      updateLimits(false);
      renderAyahs();
      updateCounts();
      if (startTime) {
        lastUpdateTime = Date.now();
        timerInterval = setInterval(() => updateElapsedTime(), 500);
      }
      if (endTime) {
        endTimeBox.style.display = "block";
        document.getElementById("end-time-display").textContent = new Date(endTime).toLocaleString();
        endTimerDisplay.textContent = new Date(endTime).toLocaleString();
      }
      updateHeader();
      setTexts(languageEl.value);
      return true;
    } catch {
      return false;
    }
  }
  function clearProgress() {
    localStorage.removeItem("quizProgress");
    ayahs = [];
    traitedMap.clear();
    correctCountValue = 0;
    incorrectCountValue = 0;
    startTime = null;
    elapsedTime = 0;
    endTime = null;
    clearInterval(timerInterval);
    timerInterval = null;
    currentAyah = null;
    currentSourah = null;
    ayatBox.style.display = "none";
    updateCounts();
    renderAyahs();
    updateHeader();
    startTimerDisplay.textContent = "--:--:--";
    elapsedTimerDisplay.textContent = "00:00:00";
    endTimerDisplay.textContent = "--:--:--";
    endTimeBox.style.display = "none";
  }
  function updateElapsedTime() {
    if (!startTime) return;
    const now = Date.now();
    elapsedTime += now - lastUpdateTime;
    lastUpdateTime = now;
    elapsedTimerDisplay.textContent = formatTime(elapsedTime);
  }
  function formatTime(ms) {
    ms = Math.max(0, ms);
    const sec = Math.floor(ms / 1000);
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    return `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
  }
  function startTimer() {
    if (startTime) return;
    startTime = Date.now();
    lastUpdateTime = startTime;
    elapsedTime = 0;
    timerInterval = setInterval(() => updateElapsedTime(), 500);
    startTimerDisplay.textContent = new Date(startTime).toLocaleString();
    endTimeBox.style.display = "none";
    endTimerDisplay.textContent = "--:--:--";
  }
  function stopTimer() {
    if (!startTime || endTime) return;
    clearInterval(timerInterval);
    timerInterval = null;
    endTime = Date.now();
    endTimeBox.style.display = "block";
    document.getElementById("end-time-display").textContent = new Date(endTime).toLocaleString();
    endTimerDisplay.textContent = new Date(endTime).toLocaleString();
  }

  languageEl.addEventListener("change", () => {
    setTexts(languageEl.value);
    saveProgress();
  });
  sourahEl.addEventListener("change", () => {
    updateLimits(true);
    shuffleAyahs();
  });
  startEl.addEventListener("input", () => {
    if (validateRange()) shuffleAyahs();
  });
  endEl.addEventListener("input", () => {
    if (validateRange()) shuffleAyahs();
  });
  btnRedistribuer.addEventListener("click", shuffleAyahs);
  btnTrier.addEventListener("click", sortAyahs);
  btnToggle.addEventListener("click", () => {
    showTreated = !showTreated;
    renderAyahs();
  });
  btnCorrect.addEventListener("click", () => registerAnswer(true));
  btnIncorrect.addEventListener("click", () => registerAnswer(false));

  document.addEventListener("DOMContentLoaded", () => {
    setTexts(languageEl.value);
    populateSourahOptions();
    if (!loadProgress()) {
      sourahEl.value = 1;
      updateLimits(true);
      shuffleAyahs();
    }
  });
})();
</script>
</body>
</html>
